<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DP Helm HQ</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=IBM+Plex+Mono:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0a0a0a;--s1:#111;--s2:#181818;--s3:#202020;
  --border:#2c2c2c;--border2:#383838;
  --gold:#c9a84c;--gold2:#8a6f2e;
  --amber:#e07830;--blue:#4a8fa8;--purple:#8a6ab8;
  --green:#4caf7a;--red:#c0443a;
  --text:#e5e0d8;--text2:#a09890;--text3:#605850;
  --font-d:'Playfair Display',Georgia,serif;
  --font-m:'IBM Plex Mono',monospace;
}
body{background:var(--bg);color:var(--text);font-family:var(--font-m);font-size:12px;line-height:1.6}
.app{display:grid;grid-template-columns:230px 1fr;grid-template-rows:48px 1fr 165px;height:100vh;overflow:hidden}

.topbar{grid-column:1/-1;background:var(--s1);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 20px;gap:14px}
.topbar-logo{font-family:var(--font-d);font-size:16px;color:var(--gold);letter-spacing:1px}
.topbar-project{color:var(--text2);font-size:11px;letter-spacing:2px;text-transform:uppercase}
.topbar-sep{color:var(--border2)}
.topbar-right{margin-left:auto;display:flex;gap:8px;align-items:center}
.badge{font-size:10px;letter-spacing:1px;text-transform:uppercase;padding:3px 8px;border:1px solid var(--border2);color:var(--text3)}
.badge.warn{border-color:var(--amber);color:var(--amber)}
.badge.ok{border-color:var(--green);color:var(--green)}
.badge.live{border-color:var(--blue);color:var(--blue);animation:pulse 2s infinite}
.badge.btn{cursor:pointer;transition:background .2s}.badge.btn:hover{background:var(--s2)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}

.sidebar{background:var(--s1);border-right:1px solid var(--border);overflow-y:auto;padding:10px 0;grid-row:2/3}
.nav-label{font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--text3);padding:0 16px;margin:14px 0 5px}
.nav-item{display:flex;align-items:center;gap:10px;padding:7px 16px;cursor:pointer;color:var(--text2);transition:background .15s,color .15s;font-size:11px}
.nav-item:hover{background:var(--s2);color:var(--text)}
.nav-item.active{background:var(--s2);color:var(--gold);border-left:2px solid var(--gold)}
.nav-icon{width:16px;text-align:center;flex-shrink:0}
.project-stat{padding:5px 16px}
.project-stat-label{font-size:10px;color:var(--text3);letter-spacing:1px;text-transform:uppercase}
.project-stat-val{font-size:17px;font-family:var(--font-d);color:var(--gold)}

.main{overflow-y:auto;background:var(--bg);grid-row:2/3}
.panel{display:none;padding:26px 30px 50px}
.panel.active{display:block}
.panel-title{font-family:var(--font-d);font-size:24px;font-weight:400;font-style:italic;margin-bottom:4px}
.panel-sub{color:var(--text3);font-size:11px;margin-bottom:22px;letter-spacing:1px}
.section-title{font-size:10px;letter-spacing:2.5px;text-transform:uppercase;color:var(--text3);margin:26px 0 12px}
.section-title:first-child{margin-top:0}

.grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
.card{background:var(--s1);border:1px solid var(--border);padding:16px 18px}
.card-title{font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--text3);margin-bottom:8px}
.card-val{font-family:var(--font-d);font-size:22px;color:var(--gold)}
.card-sub{font-size:11px;color:var(--text2);margin-top:4px}

/* SLUG FORMAT */
.slug{font-size:11px;letter-spacing:2px;text-transform:uppercase;color:var(--gold);font-weight:600;margin-bottom:6px}

/* TIMELINE */
.timeline-wrap{overflow-x:auto;padding-bottom:8px}
.timeline{display:flex;gap:0;min-width:900px}
.tl-day{flex:1;border:1px solid var(--border);margin-right:-1px;min-width:100px;background:var(--s1);transition:background .2s}
.tl-day:hover{background:var(--s2);z-index:1;position:relative}
.tl-day.today{border-color:var(--blue);z-index:2;position:relative}
.tl-day.shoot{border-color:var(--gold);background:#1a1200;z-index:2;position:relative}
.tl-day.scout{border-color:var(--purple);z-index:2;position:relative}
.tl-day-header{padding:8px 10px;border-bottom:1px solid var(--border)}
.tl-date{font-size:10px;color:var(--text3);letter-spacing:1px}
.tl-label{font-size:11px;color:var(--text);font-weight:500;margin-top:2px}
.tl-day.today .tl-label{color:var(--blue)}
.tl-day.shoot .tl-label{color:var(--gold)}
.tl-day.scout .tl-label{color:var(--purple)}
.tl-items{padding:8px 10px;display:flex;flex-direction:column;gap:5px;min-height:120px}
.tl-item{font-size:10px;color:var(--text2);padding:3px 6px;border-left:2px solid var(--border2);line-height:1.4}
.tl-item.urgent{border-left-color:var(--red);color:var(--amber)}
.tl-item.done-item{border-left-color:var(--green);color:var(--text3);text-decoration:line-through;cursor:pointer}
.tl-item.action{border-left-color:var(--gold2);cursor:pointer}
.tl-item.action:hover{background:var(--s3)}

/* CREW CARDS */
.crew-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(185px,1fr));gap:12px}
/* CREW v2 */
.crew-card{background:var(--s1);border:1px solid var(--border);padding:0;transition:border-color .2s;position:relative;cursor:pointer}
.crew-card:hover{border-color:var(--gold2)}
.crew-card.unavailable{opacity:.45;border-style:dashed}
.crew-card.empty{border-style:dashed;opacity:.7}
.crew-card.empty:hover{opacity:1;border-color:var(--gold2)}
.crew-card.editing{border-color:var(--gold);opacity:1}
.crew-card-top{padding:12px 12px 8px 12px}
.crew-card-actions{display:flex;border-top:1px solid var(--border);overflow:hidden}
.crew-card-act-btn{flex:1;background:transparent;border:none;border-right:1px solid var(--border);color:var(--text3);font-family:var(--font-m);font-size:9px;letter-spacing:1px;text-transform:uppercase;padding:6px 4px;cursor:pointer;transition:all .15s;text-align:center}
.crew-card-act-btn:last-child{border-right:none}
.crew-card-act-btn:hover{background:var(--s2);color:var(--gold)}
.crew-card-act-btn.danger:hover{background:var(--s2);color:var(--red)}
.crew-card-act-btn.avail:hover{background:var(--s2);color:var(--green)}
.crew-inline-form{display:none;padding:10px 12px 12px;border-top:1px solid var(--border);background:var(--s2)}
.crew-inline-form.open{display:block}
.crew-inline-row{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:6px}
.crew-inline-row.single{grid-template-columns:1fr}
.crew-inline-input{width:100%;background:var(--s1);border:1px solid var(--border2);color:var(--text);font-family:var(--font-m);font-size:11px;padding:5px 8px}
.crew-inline-label{font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:var(--text3);margin-bottom:2px;display:block}
.crew-inline-save{background:var(--gold2);border:none;color:var(--bg);font-family:var(--font-m);font-size:9px;letter-spacing:1.5px;text-transform:uppercase;padding:5px 14px;cursor:pointer;margin-top:4px}
.crew-inline-save:hover{background:var(--gold)}
.crew-inline-cancel{background:transparent;border:1px solid var(--border2);color:var(--text3);font-family:var(--font-m);font-size:9px;letter-spacing:1.5px;text-transform:uppercase;padding:5px 10px;cursor:pointer;margin-top:4px;margin-left:6px}
.crew-empty-prompt{text-align:center;padding:18px 12px;color:var(--text3);font-size:10px;letter-spacing:.5px}
.crew-empty-prompt .plus{font-size:20px;display:block;margin-bottom:5px;color:var(--gold2)}

.crew-role{font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--text3);margin-bottom:5px}
.crew-name{font-family:var(--font-d);font-size:17px;color:var(--text);font-style:italic;margin-bottom:8px}
.crew-detail{font-size:11px;color:var(--text2);margin-bottom:3px}
.crew-detail a{color:var(--blue);text-decoration:none}.crew-detail a:hover{text-decoration:underline}
.crew-status{display:inline-block;font-size:10px;letter-spacing:1px;text-transform:uppercase;padding:2px 8px;border:1px solid;margin-top:8px;cursor:default}
.crew-status.confirmed{border-color:var(--green);color:var(--green)}
.crew-status.pending{border-color:var(--amber);color:var(--amber)}
.crew-status.needed{border-color:var(--red);color:var(--red)}
.crew-status.unavailable-tag{border-color:var(--text3);color:var(--text3)}
.crew-unavail-btn{position:absolute;top:10px;right:10px;font-size:9px;letter-spacing:1px;text-transform:uppercase;padding:2px 7px;border:1px solid var(--border2);color:var(--text3);cursor:pointer;background:transparent;font-family:var(--font-m);transition:all .2s}
.crew-unavail-btn:hover{border-color:var(--amber);color:var(--amber)}

/* CHECKLIST */
.checklist-key{display:flex;gap:16px;margin-bottom:16px;padding:10px 14px;background:var(--s1);border:1px solid var(--border);font-size:10px;flex-wrap:wrap}
.key-item{display:flex;align-items:center;gap:6px;color:var(--text3)}
.rag{width:10px;height:10px;border-radius:50%;flex-shrink:0}
.rag.green{background:var(--green)}.rag.yellow{background:var(--amber)}.rag.red{background:var(--red);box-shadow:0 0 5px var(--red)}.rag.grey{background:var(--border2)}
.checklist{display:flex;flex-direction:column}
.check-group{border:1px solid var(--border);margin-bottom:-1px;background:var(--s1)}
.check-group-header{display:flex;align-items:center;gap:12px;padding:11px 15px;cursor:pointer}
.check-group-header:hover{background:var(--s2)}
.check-group-title{flex:1;font-size:12px;color:var(--text)}
.check-group-meta{font-size:10px;color:var(--text3);letter-spacing:1px}
.check-chevron{color:var(--text3);transition:transform .2s}
.check-group.open .check-chevron{transform:rotate(90deg)}
.check-items{display:none;border-top:1px solid var(--border)}
.check-group.open .check-items{display:block}
.check-item{display:flex;align-items:flex-start;gap:10px;padding:9px 15px 9px 37px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .15s}
.check-item:last-child{border-bottom:none}
.check-item:hover{background:var(--s2)}
.check-box{width:14px;height:14px;border:1px solid var(--border2);flex-shrink:0;margin-top:1px;display:flex;align-items:center;justify-content:center;font-size:10px;color:var(--green);transition:all .2s}
.check-item.done .check-box{background:var(--green);border-color:var(--green);color:var(--bg)}
.check-item.done .check-text{text-decoration:line-through;color:var(--text3)}
.check-text{font-size:11px;color:var(--text2);flex:1}
.check-note{font-size:10px;color:var(--text3);margin-top:2px}

/* SHOT TABLE */
.shot-table{width:100%;border-collapse:collapse;margin-top:10px}
.shot-table th{font-size:10px;letter-spacing:1.5px;text-transform:uppercase;color:var(--text3);text-align:left;padding:6px 10px;border-bottom:1px solid var(--border)}
.shot-table td{padding:8px 10px;border-bottom:1px solid var(--border);font-size:11px;color:var(--text2);vertical-align:top}
.shot-table tr:last-child td{border-bottom:none}
.shot-table tr:hover td{background:var(--s2)}
.shot-id{color:var(--gold);font-weight:600;white-space:nowrap}

/* GEAR TABLE */
.gear-table{width:100%;border-collapse:collapse}
.gear-table th{font-size:10px;letter-spacing:1.5px;text-transform:uppercase;color:var(--text3);text-align:left;padding:8px 12px;border-bottom:1px solid var(--border);background:var(--s2)}
.gear-table td{padding:9px 12px;border-bottom:1px solid var(--border);font-size:11px;color:var(--text2)}
.gear-table tr:hover td{background:var(--s2)}
.owned{color:var(--green)}.rental{color:var(--amber)}.tbd{color:var(--text3)}.ontruck{color:var(--blue)}

/* TAGS */
.tag{font-size:10px;letter-spacing:1px;text-transform:uppercase;padding:2px 7px;border:1px solid var(--border2);color:var(--text3)}
.tag.ext{border-color:#4a6a3a;color:#7ab86a}.tag.int{border-color:#3a4a6a;color:#6a8ab8}
.tag.gold{border-color:var(--gold2);color:var(--gold)}.tag.warn{border-color:var(--amber);color:var(--amber)}
.tag.ok{border-color:#3a6a4a;color:var(--green)}.tag.purple{border-color:#6a4a8a;color:var(--purple)}

/* VL */
.vl-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.vl-card{background:var(--s1);border:1px solid var(--border);padding:16px}
.vl-label{font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--text3);margin-bottom:7px}
.vl-value{font-family:var(--font-d);font-size:19px;color:var(--gold);outline:none;border-bottom:1px solid var(--border2);width:100%;background:transparent;display:block}
.vl-note{font-size:11px;color:var(--text2);margin-top:7px;line-height:1.7;outline:none;min-height:36px;width:100%;background:transparent;display:block}
.vl-tab-bar{display:flex;margin-bottom:16px;border:1px solid var(--border)}
.vl-tab{flex:1;padding:9px 16px;cursor:pointer;text-align:center;font-size:11px;letter-spacing:1px;text-transform:uppercase;color:var(--text3);transition:all .2s;border-right:1px solid var(--border)}
.vl-tab:last-child{border-right:none}
.vl-tab.active{background:var(--s2);color:var(--gold)}
.vl-panel{display:none}.vl-panel.active{display:block}

/* INBOX / SCOUT */
.inbox-drop{border:1px dashed var(--border2);padding:24px;text-align:center;color:var(--text3);font-size:11px;cursor:pointer;transition:all .2s;margin-bottom:12px}
.inbox-drop:hover,.inbox-drop.drag-over{border-color:var(--gold2);color:var(--gold);background:var(--s2)}
.inbox-drop input{display:none}
.inbox-item{background:var(--s1);border:1px solid var(--border);padding:11px 13px;margin-bottom:7px;display:flex;gap:12px;align-items:flex-start}
.inbox-item-icon{font-size:18px;flex-shrink:0}
.inbox-item-info{flex:1}
.inbox-item-name{font-size:11px;color:var(--text);margin-bottom:3px}
.inbox-item-status{font-size:10px;color:var(--text3);letter-spacing:1px}
.inbox-item-status.analyzing{color:var(--blue);animation:pulse 1s infinite}
.inbox-item-status.done{color:var(--green)}
.inbox-analysis{background:var(--s2);border-left:2px solid var(--blue);padding:9px 12px;font-size:11px;color:var(--text2);line-height:1.7;margin-top:7px}
.inbox-analysis strong{color:var(--blue)}

/* DECISION LOG */
.decision-log{display:flex;flex-direction:column;gap:7px}
.decision-entry{background:var(--s1);border:1px solid var(--border);border-left:2px solid var(--gold2);padding:11px 14px}
.decision-ts{font-size:10px;color:var(--text3);letter-spacing:1px;margin-bottom:3px}
.decision-text{font-size:11px;color:var(--text2);line-height:1.6}
.decision-section{font-size:10px;letter-spacing:1.5px;text-transform:uppercase;color:var(--gold);margin-bottom:3px}

/* CASCADE */
.cascade{display:flex;flex-direction:column}
.cascade-row{display:flex;align-items:stretch;border:1px solid var(--border);margin-bottom:-1px;background:var(--s1)}
.cascade-row:hover{background:var(--s2);position:relative;z-index:1}
.cascade-label{width:155px;flex-shrink:0;padding:10px 13px;font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--text3);border-right:1px solid var(--border);display:flex;align-items:center}
.cascade-val{flex:1;padding:10px 13px;font-size:11px;color:var(--text);display:flex;align-items:center;flex-wrap:wrap;gap:6px}
.cascade-arrow{width:24px;flex-shrink:0;display:flex;align-items:center;justify-content:center;color:var(--gold2)}

/* BOXES */
.impact-box{background:#1a1200;border:1px solid var(--gold2);padding:12px 15px;margin-top:12px;font-size:11px;color:var(--text2);line-height:1.8}
.impact-box strong{color:var(--gold)}
.note-block{background:var(--s2);border-left:2px solid var(--gold2);padding:11px 14px;font-size:11px;color:var(--text2);line-height:1.8;margin-top:10px}
.note-block strong{color:var(--gold)}

/* FORMS */
input,select,textarea{background:var(--s2);border:1px solid var(--border);color:var(--text);font-family:var(--font-m);font-size:12px;padding:7px 11px;outline:none;width:100%}
input:focus,select:focus,textarea:focus{border-color:var(--gold2)}
label{font-size:10px;letter-spacing:1.5px;text-transform:uppercase;color:var(--text3);display:block;margin-bottom:4px;margin-top:12px}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.form-row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
.btn{background:transparent;border:1px solid var(--gold2);color:var(--gold);font-family:var(--font-m);font-size:11px;letter-spacing:1.5px;text-transform:uppercase;padding:8px 15px;cursor:pointer;transition:background .2s}
.btn:hover{background:var(--gold2)}.btn.primary{background:var(--gold2)}.btn.sm{padding:4px 9px;font-size:10px}

/* COMMAND BAR */
.command-bar{grid-column:1/-1;grid-row:3/4;background:#0e0e0e;border-top:1px solid var(--border2);display:flex;flex-direction:column}
.command-bar-top{display:flex;align-items:center;gap:12px;padding:10px 18px;border-bottom:1px solid var(--border);flex-shrink:0}
.command-label{font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--blue);flex-shrink:0}
.command-input{flex:1;background:var(--s2);border:1px solid var(--border2);color:var(--text);font-family:var(--font-m);font-size:12px;padding:8px 13px;outline:none}
.command-input:focus{border-color:var(--blue)}
.command-input::placeholder{color:var(--text3)}
.cmd-btn{background:transparent;border:1px solid var(--blue);color:var(--blue);font-family:var(--font-m);font-size:10px;letter-spacing:1.5px;text-transform:uppercase;padding:8px 14px;cursor:pointer;flex-shrink:0;transition:background .2s}
.cmd-btn:hover{background:#1a2a34}.cmd-btn:disabled{opacity:.4;cursor:not-allowed}
.command-preview{flex:1;overflow-y:auto;padding:7px 18px;display:flex;flex-direction:column;gap:5px}
.preview-empty{color:var(--text3);font-size:11px;padding:5px 0;font-style:italic}
.change-item{display:flex;align-items:flex-start;gap:10px;background:var(--s2);border:1px solid var(--border);padding:7px 11px;animation:slideIn .2s ease}
@keyframes slideIn{from{opacity:0;transform:translateX(-8px)}to{opacity:1;transform:translateX(0)}}
.change-item.approved{border-color:var(--green);opacity:.5}.change-item.cancelled{border-color:var(--red);opacity:.3;text-decoration:line-through}
.change-type{font-size:9px;letter-spacing:1.5px;text-transform:uppercase;padding:2px 6px;border:1px solid;flex-shrink:0;margin-top:1px}
.change-type.update{color:var(--gold);border-color:var(--gold2)}.change-type.add{color:var(--green);border-color:#3a6a4a}.change-type.flag{color:var(--amber);border-color:#6a4020}
.change-desc{flex:1;font-size:11px;color:var(--text2);line-height:1.5}
.change-actions{display:flex;gap:5px;flex-shrink:0}
.change-btn{background:transparent;border:1px solid var(--border2);color:var(--text3);font-family:var(--font-m);font-size:10px;padding:3px 7px;cursor:pointer;transition:all .15s;letter-spacing:1px;text-transform:uppercase}
.change-btn.approve:hover{border-color:var(--green);color:var(--green);background:#0d1f14}
.change-btn.cancel:hover{border-color:var(--red);color:var(--red);background:#1f0d0d}
.change-btn.edit:hover{border-color:var(--gold2);color:var(--gold);background:#1a1200}
.commit-row{display:flex;gap:8px;padding:7px 18px;border-top:1px solid var(--border);background:#0e0e0e;flex-shrink:0;align-items:center}
.commit-btn{background:var(--gold2);border:1px solid var(--gold2);color:var(--gold);font-family:var(--font-m);font-size:10px;letter-spacing:2px;text-transform:uppercase;padding:7px 16px;cursor:pointer;transition:background .2s}
.commit-btn:hover{background:var(--gold);color:var(--bg)}
.clear-btn{background:transparent;border:1px solid var(--border2);color:var(--text3);font-family:var(--font-m);font-size:10px;letter-spacing:2px;text-transform:uppercase;padding:7px 12px;cursor:pointer}
.clear-btn:hover{border-color:var(--red);color:var(--red)}
.thinking{color:var(--blue);font-size:11px;animation:pulse 1s infinite;padding:5px 0}
.cmd-hint{font-size:10px;color:var(--text3);margin-left:auto;letter-spacing:.5px}

/* VENDOR */
.vendor-card{background:var(--s1);border:1px solid var(--border);padding:18px;margin-bottom:12px}
.vendor-name{font-family:var(--font-d);font-size:19px;font-style:italic;color:var(--text);margin-bottom:12px}

/* SCENE EXPAND */
.scene-card{background:var(--s1);border:1px solid var(--border);margin-bottom:10px;cursor:pointer;transition:border-color .2s}
.scene-card:hover{border-color:var(--gold2)}.scene-card.expanded{border-color:var(--gold2)}
.scene-header{display:flex;align-items:center;gap:14px;padding:13px 16px}
.scene-num{font-family:var(--font-d);font-size:28px;color:var(--border2);line-height:1;flex-shrink:0;width:36px}
.scene-info{flex:1}
.scene-name{font-size:13px;color:var(--text);font-weight:500}
.scene-meta{font-size:11px;color:var(--text3);margin-top:2px}
.scene-tags{display:flex;gap:6px;flex-wrap:wrap;margin-top:7px}
.scene-chevron{color:var(--text3);transition:transform .2s;font-size:16px}
.scene-card.expanded .scene-chevron{transform:rotate(90deg)}
.scene-body{display:none;border-top:1px solid var(--border);padding:16px}
.scene-card.expanded .scene-body{display:block}

/* MODAL */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:1000;align-items:center;justify-content:center}
.modal-overlay.show{display:flex}
.modal{background:var(--s1);border:1px solid var(--border2);padding:24px;max-width:360px;width:90%}
.modal-title{font-family:var(--font-d);font-size:18px;font-style:italic;margin-bottom:12px;color:var(--text)}
.modal-text{font-size:12px;color:var(--text2);line-height:1.7;margin-bottom:18px}
.modal-btns{display:flex;gap:10px}

/* SCOUT INTELLIGENCE */
.scout-toolbar{display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap;align-items:center}
.scout-filter-btn{background:transparent;border:1px solid var(--border2);color:var(--text3);font-family:var(--font-m);font-size:10px;letter-spacing:1px;text-transform:uppercase;padding:4px 10px;cursor:pointer;transition:all .15s}
.scout-filter-btn:hover,.scout-filter-btn.active{border-color:var(--gold2);color:var(--gold);background:var(--s2)}
.scout-grid-wrap{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
.scout-card{background:var(--s1);border:1px solid var(--border);overflow:hidden;position:relative;transition:border-color .2s}
.scout-card:hover{border-color:var(--gold2)}
.scout-card.duplicate{border-color:var(--amber);border-style:dashed}
.scout-card.scene-performance{border-left:3px solid var(--gold)}
.scout-card.scene-genesis{border-left:3px solid var(--purple)}
.scout-card.scene-unknown{border-left:3px solid var(--border2)}
.scout-card-img{width:100%;height:140px;object-fit:cover;display:block;cursor:pointer}
.scout-card-body{padding:9px 10px}
.scout-scene-tag{display:inline-block;font-size:9px;letter-spacing:1.5px;text-transform:uppercase;padding:2px 7px;border:1px solid;margin-bottom:6px}
.scout-scene-tag.performance{border-color:var(--gold2);color:var(--gold)}
.scout-scene-tag.genesis{border-color:#6a4a8a;color:var(--purple)}
.scout-scene-tag.unknown{border-color:var(--border2);color:var(--text3)}
.scout-meta-row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:6px}
.scout-meta-chip{font-size:9px;color:var(--text3);background:var(--s2);padding:2px 6px;letter-spacing:.5px}
.scout-analysis-text{font-size:10px;color:var(--text2);line-height:1.6;margin-top:5px;max-height:80px;overflow:hidden;position:relative}
.scout-analysis-text.expanded{max-height:none}
.scout-expand-btn{font-size:9px;color:var(--blue);cursor:pointer;margin-top:3px;letter-spacing:.5px}
.scout-card-actions{display:flex;gap:5px;padding:7px 10px;border-top:1px solid var(--border)}
.scout-action-btn{background:transparent;border:1px solid var(--border2);color:var(--text3);font-family:var(--font-m);font-size:9px;letter-spacing:1px;text-transform:uppercase;padding:3px 8px;cursor:pointer;transition:all .15s;flex:1;text-align:center}
.scout-action-btn:hover{border-color:var(--gold2);color:var(--gold)}
.scout-action-btn.danger:hover{border-color:var(--red);color:var(--red)}
.scene-tag-select{background:var(--s2);border:1px solid var(--border2);color:var(--text);font-family:var(--font-m);font-size:9px;padding:2px 5px;cursor:pointer;letter-spacing:.5px}

/* OVERHEAD */
.overhead-section{margin-top:24px;border-top:1px solid var(--border);padding-top:16px}
.overhead-controls{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;align-items:center}
.overhead-svg-wrap{background:var(--s1);border:1px solid var(--border);padding:16px;overflow:auto;min-height:200px;position:relative}
.overhead-svg-wrap svg{display:block;margin:auto}
.overhead-status{font-size:11px;color:var(--text3);font-style:italic;margin-top:8px}
.correction-box{background:var(--s2);border:1px solid var(--border2);padding:12px;margin-top:10px}
.correction-box textarea{width:100%;min-height:60px;background:var(--s1);border:1px solid var(--border2);color:var(--text);font-family:var(--font-m);font-size:11px;padding:8px;resize:vertical}

/* SETTINGS PANEL */
.api-key-row{display:flex;gap:8px;align-items:center;margin-bottom:10px}
.api-key-input{flex:1;font-family:var(--font-m);font-size:11px;padding:7px 11px;background:var(--s2);border:1px solid var(--border);color:var(--text)}
.api-key-label{font-size:10px;letter-spacing:1.5px;text-transform:uppercase;color:var(--text3);width:80px;flex-shrink:0}

/* LIGHTBOX */
.lightbox{display:none;position:fixed;inset:0;background:rgba(0,0,0,.92);z-index:2000;align-items:center;justify-content:center;cursor:pointer}
.lightbox.show{display:flex}
.lightbox img{max-width:90vw;max-height:90vh;object-fit:contain}


/* CREW v3 ‚Äî ROLE ROWS */
.crew-dept-section{margin-bottom:20px}
.crew-role-row{margin-bottom:14px}
.crew-role-label{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--text3);margin-bottom:6px;padding-left:2px}
.crew-role-strip{display:flex;gap:8px;overflow-x:auto;padding-bottom:4px;scrollbar-width:thin;scrollbar-color:var(--border2) transparent}
.crew-role-strip::-webkit-scrollbar{height:3px}
.crew-role-strip::-webkit-scrollbar-track{background:transparent}
.crew-role-strip::-webkit-scrollbar-thumb{background:var(--border2)}

/* Crew cards v3 */
.crew-card-v3{flex-shrink:0;width:140px;background:var(--s1);border:1px solid var(--border);padding:10px;position:relative;transition:border-color .15s}
.crew-card-v3.is-hired{border-color:var(--green);border-width:2px;background:rgba(80,180,100,.06)}
.crew-card-v3.is-available{border-color:var(--gold2);border-width:2px;background:rgba(201,168,76,.06)}
.crew-card-v3.is-unavailable{border-color:var(--red);border-width:1px;opacity:.55;background:rgba(180,60,60,.05)}
.crew-card-v3.is-unknown{border-color:var(--border2);border-width:1px;opacity:.6}
.crew-card-v3.is-open{border-style:dashed;opacity:.55;cursor:pointer;border-color:var(--border2)}
.crew-card-v3.is-open:hover{opacity:1;border-color:var(--gold2)}
.crew-card-v3-name{font-size:11px;font-weight:500;color:var(--text);line-height:1.3;margin-bottom:3px;cursor:pointer;border-bottom:1px solid transparent;transition:border-color .15s}
.crew-card-v3-name:hover{border-bottom-color:var(--gold2);color:var(--gold)}
.crew-card-v3-role{font-size:9px;letter-spacing:.5px;color:var(--text3);margin-bottom:6px}
.crew-state-btn{width:100%;background:transparent;border:1px solid var(--border2);color:var(--text3);font-family:var(--font-m);font-size:8px;letter-spacing:1.5px;text-transform:uppercase;padding:4px 0;cursor:pointer;transition:all .15s;margin-top:2px}
.crew-state-btn.hired{border-color:var(--green);color:var(--green);background:rgba(80,180,100,.1)}
.crew-state-btn.available{border-color:var(--gold2);color:var(--gold)}
.crew-state-btn.unavailable{border-color:var(--red);color:var(--red);opacity:.8}
.crew-state-btn.unknown{border-color:var(--border2);color:var(--text3)}
.crew-state-btn:hover{border-color:var(--gold2);color:var(--gold)}
.crew-open-card{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:80px;gap:4px}
.crew-open-plus{font-size:18px;color:var(--gold2);line-height:1}
.crew-open-label{font-size:9px;color:var(--text3);letter-spacing:.5px;text-align:center}

/* CONTACT CARD OVERLAY */
.contact-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:3000;align-items:center;justify-content:center;padding:20px}
.contact-overlay.show{display:flex}
.contact-card{background:var(--s1);border:1px solid var(--border);width:100%;max-width:480px;max-height:90vh;overflow-y:auto}
.contact-card-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.contact-card-title{font-size:16px;color:var(--text);letter-spacing:.5px}
.contact-card-close{background:transparent;border:none;color:var(--text3);font-size:20px;cursor:pointer;padding:0;line-height:1}
.contact-card-body{padding:20px}
.contact-field{margin-bottom:14px}
.contact-field label{display:block;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--text3);margin-bottom:4px}
.contact-field input,.contact-field textarea,.contact-field select{width:100%;background:var(--s2);border:1px solid var(--border2);color:var(--text);font-family:var(--font-m);font-size:12px;padding:8px 10px}
.contact-field textarea{min-height:70px;resize:vertical}
.contact-actions{display:flex;gap:8px;padding:0 20px 20px;flex-wrap:wrap}
.contact-act-btn{background:transparent;border:1px solid var(--border2);color:var(--text2);font-family:var(--font-m);font-size:10px;letter-spacing:1px;text-transform:uppercase;padding:7px 14px;cursor:pointer;transition:all .15s;display:flex;align-items:center;gap:5px}
.contact-act-btn:hover{border-color:var(--gold2);color:var(--gold)}
.contact-act-btn.primary{background:var(--gold2);border-color:var(--gold2);color:var(--bg)}
.contact-act-btn.primary:hover{background:var(--gold)}
.contact-act-btn.danger{border-color:transparent;color:var(--text3)}
.contact-act-btn.danger:hover{border-color:var(--red);color:var(--red)}
.contact-state-row{display:flex;gap:6px;margin-bottom:4px}
.contact-state-opt{flex:1;background:transparent;border:1px solid var(--border2);color:var(--text3);font-family:var(--font-m);font-size:9px;letter-spacing:1px;text-transform:uppercase;padding:6px 4px;cursor:pointer;transition:all .15s;text-align:center}
.contact-state-opt.active.hired{border-color:var(--green);color:var(--green);background:rgba(80,180,100,.1)}
.contact-state-opt.active.available{border-color:var(--gold2);color:var(--gold);background:rgba(201,168,76,.08)}
.contact-state-opt.active.unavailable{border-color:var(--border2);color:var(--text3);background:var(--s2)}


/* VCF DROP ON COMMAND BAR */
.command-bar.drag-over{border-top:2px solid var(--gold);}
.vcf-drop-hint{font-size:9px;color:var(--text3);letter-spacing:.5px;padding:2px 8px;opacity:.6}
.vcf-parsed-toast{background:var(--s2);border:1px solid var(--green);color:var(--green);font-size:10px;padding:6px 12px;margin-top:6px;letter-spacing:.5px}


/* VENDOR v2 */
.vendor-card-v2{background:var(--s1);border:1px solid var(--border);padding:0;margin-bottom:10px;transition:border-color .15s}
.vendor-card-v2:hover{border-color:var(--border2)}
.vendor-card-header{display:flex;align-items:flex-start;justify-content:space-between;padding:14px 14px 8px}
.vendor-name{font-size:13px;color:var(--text);letter-spacing:.3px}
.vendor-edit-btn{background:transparent;border:1px solid var(--border2);color:var(--text3);font-family:var(--font-m);font-size:9px;letter-spacing:1px;text-transform:uppercase;padding:4px 10px;cursor:pointer;flex-shrink:0}
.vendor-edit-btn:hover{border-color:var(--gold2);color:var(--gold)}
.vendor-coi-row{display:flex;align-items:center;padding:0 14px 10px;gap:6px}
.vendor-coi-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.vendor-quotes-row{padding:0 14px 8px;display:flex;flex-wrap:wrap;gap:4px;align-items:center}
.vendor-drop-zone{margin:0 14px 14px;border:1px dashed var(--border2);padding:8px 12px;font-size:9px;letter-spacing:1px;color:var(--text3);display:flex;align-items:center;gap:10px;cursor:default;transition:border-color .15s}
.vendor-drop-zone.drag-over{border-color:var(--gold2);color:var(--gold)}
.vendor-upload-btn{background:transparent;border:1px solid var(--border2);color:var(--text3);font-family:var(--font-m);font-size:9px;letter-spacing:1px;padding:3px 8px;cursor:pointer}
.vendor-upload-btn:hover{border-color:var(--gold2);color:var(--gold)}
.vendor-add-card{border:1px dashed var(--border2);padding:18px;display:flex;flex-direction:column;align-items:center;gap:4px;cursor:pointer;opacity:.6;margin-bottom:10px}
.vendor-add-card:hover{opacity:1;border-color:var(--gold2)}
/* VENDOR OVERLAY */
.vendor-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:3000;align-items:center;justify-content:center;padding:20px}
.vendor-overlay.show{display:flex}


/* PULL SHEET */
.pull-table{width:100%;border-collapse:collapse;font-size:11px}
.pull-table th{font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:var(--text3);padding:5px 8px;text-align:left;border-bottom:1px solid var(--border);font-weight:normal}
.pull-table td{padding:6px 8px;border-bottom:1px solid rgba(255,255,255,.04);vertical-align:middle}
.pull-row:hover{background:var(--s2)}
.pull-cell-editable{cursor:pointer;transition:background .1s}
.pull-cell-editable:hover{background:rgba(201,168,76,.08);outline:1px solid var(--border2)}
.pull-cell-input{background:var(--s3);border:1px solid var(--gold2);color:var(--text);font-family:var(--font-m);font-size:11px;padding:3px 5px;width:100%;outline:none}
.pull-source-select,.pull-priority-select{background:transparent;border:none;color:inherit;font-family:var(--font-m);font-size:10px;cursor:pointer;padding:2px 0;width:100%}
.pull-del-btn{background:transparent;border:none;color:var(--text3);cursor:pointer;font-size:11px;padding:2px 4px;opacity:.4}
.pull-del-btn:hover{color:var(--red);opacity:1}
.pull-add-btn{background:transparent;border:1px dashed var(--border2);color:var(--text3);font-family:var(--font-m);font-size:9px;letter-spacing:1.5px;text-transform:uppercase;padding:7px 16px;cursor:pointer;margin-bottom:16px;transition:all .15s}
.pull-add-btn:hover{border-color:var(--gold2);color:var(--gold)}

/* HIRE TOAST */
.hire-toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:var(--s2);border:1px solid var(--green);color:var(--text);font-family:var(--font-m);font-size:11px;padding:10px 14px;display:flex;align-items:center;gap:10px;z-index:4000;min-width:340px;max-width:500px;box-shadow:0 4px 20px rgba(0,0,0,.4)}
.hire-toast-yes{background:var(--green);border:none;color:var(--bg);font-family:var(--font-m);font-size:9px;letter-spacing:1.5px;text-transform:uppercase;padding:5px 12px;cursor:pointer;flex-shrink:0}
.hire-toast-no{background:transparent;border:1px solid var(--border2);color:var(--text3);font-family:var(--font-m);font-size:9px;letter-spacing:1px;text-transform:uppercase;padding:5px 10px;cursor:pointer;flex-shrink:0}

/* FLAG PULSE */
@keyframes flagPulse{0%{background:rgba(201,168,76,.0)}15%{background:rgba(201,168,76,.3)}85%{background:rgba(201,168,76,.3)}100%{background:rgba(201,168,76,.0)}}
.flag-pulse{animation:flagPulse 2s ease}


/* OVERVIEW CLICKABLE CARDS */
.ov-clickable{cursor:pointer;transition:border-color .15s, background .15s}
.ov-clickable:hover{border-color:var(--gold2);background:rgba(201,168,76,.04)}
.ov-link-hint{font-size:9px;letter-spacing:1px;color:var(--text3);margin-top:8px;text-transform:uppercase}
.ov-clickable:hover .ov-link-hint{color:var(--gold2)}


/* QUOTE CARDS */
.quote-card{width:140px;flex-shrink:0;background:var(--s1);border:1px solid var(--border);cursor:pointer;transition:border-color .15s}
.quote-card:hover{border-color:var(--gold2)}
.quote-card-thumb{width:100%;height:80px;background:var(--s2);display:flex;align-items:center;justify-content:center;overflow:hidden}
.quote-card-body{padding:8px 10px}
.quote-card-vendor{font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--gold2);margin-bottom:2px}
.quote-card-label{font-size:12px;color:var(--text);font-weight:500}
.quote-card-date{font-size:9px;color:var(--text3);margin-top:1px}
.quote-card-amount{font-size:13px;color:var(--green);margin-top:3px;font-family:var(--font-d)}


/* TIMELINE v2 ‚Äî drag + edit */
.tl-item{position:relative;display:flex;align-items:flex-start;justify-content:space-between;gap:4px;cursor:grab}
.tl-item:active{cursor:grabbing}
.tl-item.tl-dragging{opacity:.4}
.tl-item.tl-drop-before{border-top:2px solid var(--gold2)}
.tl-item-text{flex:1;font-size:10px;color:var(--text2);line-height:1.4;cursor:pointer}
.tl-item.done-item .tl-item-text{text-decoration:line-through;color:var(--text3)}
.tl-item-actions{display:none;gap:2px;flex-shrink:0}
.tl-item:hover .tl-item-actions{display:flex}
.tl-item-edit,.tl-item-del{background:transparent;border:none;color:var(--text3);cursor:pointer;font-size:10px;padding:1px 3px;line-height:1}
.tl-item-edit:hover{color:var(--gold)}
.tl-item-del:hover{color:var(--red)}
.tl-item-input{background:var(--s3);border:1px solid var(--gold2);color:var(--text);font-family:var(--font-m);font-size:10px;padding:2px 4px;width:100%;outline:none}
.tl-drop-active{background:rgba(201,168,76,.06)!important;outline:1px dashed var(--gold2)}
.tl-add-btn{background:transparent;border:none;color:var(--text3);font-family:var(--font-m);font-size:9px;letter-spacing:1px;padding:4px 0;cursor:pointer;text-align:left;width:100%;margin-top:4px}
.tl-add-btn:hover{color:var(--gold2)}


/* CREW DOCUMENTS */
.cc-doc-drop{border:1px dashed var(--border2);padding:10px 14px;font-size:10px;color:var(--text3);display:flex;align-items:center;gap:8px;cursor:default;transition:border-color .15s;width:100%}
.cc-doc-drop.active{border-color:var(--gold2);background:rgba(201,168,76,.05)}
.cc-doc-browse{background:transparent;border:1px solid var(--border2);color:var(--text3);font-family:var(--font-m);font-size:9px;padding:3px 8px;cursor:pointer;letter-spacing:.5px}
.cc-doc-browse:hover{border-color:var(--gold2);color:var(--gold)}
.cc-doc-card{display:flex;align-items:center;gap:8px;background:var(--s2);border:1px solid var(--border);padding:8px 10px;width:100%}
.cc-doc-icon{font-size:18px;flex-shrink:0}
.cc-doc-info{flex:1;min-width:0}
.cc-doc-label{font-size:10px;color:var(--gold2);letter-spacing:.5px;text-transform:uppercase}
.cc-doc-filename{font-size:11px;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:220px}
.cc-doc-date{font-size:9px;color:var(--text3)}
.cc-doc-actions{display:flex;gap:4px;flex-shrink:0}
.cc-doc-actions button{background:transparent;border:none;color:var(--text3);cursor:pointer;font-size:12px;padding:2px 4px}
.cc-doc-actions button:hover{color:var(--gold)}

@media print{.sidebar,.command-bar,.topbar{display:none}.app{display:block}.main{overflow:visible;height:auto}.panel{display:block!important;page-break-after:always}body{background:white;color:black}}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:var(--border2)}

/* PAGE INSTRUCTIONS */
.page-instructions{margin-top:40px;border-top:1px solid var(--border);padding-top:16px}
.page-instructions-toggle{display:flex;align-items:center;gap:10px;cursor:pointer;padding:8px 0;user-select:none}
.page-instructions-toggle:hover .pi-label{color:var(--text2)}
.pi-label{font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--text3);transition:color .2s}
.pi-chevron{color:var(--text3);font-size:12px;transition:transform .2s}
.page-instructions.open .pi-chevron{transform:rotate(90deg)}
.pi-body{display:none;padding:14px 0 6px}
.page-instructions.open .pi-body{display:block}
.pi-row{display:flex;gap:10px;margin-bottom:9px;font-size:11px;line-height:1.6}
.pi-key{flex-shrink:0;width:130px;color:var(--gold);font-size:10px;letter-spacing:.5px}
.pi-val{color:var(--text2)}
</style>
</head>
<body>

<!-- PASSWORD GATE -->
<div id="pw-gate" style="position:fixed;inset:0;background:#0a0a0a;z-index:9999;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:0">
  <div style="text-align:center;max-width:360px;width:90%">
    <div style="font-family:'DM Serif Display',Georgia,serif;font-size:28px;color:#c9a84c;margin-bottom:6px;letter-spacing:1px">DP Helm HQ</div>
    <div style="font-size:11px;color:#666;letter-spacing:2px;text-transform:uppercase;margin-bottom:40px">Guitar + Animator POC</div>
    <input id="pw-input" type="password" placeholder="Password" 
      style="width:100%;background:#111;border:1px solid #333;color:#e8e8e8;font-family:monospace;font-size:14px;padding:12px 16px;outline:none;box-sizing:border-box;letter-spacing:2px;margin-bottom:10px"
      onkeydown="if(event.key==='Enter') checkPassword()">
    <button onclick="checkPassword()" 
      style="width:100%;background:transparent;border:1px solid #c9a84c;color:#c9a84c;font-family:monospace;font-size:11px;letter-spacing:3px;text-transform:uppercase;padding:11px;cursor:pointer;transition:all .15s"
      onmouseover="this.style.background='rgba(201,168,76,.1)'" onmouseout="this.style.background='transparent'">
      Unlock ‚Üí
    </button>
    <div id="pw-error" style="color:#cc4444;font-size:10px;letter-spacing:1px;margin-top:10px;height:16px"></div>
  </div>
</div>

<script>
(function(){
  // Check if already authenticated this session
  try{ if(sessionStorage.getItem('dp_helm_auth')==='1'){ document.getElementById('pw-gate').style.display='none'; } }catch(e){}
})();
function checkPassword(){
  const val = document.getElementById('pw-input').value;
  // Password stored as a simple hash check ‚Äî change 'helmready' to your preferred password
  const PW = 'helmready';
  if(val === PW){
    try{ sessionStorage.setItem('dp_helm_auth','1'); }catch(e){}
    const gate = document.getElementById('pw-gate');
    gate.style.transition = 'opacity .4s';
    gate.style.opacity = '0';
    setTimeout(()=> gate.style.display='none', 400);
  } else {
    const err = document.getElementById('pw-error');
    err.textContent = 'Incorrect password';
    document.getElementById('pw-input').value='';
    document.getElementById('pw-input').focus();
    setTimeout(()=>{ err.textContent=''; }, 2500);
  }
}
</script>


<!-- VENDOR CONTACT CARD OVERLAY -->
<div class="vendor-overlay" id="vendor-overlay" onclick="if(event.target===this)closeVendorCard()">
  <div class="contact-card">
    <div class="contact-card-header">
      <div class="contact-card-title" id="vc-title">Vendor</div>
      <button class="contact-card-close" onclick="closeVendorCard()">‚úï</button>
    </div>
    <div class="contact-card-body">
      <div class="contact-field"><label>Company Name</label><input id="vc-company" type="text" placeholder="Company name"></div>
      <div class="contact-field"><label>Contact Person</label><input id="vc-contact" type="text" placeholder="Name"></div>
      <div class="contact-field"><label>Phone</label><input id="vc-phone" type="tel"></div>
      <div class="contact-field"><label>Email</label><input id="vc-email" type="email"></div>
      <div class="contact-field"><label>Notes</label><textarea id="vc-notes" placeholder="Category, specialty, terms, past projects‚Ä¶"></textarea></div>
    </div>
    <div class="contact-actions">
      <button class="contact-act-btn primary" onclick="saveVendorCard()">‚úì Save</button>
      <button class="contact-act-btn" id="vc-call-btn" onclick="window.location='tel:'+document.getElementById('vc-phone').value.replace(/\D/g,'')" style="display:none">üìû Call</button>
      <button class="contact-act-btn" id="vc-email-btn" onclick="window.location='mailto:'+document.getElementById('vc-email').value" style="display:none">‚úâ Email</button>
      <button class="contact-act-btn danger" onclick="removeVendorCard()">Remove</button>
    </div>
  </div>
</div>

<!-- CONTACT CARD OVERLAY -->
<div class="contact-overlay" id="contact-overlay" onclick="if(event.target===this)closeContactCard()">
  <div class="contact-card" id="contact-card-inner">
    <div class="contact-card-header">
      <div class="contact-card-title" id="cc-title">Contact</div>
      <button class="contact-card-close" onclick="closeContactCard()">‚úï</button>
    </div>
    <div class="contact-card-body">
      <div class="contact-field"><label>Role</label><input id="cc-role" type="text" placeholder="e.g. Gaffer"></div>
      <div class="contact-field"><label>Name</label><input id="cc-name" type="text" placeholder="Full name"></div>
      <div class="contact-field"><label>Phone</label><input id="cc-phone" type="tel" placeholder="000-000-0000"></div>
      <div class="contact-field"><label>Email</label><input id="cc-email" type="email" placeholder="email@domain.com"></div>
      <div class="contact-field"><label>Day Rate ($)</label><input id="cc-rate" type="text" placeholder="200"></div>
      <div class="contact-field">
        <label>Status</label>
        <div class="contact-state-row">
          <button class="contact-state-opt hired" id="cs-hired" onclick="setContactState('hired')">Hired</button>
          <button class="contact-state-opt available" id="cs-available" onclick="setContactState('available')">Available</button>
          <button class="contact-state-opt unavailable" id="cs-unavailable" onclick="setContactState('unavailable')">Unavailable</button>
        </div>
      </div>
      <div class="contact-field"><label>Notes</label><textarea id="cc-notes" placeholder="Anything relevant ‚Äî rates negotiated, specialties, past projects, scheduling notes‚Ä¶"></textarea></div>
    </div>
      <!-- DOCUMENTS -->
      <div class="contact-field" style="flex-direction:column;align-items:flex-start;gap:8px">
        <label>Documents</label>
        <div id="cc-docs-list" style="display:flex;flex-wrap:wrap;gap:8px;width:100%;min-height:0"></div>
        <div class="cc-doc-drop" id="cc-doc-drop" ondragover="event.preventDefault();this.classList.add('active')" ondragleave="this.classList.remove('active')" ondrop="handleCrewDocDrop(event)">
          <span>Drop file here or</span>
          <button class="cc-doc-browse" onclick="document.getElementById('cc-doc-file').click()">Browse</button>
          <input type="file" id="cc-doc-file" style="display:none" onchange="handleCrewDocFile(this.files[0])">
        </div>
      </div>
    </div>
    <div class="contact-actions">
      <button class="contact-act-btn primary" onclick="saveContactCard()">‚úì Save</button>
      <button class="contact-act-btn" id="cc-call-btn" onclick="callContact()" style="display:none">üìû Call</button>
      <button class="contact-act-btn" id="cc-email-btn" onclick="emailContact()" style="display:none">‚úâ Email</button>
      <button class="contact-act-btn danger" onclick="removeContactCard()">Remove</button>
    </div>
  </div>
</div>

<!-- LIGHTBOX -->
<div class="lightbox" id="lightbox" onclick="this.classList.remove('show')">
  <img id="lightbox-img" src="" alt="">
</div>

<!-- CONFIRM MODAL -->
<div class="modal-overlay" id="modal">
  <div class="modal">
    <div class="modal-title" id="modal-title">Confirm</div>
    <div class="modal-text" id="modal-text">Are you sure?</div>
    <div class="modal-btns">
      <button class="btn primary" id="modal-confirm">Confirm</button>
      <button class="btn" onclick="closeModal()">Cancel</button>
    </div>
  </div>
</div>

<div class="app">

<!-- TOPBAR -->
<div class="topbar">
  <span class="topbar-logo">DP Helm HQ</span>
  <span class="topbar-sep">|</span>
  <span class="topbar-project">Guitar + Animator POC</span>
  <div class="topbar-right">
    <button onclick="downloadApp()" style="background:transparent;border:1px solid var(--border2);color:var(--text3);font-family:var(--font-m);font-size:9px;letter-spacing:1.5px;text-transform:uppercase;padding:4px 10px;cursor:pointer;transition:all .15s" onmouseover="this.style.borderColor='var(--gold2)';this.style.color='var(--gold)'" onmouseout="this.style.borderColor='var(--border2)';this.style.color='var(--text3)'" title="Download this file">‚Üì Download</button>
    <span class="badge" style="border-color:var(--border2);color:var(--text3)">Shoot: Feb 27</span>
    <span class="badge live" id="topbar-daysout">‚Äî days</span>
    <span class="badge warn" id="topbar-flag1">1st AC Open</span>
    <span class="badge warn" id="topbar-flag2">Steadicam Op Open</span>
    <span class="badge live">AI Live</span>
    <span class="badge btn" onclick="exportPDF()" style="border-color:var(--gold2);color:var(--gold)">‚¨° Export PDF</span>
  </div>
</div>

<!-- SIDEBAR -->
<div class="sidebar">
  <div class="nav-label">Command</div>
  <div class="nav-item active" onclick="showPanel('overview',this)"><span class="nav-icon">‚óà</span> Overview</div>
  <div class="nav-item" onclick="showPanel('schedule',this)"><span class="nav-icon">‚ñ∑</span> Schedule</div>
  <div class="nav-item" onclick="showPanel('checklist',this)"><span class="nav-icon">‚óâ</span> Checklist</div>
  <div class="nav-label">Scenes</div>
  <div class="nav-item" onclick="showPanel('performance',this)"><span class="nav-icon">‚óë</span> Performance Scene</div>
  <div class="nav-item" onclick="showPanel('genesis',this)"><span class="nav-icon">‚óê</span> Genesis Scene</div>
  <div class="nav-label">Visual</div>
  <div class="nav-item" onclick="showPanel('vl',this)"><span class="nav-icon">‚ñ£</span> Visual Language</div>
  <div class="nav-item" onclick="showPanel('scout',this)"><span class="nav-icon">‚äû</span> Scout + Overhead</div>
  <div class="nav-label">Production</div>
  <div class="nav-item" onclick="showPanel('crew',this)"><span class="nav-icon">‚óª</span> Crew</div>
  <div class="nav-item" onclick="showPanel('vendors',this)"><span class="nav-icon">‚óé</span> Vendors</div>
  <div class="nav-item" onclick="showPanel('gear',this)"><span class="nav-icon">‚ñ¶</span> Gear</div>
  <div class="nav-item" onclick="showPanel('budget',this)"><span class="nav-icon">‚óå</span> Budget</div>
  <div class="nav-label">Intelligence</div>
  <div class="nav-item" onclick="showPanel('inbox',this)"><span class="nav-icon">‚¨°</span> Project Inbox</div>
  <div class="nav-item" onclick="showPanel('log',this)"><span class="nav-icon">‚óà</span> Decision Log</div>
  <div class="nav-item" onclick="showPanel('settings',this)"><span class="nav-icon">‚óé</span> API Keys</div>
  <div class="nav-label">Stats</div>
  <div class="project-stat"><div class="project-stat-label">Shoot Date</div><div class="project-stat-val">Feb 27</div></div>
  <div class="project-stat"><div class="project-stat-label">Days Out</div><div class="project-stat-val" id="days-out">‚Äî</div></div>
  <div class="project-stat"><div class="project-stat-label">Crew Locked</div><div class="project-stat-val">1/4</div></div>
  <div class="project-stat"><div class="project-stat-label">Prep</div><div class="project-stat-val" id="checklist-pct">0%</div></div>
</div>

<!-- MAIN -->
<div class="main">

<!-- OVERVIEW -->
<div class="panel active" id="panel-overview">
  <div class="panel-title">Project Overview</div>
  <div class="panel-sub">Two separate deliverables ¬∑ Live action + hand-drawn animation ¬∑ POC for feature</div>

  <div class="grid3" style="margin-bottom:14px">
    <div class="card ov-clickable" onclick="showPanel('schedule',document.querySelector('.nav-item[onclick*=schedule]'))" title="Go to Schedule">
      <div class="card-title">Shoot Date</div><div class="card-val" style="font-size:18px">Feb 27</div><div class="card-sub" id="ov-daysout">‚Äî days out</div>
      <div class="ov-link-hint">‚Üí Schedule</div>
    </div>
    <div class="card ov-clickable" onclick="showPanel('crew',document.querySelector('.nav-item[onclick*=crew]'))" title="Go to Crew">
      <div class="card-title">Crew Locked</div><div class="card-val" id="ov-crew">‚Äî hired</div><div class="card-sub" id="ov-crew-sub">Loading‚Ä¶</div>
      <div class="ov-link-hint">‚Üí Crew</div>
    </div>
    <div class="card ov-clickable" onclick="showPanel('checklist',document.querySelector('.nav-item[onclick*=checklist]'))" title="Go to Checklist">
      <div style="display:flex;align-items:center;gap:6px;margin-bottom:4px">
        <div class="rag red" id="ov-prep-rag"></div>
        <div class="card-title" style="margin:0">Prep Complete</div>
      </div>
      <div class="card-val" id="ov-prep">‚Äî%</div><div class="card-sub">Checklist progress</div>
      <div class="ov-link-hint">‚Üí Checklist</div>
    </div>
  </div>

  <div class="grid2" style="margin-bottom:14px">
    <div class="card ov-clickable" style="border-color:var(--gold2)" onclick="showPanel('performance',document.querySelector('.nav-item[onclick*=performance]'))" title="Go to Performance Scene">
      <div class="slug">EXT. BACKYARD ‚Äî DAY</div>
      <div class="card-title" style="color:var(--gold)">Video 1 ‚Äî Performance Scene</div>
      <div style="font-size:11px;color:var(--text2);line-height:1.7">Guitarist ¬∑ Steadicam pull-out from strings to world ¬∑ Fantasia-style animation ¬∑ Dawn-feel lighting ¬∑ 4‚Äì5 shots</div>
      <div class="ov-link-hint" style="color:var(--gold2)">‚Üí Scene details</div>
    </div>
    <div class="card ov-clickable" style="border-color:var(--purple)" onclick="showPanel('genesis',document.querySelector('.nav-item[onclick*=genesis]'))" title="Go to Genesis Scene">
      <div class="slug" style="color:var(--purple)">INT. ANIMATOR'S STUDIO ‚Äî TBD</div>
      <div class="card-title" style="color:var(--purple)">Video 2 ‚Äî Genesis Scene</div>
      <div style="font-size:11px;color:var(--text2);line-height:1.7">Animator's home studio ¬∑ Tight montage of animation ritual ¬∑ Pencil sharpening to character coming to life ¬∑ Warm Baumbach/Juno feel ¬∑ ~10 shots</div>
      <div class="ov-link-hint" style="color:var(--purple)">‚Üí Scene details</div>
    </div>
  </div>

  <div class="section-title" style="margin-top:0">Active Flags</div>
  <div class="impact-box" id="ov-flags" style="margin-bottom:14px;min-height:40px"></div>

  <div class="section-title">Crew ‚Äî Confirmed</div>
  <div id="ov-crew-camera" style="margin-bottom:8px"></div>
  <div id="ov-crew-electric" style="margin-bottom:8px"></div>
  <div id="ov-crew-grip" style="margin-bottom:8px"></div>
  <div id="ov-crew-open-flags" style="margin-top:2px;margin-bottom:4px"></div>

  <div class="section-title">Vendors</div>
  <div id="ov-vendors" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:4px">
    <div class="crew-card-v3 is-available" style="width:auto;min-width:130px">
      <div class="crew-card-v3-role">Rental House</div>
      <div class="crew-card-v3-name" style="cursor:default">Lightstone Rentals</div>
      <div style="font-size:9px;color:var(--text3);margin-top:3px">Ryan Beardsley</div>
    </div>
  </div>
  <div class="page-instructions"><div class="page-instructions-toggle" onclick="toggleInstructions(this)"><span class="pi-chevron">‚Ä∫</span><span class="pi-label">How to use this page</span></div><div class="pi-body"><div class="pi-row"><div class="pi-key">Stats row</div><div class="pi-val">Three clickable cards: <strong>Shoot Date</strong> links to Schedule, <strong>Crew Locked</strong> links to Crew, <strong>Prep Complete</strong> links to Checklist. The RAG dot on Prep Complete turns red/yellow/green based on checklist progress ‚Äî it updates live every time you check something off.</div></div><div class="pi-row"><div class="pi-key">Active Flags</div><div class="pi-val">Every flag is a live checklist item or crew slot. <strong>Red</strong> = blocked or missing. <strong>Yellow</strong> = open question. Click any flag with a ‚Üí arrow to jump directly to the source ‚Äî it navigates to the right panel, opens the right group, and pulses the item in gold for 5 seconds so you can't miss it. Flags disappear when you check off the linked item or hire the open role.</div></div><div class="pi-row"><div class="pi-key">Two scenes</div><div class="pi-val">Click either scene card to jump to its full detail panel ‚Äî shot list, lighting notes, lens choices. The Genesis card links to Genesis Scene, Performance to Performance Scene.</div></div><div class="pi-row"><div class="pi-key">Crew section</div><div class="pi-val">Live mirror of hired crew, grouped by department. Click any card to open their full contact card.</div></div><div class="pi-row"><div class="pi-key">Vendors section</div><div class="pi-val">COI status for each vendor at a glance. Click a card to jump to the Vendors panel.</div></div><div class="pi-row"><div class="pi-key">AI command bar</div><div class="pi-val">At the bottom of every page. Type any update in plain language ‚Äî "Tate is available after all, add him as 1st AC at $250/day" ‚Äî and it proposes changes for your review before committing. Committed changes log automatically to the Decision Log.</div></div></div></div>
</div>

<!-- SCHEDULE -->
<div class="panel" id="panel-schedule">
  <div class="panel-title">Schedule</div>
  <div class="panel-sub">Feb 17 ‚Üí Shoot Feb 27 ¬∑ Scout Feb 25 ¬∑ Returns Mar 2</div>

  <div class="timeline-wrap">
    <div class="timeline" id="timeline-root"></div>
  </div>

  <div class="note-block" style="margin-top:20px">
    <strong>Click any action item</strong> to mark it done. Items shown in <span style="color:var(--amber)">amber</span> are urgent. Scout and shoot days are highlighted. Add action items via the AI command bar ‚Äî e.g. "Add action item: call Ryan at Lightstone for quote, due Feb 19."
  </div>
  <div class="page-instructions"><div class="page-instructions-toggle" onclick="toggleInstructions(this)"><span class="pi-chevron">‚Ä∫</span><span class="pi-label">How to use this page</span></div><div class="pi-body"><div class="pi-row"><div class="pi-key">Timeline</div><div class="pi-val">One column per day, Feb 17 through shoot day Feb 27. Scroll horizontally. Scout day (Feb 25) is purple, Shoot day (Feb 27) is gold. The "Today" column has a blue border.</div></div><div class="pi-row"><div class="pi-key">Check items off</div><div class="pi-val">Click any item text to toggle done / undone. Done items strike through. Click again to unmark.</div></div><div class="pi-row"><div class="pi-key">Edit an item</div><div class="pi-val">Hover an item to reveal ‚úé and ‚úï buttons. Click ‚úé to edit the text inline ‚Äî type, then press Enter or click away to save. Press Escape to cancel. Click ‚úï to delete the item permanently.</div></div><div class="pi-row"><div class="pi-key">Drag to reorder</div><div class="pi-val">Drag any item to a different position within the same day, or drop it into a different day's column entirely. A gold dashed outline shows the drop target. All moves log to the Decision Log.</div></div><div class="pi-row"><div class="pi-key">Add items</div><div class="pi-val">Click <strong>+ Add item</strong> at the bottom of any day column. The new item opens immediately in edit mode ‚Äî type and press Enter. Or use the AI command bar: "Add tech scout at the V2 location for Feb 22" ‚Äî it proposes the addition, you approve, and it lands on the right date.</div></div><div class="pi-row"><div class="pi-key">Persistence</div><div class="pi-val">Schedule state saves to localStorage automatically. Reload the page and everything is exactly where you left it.</div></div></div></div>
</div>

<!-- CHECKLIST -->
<div class="panel" id="panel-checklist">
  <div class="panel-title">Status Checklist</div>
  <div class="panel-sub">Expand each group ¬∑ click to check off</div>
  <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
    <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:10px;color:var(--text3);letter-spacing:.5px;user-select:none">
      <input type="checkbox" id="hide-completed-toggle" onchange="toggleHideCompleted(this.checked)" style="cursor:pointer;accent-color:var(--gold2)">
      Hide completed items
    </label>
  </div>
  <div class="checklist-key">
    <div class="key-item"><div class="rag green"></div> All items complete</div>
    <div class="key-item"><div class="rag yellow"></div> In progress / partial</div>
    <div class="key-item"><div class="rag red"></div> Not started / blocked</div>
    <div class="key-item"><div class="rag grey"></div> Not yet applicable</div>
    <div class="key-item" style="color:var(--text2);border-left:1px solid var(--border2);padding-left:16px">Click group header to expand ¬∑ Click item to check off</div>
  </div>
  <div class="checklist">
    <div class="check-group" id="cg-crew">
      <div class="check-group-header" onclick="toggleGroup('cg-crew')"><div class="rag red" id="rag-cg-crew"></div><div class="check-group-title">Crew</div><div class="check-group-meta" id="meta-cg-crew">0 of 4</div><div class="check-chevron">‚Ä∫</div></div>
      <div class="check-items">
        <div class="check-item" data-flag-id="flag-crew-1stacfocuspuller" onclick="toggleCheck(this,'cg-crew')"><div class="check-box"></div><div class="check-text">1st AC confirmed<div class="check-note">Tate unavailable ‚Äî replacement needed</div></div></div>
        <div class="check-item" onclick="toggleCheck(this,'cg-crew')"><div class="check-box"></div><div class="check-text">DIT confirmed ‚Äî Daniel Elder<div class="check-note">952-715-0053 ¬∑ email TBD</div></div></div>
        <div class="check-item" data-flag-id="flag-steadicam" onclick="toggleCheck(this,'cg-crew')"><div class="check-box"></div><div class="check-text">Steadicam operator confirmed<div class="check-note">Critical path ¬∑ V1 dependent</div></div></div>
        <div class="check-item" data-flag-id="flag-crew-gaffer" onclick="toggleCheck(this,'cg-crew')"><div class="check-box"></div><div class="check-text">Gaffer confirmed</div></div>
      </div>
    </div>
    <div class="check-group" id="cg-rental">
      <div class="check-group-header" onclick="toggleGroup('cg-rental')"><div class="rag red" id="rag-cg-rental"></div><div class="check-group-title">Rental Confirmed</div><div class="check-group-meta" id="meta-cg-rental">0 of 8</div><div class="check-chevron">‚Ä∫</div></div>
      <div class="check-items">
        <div class="check-item" onclick="toggleCheck(this,'cg-rental')"><div class="check-box"></div><div class="check-text">Quote received from Lightstone</div></div>
        <div class="check-item" onclick="toggleCheck(this,'cg-rental')"><div class="check-box"></div><div class="check-text">Alexa 35 + accessories confirmed</div></div>
        <div class="check-item" onclick="toggleCheck(this,'cg-rental')"><div class="check-box"></div><div class="check-text">Atlas Mercury set confirmed (32/50/75 ‚Äî to verify)</div></div>
        <div class="check-item" onclick="toggleCheck(this,'cg-rental')"><div class="check-box"></div><div class="check-text">Nanlux (2400 / 1200 / 900) confirmed</div></div>
        <div class="check-item" onclick="toggleCheck(this,'cg-rental')"><div class="check-box"></div><div class="check-text">Steadicam rig confirmed</div></div>
        <div class="check-item" onclick="toggleCheck(this,'cg-rental')"><div class="check-box"></div><div class="check-text">LiteMat 4 confirmed (V2 pending location)</div></div>
        <div class="check-item" onclick="toggleCheck(this,'cg-rental')"><div class="check-box"></div><div class="check-text">Diopter set confirmed</div></div>
        <div class="check-item" onclick="toggleCheck(this,'cg-rental')"><div class="check-box"></div><div class="check-text">Rental order signed + deposit paid</div></div>
      </div>
    </div>
    <div class="check-group" id="cg-coi">
      <div class="check-group-header" onclick="toggleGroup('cg-coi')"><div class="rag red" id="rag-cg-coi"></div><div class="check-group-title">Insurance / COI</div><div class="check-group-meta" id="meta-cg-coi">0 of 4</div><div class="check-chevron">‚Ä∫</div></div>
      <div class="check-items">
        <div class="check-item" onclick="toggleCheck(this,'cg-coi')"><div class="check-box"></div><div class="check-text">COI request received from Lightstone<div class="check-note">Check with Ryan Beardsley</div></div></div>
        <div class="check-item" onclick="toggleCheck(this,'cg-coi')"><div class="check-box"></div><div class="check-text">COI submitted to broker</div></div>
        <div class="check-item" onclick="toggleCheck(this,'cg-coi')"><div class="check-box"></div><div class="check-text">COI received from broker</div></div>
        <div class="check-item" data-flag-id="flag-coi-lightstone" data-coi-vendor="vendor-lightstone" onclick="toggleCheck(this,'cg-coi')"><div class="check-box"></div><div class="check-text">COI delivered to + confirmed by Lightstone</div></div>
      </div>
    </div>
    <div class="check-group" id="cg-locations">
      <div class="check-group-header" onclick="toggleGroup('cg-locations')"><div class="rag red" id="rag-cg-locations"></div><div class="check-group-title">Locations</div><div class="check-group-meta" id="meta-cg-locations">0 of 6</div><div class="check-chevron">‚Ä∫</div></div>
      <div class="check-items">
        <div class="check-item" onclick="toggleCheck(this,'cg-locations')"><div class="check-box"></div><div class="check-text">V1 ‚Äî EXT. BACKYARD confirmed</div></div>
        <div class="check-item" onclick="toggleCheck(this,'cg-locations')"><div class="check-box"></div><div class="check-text">V1 ‚Äî 20A power circuit confirmed</div></div>
        <div class="check-item" data-flag-id="flag-v2loc" onclick="toggleCheck(this,'cg-locations')"><div class="check-box"></div><div class="check-text">V2 ‚Äî INT. ANIMATOR'S STUDIO locked</div></div>
        <div class="check-item" onclick="toggleCheck(this,'cg-locations')"><div class="check-box"></div><div class="check-text">V2 ‚Äî Location scout completed</div></div>
        <div class="check-item" onclick="toggleCheck(this,'cg-locations')"><div class="check-box"></div><div class="check-text">Tech scout scheduled (Feb 25)</div></div>
        <div class="check-item" onclick="toggleCheck(this,'cg-locations')"><div class="check-box"></div><div class="check-text">Tech scout completed</div></div>
      </div>
    </div>
    <div class="check-group" id="cg-tech">
      <div class="check-group-header" onclick="toggleGroup('cg-tech')"><div class="rag red" id="rag-cg-tech"></div><div class="check-group-title">Technical</div><div class="check-group-meta" id="meta-cg-tech">0 of 6</div><div class="check-chevron">‚Ä∫</div></div>
      <div class="check-items">
        <div class="check-item" data-flag-id="flag-diopter" onclick="toggleCheck(this,'cg-tech')"><div class="check-box"></div><div class="check-text">Diopter + Atlas Mercury compatibility test</div></div>
        <div class="check-item" data-flag-id="flag-codec" onclick="toggleCheck(this,'cg-tech')"><div class="check-box"></div><div class="check-text">Codec confirmed with animator (ProRes 4444 vs RAW)</div></div>
        <div class="check-item" data-flag-id="flag-nanlux" onclick="toggleCheck(this,'cg-tech')"><div class="check-box"></div><div class="check-text">Nanlux 20A circuit confirmed<div class="check-note">Confirm available at V1 location or plan to run at 80% / swap to Nanlux 1200</div></div></div>
        <div class="check-item" onclick="toggleCheck(this,'cg-tech')"><div class="check-box"></div><div class="check-text">DIT briefed on codec + LUT strategy</div></div>
        <div class="check-item" onclick="toggleCheck(this,'cg-tech')"><div class="check-box"></div><div class="check-text">VFX shots (G8 + G9) planned with animator</div></div>
        <div class="check-item" onclick="toggleCheck(this,'cg-tech')"><div class="check-box"></div><div class="check-text">LUT built + distributed to DIT</div></div>
      </div>
    </div>
    <div class="check-group" id="cg-schedule">
      <div class="check-group-header" onclick="toggleGroup('cg-schedule')"><div class="rag yellow" id="rag-cg-schedule"></div><div class="check-group-title">Schedule</div><div class="check-group-meta" id="meta-cg-schedule">1 of 5</div><div class="check-chevron">‚Ä∫</div></div>
      <div class="check-items">
        <div class="check-item done" onclick="toggleCheck(this,'cg-schedule')"><div class="check-box">‚úì</div><div class="check-text">Shoot date confirmed ‚Äî Feb 27</div></div>
        <div class="check-item" onclick="toggleCheck(this,'cg-schedule')"><div class="check-box"></div><div class="check-text">V1 call time set (~7AM for 9AM light)</div></div>
        <div class="check-item" data-flag-id="flag-v2tod" onclick="toggleCheck(this,'cg-schedule')"><div class="check-box"></div><div class="check-text">V2 time of day confirmed with director</div></div>
        <div class="check-item" onclick="toggleCheck(this,'cg-schedule')"><div class="check-box"></div><div class="check-text">Shot order locked with director</div></div>
        <div class="check-item" onclick="toggleCheck(this,'cg-schedule')"><div class="check-box"></div><div class="check-text">Call sheet drafted + distributed</div></div>
      </div>
    </div>
  </div>
  <div class="page-instructions"><div class="page-instructions-toggle" onclick="toggleInstructions(this)"><span class="pi-chevron">‚Ä∫</span><span class="pi-label">How to use this page</span></div><div class="pi-body"><div class="pi-row"><div class="pi-key">Groups</div><div class="pi-val">Six groups: Crew, Rental Confirmed, Insurance/COI, Locations, Technical, Schedule. Click any group header to expand or collapse it. The RAG dot shows red (nothing done), yellow (partial), green (all done). The counter (e.g. "3 of 6") updates live.</div></div><div class="pi-row"><div class="pi-key">Checking items</div><div class="pi-val">Click any item to check it off ‚Äî green box + ‚úì + strikethrough. Click again to uncheck. State saves automatically to localStorage and survives page reload.</div></div><div class="pi-row"><div class="pi-key">Active Flags sync</div><div class="pi-val">Every checklist item with a linked flag (shown by data-flag-id) automatically resolves that flag on the Overview when checked, and un-resolves it when unchecked. No manual step needed.</div></div><div class="pi-row"><div class="pi-key">Hide completed</div><div class="pi-val">Checkbox at the top: <strong>Hide completed items</strong>. Hides all checked items across all groups instantly. Uncheck to show them again. Useful for seeing only what's left.</div></div><div class="pi-row"><div class="pi-key">Overview RAG</div><div class="pi-val">The Prep Complete card on the Overview reflects total checklist percentage ‚Äî and its RAG dot turns green only when 100% of items are checked.</div></div><div class="pi-row"><div class="pi-key">COI sync</div><div class="pi-val">The "COI delivered to + confirmed by Lightstone" item syncs directly to the COI status on the Lightstone vendor card. Checking it marks the vendor COI as Confirmed.</div></div></div></div>
</div>

<!-- PERFORMANCE SCENE -->
<div class="panel" id="panel-performance">
  <div class="panel-title">Video 1 ‚Äî Performance Scene</div>
  <div class="slug">EXT. BACKYARD ‚Äî DAY (9‚Äì11AM)</div>
  <div class="panel-sub">Guitarist ¬∑ Steadicam ¬∑ Fantasia-style animation overlay ¬∑ 4‚Äì5 shots</div>
  <div class="note-block"><strong>Director brief:</strong> Animation is emotional expression ‚Äî the way a song is emotion in musical theater. It's an extension of feeling, not decoration. The Steadicam pull-out is the spine of this video.</div>
  <div class="section-title">Shot List</div>
  <table class="shot-table">
    <thead><tr><th>Shot</th><th>Description</th><th>Lens</th><th>Movement</th><th>Notes</th></tr></thead>
    <tbody>
      <tr><td class="shot-id">P1</td><td><strong>Steadicam pull-out</strong> ‚Äî extreme tight strings ‚Üí guitarist in world</td><td>32‚Äì40mm Mercury</td><td>Steadicam ¬∑ multiple speeds</td><td>Hero shot ¬∑ shoot several speed variations ¬∑ animation canvas</td></tr>
      <tr><td class="shot-id">P2</td><td>XCU ‚Äî guitar strings texture</td><td>50‚Äì75mm + diopter TBC</td><td>Locked</td><td>Check Mercury 50 min focus dist. May need diopter.</td></tr>
      <tr><td class="shot-id">P3</td><td>CU ‚Äî guitarist's face / expression</td><td>75‚Äì100mm Mercury</td><td>Locked / slight float</td><td>Emotion anchor ¬∑ complement to animation</td></tr>
      <tr><td class="shot-id">P4</td><td>Wide establishing ‚Äî guitarist in full environment</td><td>25‚Äì32mm Mercury</td><td>Locked or slow Steadicam</td><td>World-building ¬∑ context for animation to inhabit</td></tr>
      <tr><td class="shot-id">P5</td><td>Detail insert TBD ‚Äî fountain / leaves / hands / other</td><td>TBD</td><td>Locked</td><td>Poetic detail ¬∑ discuss with director ¬∑ possible animation trigger</td></tr>
    </tbody>
  </table>
  <div class="section-title">Lighting Strategy</div>
  <div class="note-block"><strong>Dawn-feel at 9‚Äì11AM:</strong> Nanlux 2400 (or 1200/900) gelled ¬º‚Äì¬Ω CTO ¬∑ 3/4 back to simulate low raking sun ¬∑ owned diffusion to soften if needed ¬∑ MC Pro for accent if used ¬∑ B7c bulbs on truck ‚Äî use if practical source needed in frame.<br><strong>Power:</strong> Nanlux 2400 = ~22A. On 20A circuit ‚Üí run at 80% or use 1200.</div>
  <div class="page-instructions"><div class="page-instructions-toggle" onclick="toggleInstructions(this)"><span class="pi-chevron">‚Ä∫</span><span class="pi-label">How to use this page</span></div><div class="pi-body"><div class="pi-row"><div class="pi-key">Shot IDs</div><div class="pi-val">Shots are prefixed P (Performance) ‚Äî P1 through P5. Each has a shot type, lens choice, movement, and lighting note. These are working references, not locked ‚Äî edit freely as the creative evolves.</div></div><div class="pi-row"><div class="pi-key">Lighting plan</div><div class="pi-val">Nanlux 2400B as key (¬º CTO for warmth), LiteMat 4 as fill/bounce. Shoot window 9‚Äì11AM for golden hour quality. The lighting section shows ratios and modifiers for each setup.</div></div><div class="pi-row"><div class="pi-key">Steadicam dependency</div><div class="pi-val">Shot P1 (pull-out from strings to world) is the defining shot for this video and requires a Steadicam operator. This is flagged as critical on the Overview until a Steadicam op is hired.</div></div><div class="pi-row"><div class="pi-key">VFX notes</div><div class="pi-val">The Fantasia-style animation integration is noted per-shot. G8 and G9 (Genesis shots) are the VFX handoff shots ‚Äî these need to be planned with the animator before shoot day.</div></div></div></div>
</div>

<!-- GENESIS SCENE -->
<div class="panel" id="panel-genesis">
  <div class="panel-title">Video 2 ‚Äî Genesis Scene</div>
  <div class="slug" style="color:var(--purple)">INT. ANIMATOR'S STUDIO ‚Äî TVD</div>
  <div class="panel-sub">Home studio ¬∑ Animation ritual montage ¬∑ ~10 shots ¬∑ Location TVD</div>
  <div class="note-block"><strong>Director brief:</strong> Naturalistic. Warm, saturated Baumbach/Juno feel ‚Äî NOT Little Miss Sunshine desaturated. Lamp island in a warm sea. Tight montage of animator's ritual ‚Äî sharpening pencil like building a magic wand ‚Äî ends with animation winking or walking off the page.</div>
  <div class="section-title">Shot List</div>
  <table class="shot-table">
    <thead><tr><th>Shot</th><th>Description</th><th>Lens</th><th>Movement</th><th>Notes</th></tr></thead>
    <tbody>
      <tr><td class="shot-id">G1</td><td>Wide from behind ‚Äî animator at desk, room visible</td><td>32‚Äì40mm Mercury</td><td>Very slow push or pull</td><td>Establishes room ¬∑ dark warm edges ¬∑ lamp island on desk</td></tr>
      <tr><td class="shot-id">G2</td><td>CU ‚Äî pencil sharpening</td><td>75‚Äì100mm + diopter</td><td>Locked</td><td>Ritual begins ¬∑ could combine w/ G3</td></tr>
      <tr><td class="shot-id">G3</td><td>CU ‚Äî dulling pencil on scratch pad</td><td>75‚Äì100mm + diopter</td><td>Locked</td><td>Building the tool ¬∑ could combine w/ G2</td></tr>
      <tr><td class="shot-id">G4</td><td>CU ‚Äî wiping / cleaning the page</td><td>50‚Äì75mm Mercury</td><td>Locked</td><td>The blank slate ¬∑ could combine w/ G5</td></tr>
      <tr><td class="shot-id">G5</td><td>XCU ‚Äî first strokes, character emerging on page</td><td>75‚Äì100mm + diopter</td><td>Locked / very slow push</td><td>Magic begins ¬∑ graphite texture</td></tr>
      <tr><td class="shot-id">G6</td><td>CU ‚Äî animator's eyes squinting</td><td>75‚Äì100mm Mercury</td><td>Locked</td><td>Shot / reverse with G7 ¬∑ intensity of focus</td></tr>
      <tr><td class="shot-id">G7</td><td>XCU ‚Äî pencil on page (reverse of G6)</td><td>100mm + diopter</td><td>Locked</td><td>Eye‚Äìhand dance ¬∑ tight macro detail</td></tr>
      <tr><td class="shot-id">G8</td><td>OTS ‚Äî flat-on the animation, finished or near</td><td>40‚Äì50mm Mercury</td><td>Locked / slight push</td><td>‚ö° VFX moment ‚Äî animation winks / walks off page</td></tr>
      <tr><td class="shot-id">G9</td><td>Beauty shot ‚Äî character alone on page</td><td>75mm Mercury or macro</td><td>Locked</td><td>‚ö° VFX plate ‚Äî coordinate comp workflow with animator pre-shoot</td></tr>
      <tr><td class="shot-id">G10</td><td>Detail pickups ‚Äî shavings, graphite dust, desk objects</td><td>Macro / diopter</td><td>Locked</td><td>Texture library ¬∑ as time allows</td></tr>
    </tbody>
  </table>
  <div class="section-title">Lighting Strategy</div>
  <div class="note-block"><strong>Lamp island approach:</strong> LiteMat 4 as soft wrap key (warm, from above/side) ¬∑ B7c as practical desk lamp source if needed ¬∑ MC Pro as subtle eye light or accent ¬∑ Dark edges of room fall off naturally ¬∑ Aim for: subject isolated in warm light, room texture visible in shadow but not competing.<br><strong>Contrast:</strong> Higher than V1 ‚Äî this is a lamp island, not outdoor dawn. Let the shadows be rich. The animation should breathe visually ‚Äî less busy background = more focus on the page.</div>
  <div class="impact-box"><strong>‚ö° VFX coordination (G8 + G9):</strong> These shots (animation comes to life) need pre-production planning with the animator. What's a locked plate? What gets composited? What frame rate / codec does the VFX pipeline need? Confirm before tech scout.</div>
  <div class="page-instructions"><div class="page-instructions-toggle" onclick="toggleInstructions(this)"><span class="pi-chevron">‚Ä∫</span><span class="pi-label">How to use this page</span></div><div class="pi-body"><div class="pi-row"><div class="pi-key">Shot IDs</div><div class="pi-val">Shots are prefixed G (Genesis) ‚Äî G1 through G10. Tight montage of the animation ritual: pencil sharpening, drawing, character emerging. Warm Baumbach/Juno feel.</div></div><div class="pi-row"><div class="pi-key">Location dependency</div><div class="pi-val">V2 location (INT. ANIMATOR'S STUDIO) is still TBD ‚Äî this is a live flag on the Overview. The lighting package (LiteMat 4 qty and placement) can't finalize until the location is locked. Update the flag by checking off the location item on the Checklist.</div></div><div class="pi-row"><div class="pi-key">Lighting approach</div><div class="pi-val">Warm practicals ‚Äî Aperture B7c √ó 3 as in-frame bulbs, MC Pro as eye light accent. LiteMat 4 as primary source. Window control TBD based on location and time of day.</div></div><div class="pi-row"><div class="pi-key">Codec decision</div><div class="pi-val">The animator needs to confirm ProRes 4444 vs RAW for the VFX handoff shots (G8, G9). This is flagged on the Checklist ‚Üí Technical.</div></div></div></div>
</div>

<!-- VISUAL LANGUAGE -->
<div class="panel" id="panel-vl">
  <div class="panel-title">Visual Language</div>
  <div class="panel-sub">Per-video cinematographic parameters ‚Äî click any value to edit</div>
  <div class="vl-tab-bar">
    <div class="vl-tab active" onclick="showVLTab('vl-v1',this)">Video 1 ‚Äî Performance</div>
    <div class="vl-tab" onclick="showVLTab('vl-v2',this)">Video 2 ‚Äî Genesis</div>
    <div class="vl-tab" onclick="showVLTab('vl-shared',this)">Shared</div>
  </div>

  <div class="vl-panel active" id="vl-v1">
    <div class="section-title" style="margin-top:0">Director References</div>
    <div class="vl-card" style="margin-bottom:12px"><div class="vl-label">V1 References</div><div class="vl-note" contenteditable="true">Fantasia (Disney) ‚Äî animation as emotional expression. Abstract hand-drawn over live action. The animation IS the emotion, the way a song is emotion in musical theater. Dawn quality, warm raking light.</div></div>
    <div class="section-title">Camera Parameters</div>
    <div class="vl-grid">
      <div class="vl-card"><div class="vl-label">T-Stop Target</div><div class="vl-value" contenteditable="true">T2.8 ‚Äì T4</div><div class="vl-note" contenteditable="true">Shallow on CUs (strings, face), stop down for wide Steadicam pull-out.</div></div>
      <div class="vl-card" style="border-color:var(--amber)"><div class="vl-label" style="color:var(--amber)">Open Question ‚Äî Steadicam Stop</div><div class="vl-note" contenteditable="true">The Steadicam moves from XCU strings (needs shallow DoF) to wide (benefits from more depth). Consider: one take stops down mid-move? Or shoot multiple takes at different stops and decide in edit? Call on the day ‚Äî note decision here when made.</div></div>
      <div class="vl-card"><div class="vl-label">Contrast Ratio</div><div class="vl-value" contenteditable="true">3:1 ‚Äì 4:1</div><div class="vl-note" contenteditable="true">EXT dawn feel ‚Äî open and airy. Enough fill to keep shadow detail for animation compositing.</div></div>
      <div class="vl-card"><div class="vl-label">Color Temperature</div><div class="vl-value" contenteditable="true">Warm ‚Äî TBD in grade</div><div class="vl-note" contenteditable="true">Nanlux gelled ¬º CTO. Set white balance on the day. Leave final temp decisions to DaVinci with Daniel.</div></div>
      <div class="vl-card"><div class="vl-label">LUT Strategy</div><div class="vl-value" contenteditable="true">TBD w/ Daniel Elder</div><div class="vl-note" contenteditable="true">On-set monitoring LUT + deliverable LUT. Confirm before shoot.</div></div>
    </div>
    <div class="section-title">Shot Size Definitions</div>
    <div class="vl-grid">
      <div class="vl-card"><div class="vl-label">XCU</div><div class="vl-note" contenteditable="true">Strings filling frame. Diopter territory. Texture is the subject.</div></div>
      <div class="vl-card"><div class="vl-label">CU</div><div class="vl-note" contenteditable="true">Face / fretting hand. Emotion anchor.</div></div>
      <div class="vl-card"><div class="vl-label">MS</div><div class="vl-note" contenteditable="true">Hands + instrument in context. 40‚Äì50mm.</div></div>
      <div class="vl-card"><div class="vl-label">Wide</div><div class="vl-note" contenteditable="true">Full figure in backyard. World for animation to inhabit. 25‚Äì32mm.</div></div>
    </div>
  </div>

  <div class="vl-panel" id="vl-v2">
    <div class="section-title" style="margin-top:0">Director References</div>
    <div class="vl-card" style="margin-bottom:12px"><div class="vl-label">V2 References</div><div class="vl-note" contenteditable="true">Noah Baumbach ¬∑ Juno (Jason Reitman) ‚Äî warm, saturated, specific. NOT Little Miss Sunshine (desaturated/flat). Classic study aesthetic: lamp island in warm sea. Rich dark edges, focused light on subject and craft.</div></div>
    <div class="section-title">Camera Parameters</div>
    <div class="vl-grid">
      <div class="vl-card"><div class="vl-label">T-Stop Target</div><div class="vl-value" contenteditable="true">T2 ‚Äì T2.8</div><div class="vl-note" contenteditable="true">Shallower overall ‚Äî macro diopter shots especially. Let background fall soft.</div></div>
      <div class="vl-card"><div class="vl-label">Contrast Ratio</div><div class="vl-value" contenteditable="true">5:1 ‚Äì 6:1</div><div class="vl-note" contenteditable="true">Higher than V1. Lamp island feel ‚Äî rich shadows, let room fall off. Animation should breathe visually against dark background.</div></div>
      <div class="vl-card"><div class="vl-label">Color Temperature</div><div class="vl-value" contenteditable="true">Warm ‚Äî 3200K range</div><div class="vl-note" contenteditable="true">Practical lamp sources + LiteMat gelled warm. Saturated not washed. Leave final decisions to grade.</div></div>
      <div class="vl-card"><div class="vl-label">LUT Strategy</div><div class="vl-value" contenteditable="true">TBD w/ Daniel Elder</div><div class="vl-note" contenteditable="true">Same LUT pipeline as V1 for consistency. May need separate grade treatment to achieve different contrast feel.</div></div>
    </div>
    <div class="section-title">Shot Size Definitions</div>
    <div class="vl-grid">
      <div class="vl-card"><div class="vl-label">XCU / Macro</div><div class="vl-note" contenteditable="true">Pencil tip on page. Graphite. Sharpener. Diopter territory. The grain of craft.</div></div>
      <div class="vl-card"><div class="vl-label">CU</div><div class="vl-note" contenteditable="true">Eyes squinting. Hands. The animator as instrument.</div></div>
      <div class="vl-card"><div class="vl-label">MS / OTS</div><div class="vl-note" contenteditable="true">Over-shoulder flat-on the animation. The reveal.</div></div>
      <div class="vl-card"><div class="vl-label">Wide</div><div class="vl-note" contenteditable="true">Animator from behind. Room as context ‚Äî dark edges, warm center. 32‚Äì40mm.</div></div>
    </div>
  </div>

  <div class="vl-panel" id="vl-shared">
    <div class="section-title" style="margin-top:0">Shared Visual Pillars</div>
    <div class="vl-card"><div class="vl-label">Pillars ‚Äî Both Videos</div><div class="vl-note" contenteditable="true">1. Motivated light sources only
2. Both videos skew warm ‚Äî different temperatures, same direction
3. Craft and texture as subject matter
4. Animation is emotion, not decoration (V1) / Animation is the product of human focus (V2)
5. Saturated ‚Äî Baumbach/Juno palette, not washed or desaturated
6. Atlas Mercury lenses: 32/50/75 set (to confirm with Lightstone)</div></div>
  </div>
  <div class="page-instructions"><div class="page-instructions-toggle" onclick="toggleInstructions(this)"><span class="pi-chevron">‚Ä∫</span><span class="pi-label">How to use this page</span></div><div class="pi-body"><div class="pi-row"><div class="pi-key">Three tabs</div><div class="pi-val">References, Stills, and Mood. References = director/DP alignment images. Stills = frame grabs from relevant films. Mood = color/texture/atmosphere images that inform the look.</div></div><div class="pi-row"><div class="pi-key">Adding images</div><div class="pi-val">Drag images from Finder onto the drop zone, or paste a URL. Each image gets a caption field ‚Äî use it for notes on what specifically you're referencing (color temp, lens quality, light quality, blocking, etc.).</div></div><div class="pi-row"><div class="pi-key">Two projects</div><div class="pi-val">Visual language for both videos lives here ‚Äî tag or caption images to indicate whether they're V1 (Performance), V2 (Genesis), or both.</div></div></div></div>
</div>

<!-- SCOUT -->
<div class="panel" id="panel-scout">
  <div class="panel-title">Scout Intelligence</div>
  <div class="panel-sub">Photos + videos analyzed ¬∑ EXIF extracted ¬∑ auto-categorized ¬∑ overhead generated</div>

  <div class="scout-toolbar">
    <button class="scout-filter-btn active" onclick="filterScout('all',this)">All (<span id="cnt-all">0</span>)</button>
    <button class="scout-filter-btn" onclick="filterScout('performance',this)">Performance (<span id="cnt-performance">0</span>)</button>
    <button class="scout-filter-btn" onclick="filterScout('genesis',this)">Genesis (<span id="cnt-genesis">0</span>)</button>
    <button class="scout-filter-btn" onclick="filterScout('unknown',this)">Untagged (<span id="cnt-unknown">0</span>)</button>
    <button class="scout-filter-btn" onclick="filterScout('duplicate',this)" style="border-color:var(--amber);color:var(--amber)">Duplicates (<span id="cnt-duplicate">0</span>)</button>
    <span style="margin-left:auto;font-size:10px;color:var(--text3)" id="scout-total-label">0 items</span>
  </div>

  <div class="inbox-drop" id="scout-drop" onclick="document.getElementById('scout-input').click()">
    <input type="file" id="scout-input" accept="image/*,video/*" multiple onchange="handleScoutUpload(event)">
    <div style="font-size:20px;margin-bottom:6px">‚äû</div>
    <div>Drop scout photos + videos here ¬∑ Images analyzed by Claude Vision ¬∑ Videos analyzed by Gemini</div>
    <div style="margin-top:4px;color:var(--text3);font-size:10px">EXIF metadata extracted automatically ¬∑ Duplicates flagged ¬∑ Full metadata card per image</div>
  </div>

  <div class="scout-grid-wrap" id="scout-card-grid"></div>

  <!-- OVERHEAD SECTION -->
  <div class="overhead-section">
    <div class="section-title" style="margin-top:0">Room Overhead ‚Äî AI Sketch</div>
    <div class="overhead-controls">
      <button class="btn sm" onclick="generateOverhead('performance')">‚äû Generate ‚Äî Performance (EXT. Backyard)</button>
      <button class="btn sm" onclick="generateOverhead('genesis')">‚äû Generate ‚Äî Genesis (INT. Studio)</button>
      <span style="font-size:10px;color:var(--text3)">Uses all analyzed photos for the selected scene ¬∑ click to redraw after corrections</span>
    </div>
    <div class="overhead-svg-wrap" id="overhead-output">
      <div style="text-align:center;color:var(--text3);font-size:11px;padding:30px">Upload and analyze scout photos first ‚Äî then click Generate to build the overhead sketch.</div>
    </div>
    <div class="correction-box" id="correction-box" style="display:none">
      <div style="font-size:10px;letter-spacing:1.5px;text-transform:uppercase;color:var(--text3);margin-bottom:6px">Corrections ‚Äî describe what's wrong or missing</div>
      <textarea id="correction-input" placeholder='e.g. "The room is actually 18 feet wide not 14. There are two windows on the north wall, not one. The door opens inward."'></textarea>
      <div style="margin-top:8px;display:flex;gap:8px">
        <button class="btn primary sm" onclick="redrawOverhead()">‚Ü∫ Redraw with Corrections</button>
        <button class="btn sm" onclick="document.getElementById('correction-box').style.display='none'">Cancel</button>
      </div>
    </div>
    <div class="overhead-status" id="overhead-status"></div>
  </div>

  <div class="page-instructions"><div class="page-instructions-toggle" onclick="toggleInstructions(this)"><span class="pi-chevron">‚Ä∫</span><span class="pi-label">How to use this page</span></div><div class="pi-body"><div class="pi-row"><div class="pi-key">Upload photos/video</div><div class="pi-val">Drag photos and videos from Finder or Photos app onto the drop zone. Images are analyzed by Claude Vision ‚Äî lens recommendations, lighting notes, blocking ideas. Videos are analyzed by Gemini 1.5 Pro, which watches the full clip and returns a scene breakdown.</div></div><div class="pi-row"><div class="pi-key">AI analysis</div><div class="pi-val">Each upload gets an automatic analysis card: what the AI saw, what it recommends, any flags it raised. Camera, lens, and lighting suggestions are tied to your specific package (Alexa 35, Atlas Mercury set, Nanlux 2400).</div></div><div class="pi-row"><div class="pi-key">Overhead sketch</div><div class="pi-val">Click Generate Overhead to produce an SVG floor plan from your scout photos. Shows camera positions, subject placement, light positions, and approximate dimensions. Editable after generation.</div></div><div class="pi-row"><div class="pi-key">Scout Intelligence</div><div class="pi-val">The system detects duplicate uploads, EXIF data from photos, and time-of-day from metadata. Multiple photos of the same location are grouped automatically.</div></div><div class="pi-row"><div class="pi-key">Persistence</div><div class="pi-val">Scout items and overhead sketches save to IndexedDB. They're there when you come back.</div></div></div></div>
</div>

<!-- CREW -->
<div class="panel" id="panel-crew">
  <div class="panel-title">Crew Repository</div>
  <div class="panel-sub">All roles across all departments ¬∑ click a name to open contact card ¬∑ cycle state to track availability</div>

  <div id="crew-dept-camera"></div>
  <div id="crew-dept-electric"></div>
  <div id="crew-dept-grip"></div>

  <div style="border-top:1px solid var(--border);margin-top:8px;padding-top:16px">
    <div class="section-title" style="margin-top:0">Above the Line ‚Äî Production Contacts</div>
    <div style="font-size:11px;color:var(--text3);margin-bottom:10px">Not your hires. Quick access + project history.</div>
    <div id="crew-dept-production"></div>
  </div>

  <div class="page-instructions"><div class="page-instructions-toggle" onclick="toggleInstructions(this)"><span class="pi-chevron">‚Ä∫</span><span class="pi-label">How to use this page</span></div><div class="pi-body"><div class="pi-row"><div class="pi-key">Role rows</div><div class="pi-val">Three departments ‚Äî Camera, Electric, Grip ‚Äî each with horizontal role strips. Every role (1st AC, DIT, Gaffer, Key Grip, Steadicam Op, etc.) has its own row. Scroll horizontally if there are multiple people in a role.</div></div><div class="pi-row"><div class="pi-key">State badges</div><div class="pi-val">Each crew card has a colored border and state button: <strong>green = Hired</strong>, <strong>gold = Available</strong>, <strong>red = Unavailable</strong>. Click the state button to cycle Available ‚Üí Unavailable ‚Üí Available. Set to Hired via the contact card.</div></div><div class="pi-row"><div class="pi-key">Contact card</div><div class="pi-val">Click any crew card to open the full contact overlay: role, name, phone, email, day rate, status, notes. Call or email directly from the card. Set state to Hired here. Changes save to IndexedDB and persist across sessions.</div></div><div class="pi-row"><div class="pi-key">Documents</div><div class="pi-val">Each contact card has a Documents section at the bottom. Drag a file (inventory list, insurance cert, resume, contract) onto the drop zone or click Browse. Auto-labeled by filename keywords. Stored with the crew member in IndexedDB. Click to download, ‚úï to remove.</div></div><div class="pi-row"><div class="pi-key">Hire ‚Üí checklist toast</div><div class="pi-val">When you mark someone Hired, a toast appears: "[Name] hired as [Role] ‚Äî mark checklist item done? ‚úì Yes / Later." Clicking Yes checks the linked checklist item and resolves the flag. Later dismisses without touching the checklist.</div></div><div class="pi-row"><div class="pi-key">Open role flags</div><div class="pi-val">Any unfilled role automatically generates a red flag on the Overview. Hiring someone for that role resolves the flag immediately.</div></div><div class="pi-row"><div class="pi-key">Adding via AI</div><div class="pi-val">Paste an iOS contact card or speak naturally ‚Äî "Add Marcus Webb as gaffer, $250/day, 323-555-0142." The AI extracts name, role, phone, email, rate, and proposes a crew add for your approval.</div></div><div class="pi-row"><div class="pi-key">VCF drag-drop</div><div class="pi-val">Drag a .vcf file from your Contacts app directly onto the AI command bar. It parses the contact and pre-fills the command ‚Äî press Enter to route through AI and add to crew.</div></div></div></div>
</div>

<!-- VENDORS -->
<div class="panel" id="panel-vendors">
  <div class="panel-title">Vendors</div>
  <div class="panel-sub">Rental houses and service contacts ¬∑ drag quote PDFs onto a card ¬∑ click Edit for contact details</div>
  <div id="vendor-list"></div>
  <div class="page-instructions"><div class="page-instructions-toggle" onclick="toggleInstructions(this)"><span class="pi-chevron">‚Ä∫</span><span class="pi-label">How to use this page</span></div><div class="pi-body"><div class="pi-row"><div class="pi-key">Vendor cards</div><div class="pi-val">Each vendor shows company name, contact person, and COI status. Lightstone Rentals is pre-seeded with Ryan Beardsley. Click any card to open the full contact overlay.</div></div><div class="pi-row"><div class="pi-key">COI status</div><div class="pi-val">Three states, cycled by clicking the COI button on the card: <strong>Needed</strong> (red) ‚Üí <strong>Submitted</strong> (amber) ‚Üí <strong>Confirmed</strong> (green). Confirming Lightstone's COI also checks the linked checklist item and resolves the flag on the Overview.</div></div><div class="pi-row"><div class="pi-key">Quote attachments</div><div class="pi-val">Drag a PDF quote onto the drop zone inside any vendor's card, or click Browse. Quotes are auto-versioned (v1, v2, Final if the filename contains "final"). Each quote shows version label, filename, date, and dollar amount if detected. Click to download.</div></div><div class="pi-row"><div class="pi-key">Quotes on Gear page</div><div class="pi-val">All attached quotes also appear in the Quotes section at the bottom of the Gear page, organized by vendor as clickable cards. Same data, second view ‚Äî no duplicate uploads needed.</div></div><div class="pi-row"><div class="pi-key">Adding vendors</div><div class="pi-val">Click the + Add Vendor card. Fill in company, contact, phone, email. Vendor appears in the Source dropdown on the Pull Sheet automatically.</div></div><div class="pi-row"><div class="pi-key">Vendor colors</div><div class="pi-val">Each vendor gets a persistent color in the Pull Sheet source dropdown. Luke's Truck is always green. Vendors are assigned colors in the order they were added (Lightstone = red, next = amber, etc.).</div></div></div></div>
</div>
<div class="panel" id="panel-gear">
  <div class="panel-title">Gear</div>
  <div class="panel-sub">Pull Sheet ‚Äî what's going to set for this job ¬∑ click any cell to edit ¬∑ Source = where it's coming from</div>

  <div id="pull-dept-camera"></div>
  <div id="pull-dept-electric"></div>
  <div id="pull-dept-grip"></div>

  <div class="section-title">Quotes</div>
  <div id="gear-quotes-section" style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:16px">
    <div style="font-size:10px;color:var(--text3);font-style:italic;padding:8px 0">No quotes attached yet ‚Äî attach PDFs to vendors on the Vendors page.</div>
  </div>

  <div class="page-instructions"><div class="page-instructions-toggle" onclick="toggleInstructions(this)"><span class="pi-chevron">‚Ä∫</span><span class="pi-label">How to use this page</span></div><div class="pi-body"><div class="pi-row"><div class="pi-key">Pull Sheet</div><div class="pi-val">Three department sections: Camera, Electric, Grip. This is the job-specific list ‚Äî what's going to set for Feb 27, not a permanent inventory. Items are pre-loaded from your camera package and rental plan.</div></div><div class="pi-row"><div class="pi-key">Inline editing</div><div class="pi-val">Click any cell (Item name, Qty, Video, Notes) to edit it in place. Type, then press Enter or Tab to move to the next cell. Press Escape to cancel. All edits save to IndexedDB immediately.</div></div><div class="pi-row"><div class="pi-key">Source column</div><div class="pi-val">Dropdown per row populated from your vendor list ‚Äî Luke's Truck, Lightstone, TBD, None, or any vendor you've added. Each vendor has a persistent color. Luke's Truck = green. Changing a source logs to the Decision Log.</div></div><div class="pi-row"><div class="pi-key">Priority column</div><div class="pi-val">Critical (red), High (amber), Low (gray). Rows sort by priority within each department section. Affects flag visibility for gear-related issues.</div></div><div class="pi-row"><div class="pi-key">Add / remove rows</div><div class="pi-val">Click <strong>+ Add [Dept] Item</strong> at the bottom of any section ‚Äî opens a new row immediately in edit mode. Click ‚úï on any row to delete it. Both actions log to the Decision Log.</div></div><div class="pi-row"><div class="pi-key">Quotes section</div><div class="pi-val">Below the pull sheet. Shows all PDFs attached to vendor cards, grouped by vendor ‚Äî company name, version label, date, amount. Click any quote card to download the file. Attach quotes on the Vendors page; they appear here automatically.</div></div><div class="pi-row"><div class="pi-key">AI command</div><div class="pi-val">"Add a Dana Dolly to grip, source Lightstone, priority high" ‚Äî approve the proposed change and it lands directly in the Grip section with the right source and priority set.</div></div></div></div>
</div>

<!-- BUDGET -->
<div class="panel" id="panel-budget">
  <div class="panel-title">Budget</div>
  <div class="panel-sub">Rental cost drivers + crew day rates</div>
  <div class="grid2">
    <div class="card"><div class="card-title">Est. Rental (1 day)</div><div class="card-val">$4‚Äì7K</div><div class="card-sub">Camera + lenses + Steadicam + lighting</div></div>
    <div class="card"><div class="card-title">Crew Labor (1 day)</div><div class="card-val">~$800</div><div class="card-sub">1st AC $200 ¬∑ DIT $400 ¬∑ Gaffer $200</div></div>
  </div>
  <div class="section-title">Crew Day Rates</div>
  <table class="gear-table">
    <thead><tr><th>Role</th><th>Day Rate</th><th>Status</th></tr></thead>
    <tbody>
      <tr><td>1st AC (TBD)</td><td class="rental">$200</td><td style="color:var(--red)">Role open</td></tr>
      <tr><td>DIT ‚Äî Daniel Elder</td><td class="rental">$400</td><td class="owned">Confirmed</td></tr>
      <tr><td>Gaffer (TBD)</td><td class="rental">$200</td><td style="color:var(--red)">Role open</td></tr>
      <tr><td>Steadicam Operator (TBD)</td><td class="tbd">Market rate</td><td style="color:var(--red)">Role open</td></tr>
    </tbody>
  </table>
  <div class="section-title">Rental Line Items</div>
  <table class="gear-table">
    <thead><tr><th>Item</th><th>Est. Day Rate</th><th>Video</th></tr></thead>
    <tbody>
      <tr><td>Alexa 35</td><td class="rental">$600‚Äì900</td><td>Both</td></tr>
      <tr><td>Atlas Mercury Set</td><td class="rental">$400‚Äì700</td><td>Both</td></tr>
      <tr><td>Steadicam Rig</td><td class="rental">$300‚Äì500</td><td>V1</td></tr>
      <tr><td>Steadicam Operator</td><td class="rental">$600‚Äì1200</td><td>V1</td></tr>
      <tr><td>Nanlux 2400</td><td class="rental">$200‚Äì400</td><td>V1</td></tr>
      <tr><td>LiteMat 4</td><td class="rental">$150‚Äì300</td><td>V2</td></tr>
      <tr><td>Diopters</td><td class="rental">$75‚Äì150</td><td>Both</td></tr>
      <tr><td>C-Stands √ó 3</td><td class="rental">$30‚Äì60</td><td>Both</td></tr>
      <tr><td>Alexa accessories</td><td class="rental">$150‚Äì300</td><td>Both</td></tr>
      <tr><td>All owned gear</td><td class="owned">$0</td><td>Both</td></tr>
    </tbody>
  </table>
  <div class="note-block" style="margin-top:14px"><strong>Upload a quote:</strong> Drop the Lightstone quote PDF in the Project Inbox ‚Äî Claude will parse line items and flag discrepancies.</div>

  <div class="page-instructions"><div class="page-instructions-toggle" onclick="toggleInstructions(this)"><span class="pi-chevron">‚Ä∫</span><span class="pi-label">How to use this page</span></div><div class="pi-body"><div class="pi-row"><div class="pi-key">Two cost buckets</div><div class="pi-val">Rental (camera, lenses, Steadicam, lighting, grip) and Crew Labor. Estimates are ballpark ‚Äî update as quotes come in from Lightstone and quotes are attached on the Vendors page.</div></div><div class="pi-row"><div class="pi-key">Not connected to gear</div><div class="pi-val">The budget panel is currently a static estimate ‚Äî it does not auto-calculate from the Pull Sheet. Update the figures manually as actuals come in. A future version may link these.</div></div></div></div>
</div>

<!-- INBOX -->
<div class="panel" id="panel-inbox">
  <div class="panel-title">Project Inbox</div>
  <div class="panel-sub">Drop any project material ‚Äî photos, PDFs, decks, reference videos</div>
  <div class="inbox-drop" onclick="document.getElementById('inbox-input').click()">
    <input type="file" id="inbox-input" accept="image/*,video/*,.pdf,.txt" multiple onchange="handleInboxUpload(event)">
    <div style="font-size:20px;margin-bottom:6px">‚¨°</div>
    <div>Drop files here ‚Äî scout photos, director references, quotes, decks</div>
    <div style="margin-top:4px;color:var(--text3);font-size:10px">Images analyzed by Claude Vision ¬∑ Videos logged ¬∑ PDFs logged for next version</div>
  </div>
  <div id="inbox-items"></div>
  <div class="note-block" style="margin-top:14px"><strong>iMessage workflow:</strong> On Mac, open Messages ‚Üí find the conversation ‚Üí right-click any photo/video ‚Üí Save to Photos. Then drag from Photos app directly onto the drop zone above. Or: right-click ‚Üí Share ‚Üí AirDrop to Mac ‚Üí drag from Downloads. Videos are logged here for manual review ‚Äî Claude can't watch video but records filename, source, and date for the decision log.</div>

  <div class="page-instructions"><div class="page-instructions-toggle" onclick="toggleInstructions(this)"><span class="pi-chevron">‚Ä∫</span><span class="pi-label">How to use this page</span></div><div class="pi-body"><div class="pi-row"><div class="pi-key">What goes here</div><div class="pi-val">Scout photos, director reference images, vendor quote PDFs, call sheets, contracts ‚Äî any file relevant to this job. Drag files onto the drop zone or click to browse. Not the same as Scout (which analyzes uploads); this is just storage and reference.</div></div><div class="pi-row"><div class="pi-key">Viewing files</div><div class="pi-val">Click any file card to preview images inline or download PDFs. Files are stored in IndexedDB and persist across sessions.</div></div></div></div>
</div>

<!-- DECISION LOG -->
<div class="panel" id="panel-log">
  <div class="panel-title">Decision Log</div>
  <div class="panel-sub">Every committed change ¬∑ append-only ¬∑ nothing overwrites</div>
  <div style="display:flex;gap:6px;margin-bottom:16px;flex-wrap:wrap;align-items:center">
    <span style="font-size:10px;letter-spacing:1px;text-transform:uppercase;color:var(--text3);margin-right:4px">Filter:</span>
    <button class="btn sm" id="log-filter-all" style="border-color:var(--gold2);color:var(--gold)" onclick="filterLog('all',this)">All</button>
    <button class="btn sm" id="log-filter-crew" onclick="filterLog('crew',this)">Crew</button>
    <button class="btn sm" id="log-filter-scene" onclick="filterLog('scene',this)">Scenes</button>
    <button class="btn sm" id="log-filter-gear" onclick="filterLog('gear',this)">Gear</button>
    <button class="btn sm" id="log-filter-vendor" onclick="filterLog('vendor',this)">Vendors</button>
    <button class="btn sm" id="log-filter-schedule" onclick="filterLog('schedule',this)">Schedule</button>
  </div>
  <div id="decision-log" class="decision-log">
    <div class="decision-entry" data-section="scene"><div class="decision-ts">Feb 17, 2026 ‚Äî Director Call</div><div class="decision-section">Project Structure</div><div class="decision-text">Two separate deliverables confirmed. Scene 1 (Performance ‚Äî EXT. BACKYARD) and Scene 2 (Genesis ‚Äî INT. ANIMATOR'S STUDIO). Not intercut. POC for a feature.</div></div>
    <div class="decision-entry" data-section="scene"><div class="decision-ts">Feb 17, 2026 ‚Äî Director Call</div><div class="decision-section">V2 Visual Reference</div><div class="decision-text">Director references: Baumbach, Juno. Saturated and warm ‚Äî NOT Little Miss Sunshine. Lamp island in a warm sea.</div></div>
    <div class="decision-entry" data-section="scene"><div class="decision-ts">Feb 17, 2026 ‚Äî DP Brief</div><div class="decision-section">V1 Lighting Strategy</div><div class="decision-text">Dawn-feel at 9‚Äì11AM: Nanlux 2400 gelled ¬º CTO as 3/4 back key. B7c on truck ‚Äî use only if practical source needed in frame.</div></div>
    <div class="decision-entry" data-section="crew"><div class="decision-ts">Feb 17, 2026 ‚Äî Crew Update</div><div class="decision-section">1st AC Availability</div><div class="decision-text">Tate Becherer unavailable for this project. Retained in crew repository. 1st AC role reopened ‚Äî replacement needed.</div></div>
    <div class="decision-entry" data-section="gear"><div class="decision-ts">Feb 17, 2026 ‚Äî Gear Clarification</div><div class="decision-section">Gear Roles</div><div class="decision-text">B7c confirmed on-truck practicals only. MC Pro preferred. Atlas Mercury 32/50/75 ‚Äî to verify with Lightstone.</div></div>
  </div>

  <div class="page-instructions"><div class="page-instructions-toggle" onclick="toggleInstructions(this)"><span class="pi-chevron">‚Ä∫</span><span class="pi-label">How to use this page</span></div><div class="pi-body"><div class="pi-row"><div class="pi-key">What this is</div><div class="pi-val">A timestamped, append-only record of every committed decision. Every action in the app ‚Äî checking a checklist item, hiring crew, editing gear, cycling COI status, moving a schedule item ‚Äî is logged automatically with a timestamp and category.</div></div><div class="pi-row"><div class="pi-key">Categories</div><div class="pi-val">Filter by: Crew, Checklist, Gear (Pull Sheet), Vendor, Schedule, Scene, or All. Use the filter buttons at the top of the panel. The log never deletes entries ‚Äî it's your paper trail for the job.</div></div><div class="pi-row"><div class="pi-key">AI commits</div><div class="pi-val">When you approve and commit AI-proposed changes, each approved item logs with the section and description you saw in the preview. The log is the source of truth for what changed and when.</div></div><div class="pi-row"><div class="pi-key">Persistence</div><div class="pi-val">Decision log entries save to localStorage and survive page reload. Up to 200 entries are retained, newest first. Timestamps include date and time of day.</div></div></div></div>
</div>

<!-- SETTINGS -->
<div class="panel" id="panel-settings">
  <div class="panel-title">API Keys</div>
  <div class="panel-sub">Keys stored in memory only ¬∑ never persisted ¬∑ cleared on tab close</div>

  <div class="section-title" style="margin-top:0">Anthropic ‚Äî Claude Vision + AI Command</div>
  <div class="api-key-row">
    <span class="api-key-label">API Key</span>
    <input class="api-key-input" type="password" id="setting-anthropic-key" placeholder="sk-ant-...">
    <button class="btn sm" onclick="saveKey('anthropic')">Save</button>
    <button class="btn sm" onclick="testKey('anthropic')">Test</button>
  </div>
  <div id="anthropic-key-status" style="font-size:10px;color:var(--text3);margin-left:88px;margin-bottom:10px"></div>
  <div class="note-block">Get at <strong>console.anthropic.com</strong> ‚Üí API Keys + Billing. Powers photo analysis, AI command bar, overhead sketch. Cents per session.</div>

  <div class="section-title">Gemini ‚Äî Video Analysis</div>
  <div class="api-key-row">
    <span class="api-key-label">API Key</span>
    <input class="api-key-input" type="password" id="setting-gemini-key" placeholder="AIza...">
    <button class="btn sm" onclick="saveKey('gemini')">Save</button>
    <button class="btn sm" onclick="testKey('gemini')">Test</button>
  </div>
  <div id="gemini-key-status" style="font-size:10px;color:var(--text3);margin-left:88px;margin-bottom:10px"></div>
  <div class="note-block">Get free at <strong>aistudio.google.com</strong> ‚Üí Get API Key. No billing needed for this use. Powers full video analysis ‚Äî Gemini 1.5 Pro watches the complete clip.</div>

  <div class="section-title">Status</div>
  <div class="grid2">
    <div class="card"><div class="card-title">Anthropic</div><div class="card-val" style="font-size:16px" id="val-anthropic-status">Not set</div><div class="card-sub">Claude Vision + AI Command</div></div>
    <div class="card"><div class="card-title">Gemini</div><div class="card-val" style="font-size:16px" id="val-gemini-status">Not set</div><div class="card-sub">Video analysis</div></div>
  </div>

  <div class="page-instructions"><div class="page-instructions-toggle" onclick="toggleInstructions(this)"><span class="pi-chevron">‚Ä∫</span><span class="pi-label">How to use this page</span></div><div class="pi-body"><div class="pi-row"><div class="pi-key">Anthropic key</div><div class="pi-val">Powers the AI command bar (plain-language updates to crew, gear, schedule) and Claude Vision (photo analysis in Scout). Get yours at console.anthropic.com ‚Üí API Keys. Paste it in, click Save ‚Äî you'll see "‚úì Saved" confirmation. The key persists to localStorage and loads automatically on every future session.</div></div><div class="pi-row"><div class="pi-key">Gemini key</div><div class="pi-val">Powers video analysis in Scout ‚Äî Gemini 1.5 Pro watches your full scout video clips and returns a scene breakdown. Get a free key at aistudio.google.com. Same save behavior as the Anthropic key.</div></div><div class="pi-row"><div class="pi-key">Test buttons</div><div class="pi-val">Click Test next to either key to verify it's working. The status card below updates to show Set ‚úì in green when active, or an error if the key is invalid or has no billing.</div></div><div class="pi-row"><div class="pi-key">Key security</div><div class="pi-val">Keys are stored in your browser's localStorage only ‚Äî never sent anywhere except directly to Anthropic and Google's APIs. No server, no account, no third party. The file runs entirely in your browser.</div></div></div></div>
</div>

<!-- COMMAND BAR -->
<div class="command-bar" id="command-bar"
  ondragover="event.preventDefault();this.classList.add('drag-over')"
  ondragleave="this.classList.remove('drag-over')"
  ondrop="handleCommandBarDrop(event)">
  <div class="command-bar-top">
    <span class="command-label">‚¨° AI Command</span>
    <input class="command-input" id="cmd-input" placeholder='Speak, type, or drag a .vcf contact card here ¬∑ "Add Sarah Kim, 1st AC, 323-555-0142, sarah@email.com"' onkeydown="if(event.key==='Enter')sendCommand()">
    <button class="cmd-btn" id="cmd-btn" onclick="sendCommand()">Send ‚Üí</button>
    <span class="cmd-hint">Enter ¬∑ drag .vcf ¬∑ changes logged on commit</span>
  </div>
  <div id="vcf-toast" style="display:none" class="vcf-parsed-toast"></div>
  <div class="command-preview" id="cmd-preview">
    <div class="preview-empty">Proposed changes appear here ‚Äî approve ‚úì, edit, or cancel ‚úï each one individually before committing. Drag a .vcf file anywhere on this bar to add a contact.</div>
  </div>
  <div class="commit-row">
    <button class="commit-btn" onclick="commitAll()">‚úì Commit Approved</button>
    <button class="clear-btn" onclick="clearPreview()">‚úï Clear</button>
    <span style="margin-left:auto;font-size:10px;color:var(--text3)">Committed changes are saved to the Decision Log</span>
  </div>
</div>

</div><!-- end app -->

<script>
const API_KEY = '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';
let API_KEY_LIVE = (()=>{ try{ return localStorage.getItem('apiKey_anthropic')||API_KEY; }catch(e){ return API_KEY; } })();
const PROJECT_CONTEXT = `You are the AI engine inside DP Helm HQ, a cinematographer's prep tool.

Project: Two separate videos (not intercut) ‚Äî POC for feature.
SCENE 1 "Performance Scene" EXT. BACKYARD ‚Äî DAY: Guitarist, Steadicam pull-out strings‚Üíworld, dawn-feel, 9-11AM LA.
SCENE 2 "Genesis Scene" INT. ANIMATOR'S STUDIO ‚Äî ~10 shot montage, warm Baumbach/Juno feel.
Camera: Alexa 35 + Atlas Mercury 32/50/75. Shoot Feb 27.
Crew: Camera (DIT=Daniel Elder $400/day confirmed; 1st AC=Tate UNAVAILABLE; 1st AC OPEN; Steadicam OPEN), Electric (Gaffer OPEN), Grip (Key Grip OPEN). All $200/day default.
Production contacts (above the line, not DP hires): Director OPEN, Producer OPEN.

CREW ADDITIONS ‚Äî CRITICAL RULES:
When the user mentions a person with a role (spoken naturally OR pasted iOS contact card), extract all info and return a crew add action.
iOS contact card format looks like: "First Last\nRole/Title\nemail@domain.com\n555-555-5555"
Spoken format: "Add [name] as [role], number is [phone], email is [email], rate is [rate]"
ALWAYS extract: name, role, phone, email, rate (if given), dept (camera/electric/grip/production)
Dept mapping: director/producer/ad/writer/pd ‚Üí production; gaffer/electric/best boy electric ‚Üí electric; key grip/grip/best boy grip ‚Üí grip; everything else ‚Üí camera

RESPONSE FORMAT ‚Äî return ONLY a raw JSON array, no preamble, no markdown:
[{"type":"add"|"update"|"flag","section":"Crew ‚Äî Camera"|"Crew ‚Äî Electric"|"Crew ‚Äî Grip"|"Crew ‚Äî Production","description":"human readable summary","crewData":{"dept":"camera"|"electric"|"grip"|"production","role":"exact role","name":"full name","phone":"number","email":"email","rate":"number only","status":"confirmed"|"pending"|"open"}}]

SCHEDULE ITEMS ‚Äî when user adds/moves schedule tasks:
{"type":"add","section":"Schedule","description":"human readable summary","scheduleData":{"date":"Feb 20","text":"Task description","urgent":false}}
Valid dates: Feb 17 through Feb 27. Match the date the user mentions. urgent:true only if user says urgent/critical/ASAP.

GEAR/PULL SHEET ‚Äî when user adds gear items:
{"type":"add","section":"Pull Sheet","description":"human readable summary","pullData":{"dept":"camera","item":"Item name","qty":"1","source":"Lightstone","priority":"high","notes":""}}
dept must be: camera, electric, or grip. source must match a vendor name or Luke's Truck or TBD.

For other updates (decisions, notes, flags), use section/description/detail only ‚Äî no extra data fields.
No preamble. Return ONLY the raw JSON array.`;

let pendingChanges = [];
let logFilter = 'all';

// DAYS OUT ‚Äî topbar + overview + sidebar
(function(){
  const shoot = new Date('2026-02-27');
  const today = new Date(); today.setHours(0,0,0,0);
  const diff = Math.ceil((shoot - today) / 86400000);
  const label = diff > 0 ? diff + ' days' : diff === 0 ? 'Today!' : 'Past';
  const tb = document.getElementById('topbar-daysout');
  if(tb) tb.textContent = label;
  const ov = document.getElementById('ov-daysout');
  if(ov) ov.textContent = label + ' out';
  const sb = document.getElementById('days-out');
  if(sb) sb.textContent = diff > 0 ? diff : 'Today!';
})();

// Schedule rendered by initSchedule() ‚Üí renderTimeline()

function showPanel(id,el){
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('panel-'+id).classList.add('active');
  if(el)el.classList.add('active');
}
function showVLTab(id,el){
  document.querySelectorAll('.vl-panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.vl-tab').forEach(t=>t.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if(el)el.classList.add('active');
}
// ============================================================
// CHECKLIST ‚Äî STANDARD + PROJECT-SPECIFIC, LINKED TO FLAGS
// ============================================================
// Each check item: data-flag-id links to a flag in flagStore

function toggleGroup(id){document.getElementById(id).classList.toggle('open');}

function saveChecklistState(){
  const state={};
  document.querySelectorAll('.check-group').forEach(group=>{
    const gid=group.id;
    state[gid]=[];
    group.querySelectorAll('.check-item').forEach((item,i)=>{
      if(item.classList.contains('done')) state[gid].push(i);
    });
  });
  try{ localStorage.setItem('checklist_state', JSON.stringify(state)); }catch(e){}
}

function loadChecklistState(){
  try{
    const saved=localStorage.getItem('checklist_state');
    if(!saved) return;
    const state=JSON.parse(saved);
    Object.keys(state).forEach(gid=>{
      const group=document.getElementById(gid);
      if(!group) return;
      const items=group.querySelectorAll('.check-item');
      state[gid].forEach(idx=>{
        if(items[idx]){
          items[idx].classList.add('done');
          const box=items[idx].querySelector('.check-box');
          if(box) box.textContent='‚úì';
        }
      });
    });
  }catch(e){}
}

function toggleCheck(el, groupId){
  el.classList.toggle('done');
  const box=el.querySelector('.check-box');
  box.textContent=el.classList.contains('done')?'‚úì':'';
  updateGroupStatus(groupId);
  updateChecklistPct();
  // Respect hide-completed toggle
  const hideToggle=document.getElementById('hide-completed-toggle');
  if(hideToggle&&hideToggle.checked&&el.classList.contains('done')) el.style.display='none';
  else el.style.display='';
  // Resolve/unresolve linked flag
  const flagId=el.dataset.flagId;
  if(flagId){
    if(el.classList.contains('done')) resolveFlag(flagId);
    else unresolveFlag(flagId);
  }
  // Log the action
  const checkText = el.querySelector('.check-text')?.childNodes[0]?.textContent?.trim() || el.querySelector('.check-text')?.textContent?.trim() || 'item';
  const isDone = el.classList.contains('done');
  logDecision('Checklist', `${isDone?'‚úì Checked':'‚óã Unchecked'}: ${checkText}`);
  // Special: if COI checklist item, sync vendor COI state
  if(el.dataset.coiVendor){
    syncVendorCOI(el.dataset.coiVendor, el.classList.contains('done'));
  }
  saveChecklistState();
}


function toggleHideCompleted(hide){
  document.querySelectorAll('.check-item.done').forEach(el=>{
    el.style.display=hide?'none':'';
  });
  // Store preference
  try{ localStorage.setItem('hideCompleted', hide?'1':''); }catch(e){}
}

function updateGroupStatus(groupId){
  if(!groupId) return;
  const group=document.getElementById(groupId);
  if(!group) return;
  const items=group.querySelectorAll('.check-item');
  const done=group.querySelectorAll('.check-item.done');
  const total=items.length, doneCount=done.length;
  const rag=document.getElementById('rag-'+groupId);
  const meta=document.getElementById('meta-'+groupId);
  if(meta) meta.textContent=doneCount+' of '+total;
  if(rag){
    rag.className='rag';
    if(doneCount===0) rag.classList.add('red');
    else if(doneCount===total) rag.classList.add('green');
    else rag.classList.add('yellow');
  }
}

function updateChecklistPct(){
  const all=document.querySelectorAll('.check-item'),done=document.querySelectorAll('.check-item.done');
  const total=all.length, doneCount=done.length;
  const pct=total?Math.round(doneCount/total*100):0;
  const pctStr=pct+'%';
  const el=document.getElementById('checklist-pct'); if(el) el.textContent=pctStr;
  const ovPrep=document.getElementById('ov-prep'); if(ovPrep) ovPrep.textContent=pctStr;
  // Update overview RAG dot
  const ragEl=document.getElementById('ov-prep-rag');
  if(ragEl){
    ragEl.className='rag';
    if(pct===0) ragEl.classList.add('red');
    else if(pct===100) ragEl.classList.add('green');
    else ragEl.classList.add('yellow');
  }
}

function initChecklist(){
  loadChecklistState();
  const groups=['cg-crew','cg-rental','cg-coi','cg-locations','cg-tech','cg-schedule'];
  groups.forEach(id=>updateGroupStatus(id));
  updateChecklistPct();
  // Also restore flags for pre-checked items
  document.querySelectorAll('.check-item.done[data-flag-id]').forEach(el=>{
    resolveFlag(el.dataset.flagId);
  });
}



// ============================================================
// UNIFIED FLAG SYSTEM
// ============================================================
// Every flag: {id, text, dept, severity, source, resolved, checkItemId}
// dept: camera|electric|grip|vendor|location|schedule|general
// severity: red|amber
// source: auto|checklist|manual

let flagStore = {};

function flagSave(f){ dbSave('flags', f); flagStore[f.id]=f; }
function flagDelete(id){ dbDelete('flags', id); delete flagStore[id]; }

async function initFlags(){
  // Always seed from code-defined defaults (so flag definitions are always current)
  // Then overlay persisted resolved states from IDB
  seedDefaultFlags();
  let saved=[];
  try{ saved=await dbGetAll('flags'); }catch(e){}
  if(saved&&saved.length>0){
    saved.forEach(f=>{
      // Only carry over the resolved state ‚Äî not the entire flag (avoids stale text/IDs)
      if(flagStore[f.id]) flagStore[f.id].resolved = f.resolved;
    });
    // Persist the fresh seeded flags back to IDB
    Object.values(flagStore).forEach(f=>flagSave(f));
  }
  renderFlags();
}

function seedDefaultFlags(){
  const defaults=[
    {id:'flag-crew-1stacfocuspuller', text:'1st AC open ‚Äî Tate unavailable, replacement needed', dept:'camera',   severity:'red',   source:'auto',   resolved:false},
    {id:'flag-steadicam',             text:'Steadicam operator not locked ‚Äî critical path V1',   dept:'camera',   severity:'red',   source:'auto',   resolved:false},
    {id:'flag-crew-gaffer',           text:'Gaffer ‚Äî no one hired for this project',             dept:'electric', severity:'red',   source:'auto',   resolved:false},
    {id:'flag-v2loc',                 text:"INT. ANIMATOR'S STUDIO location TBD",                dept:'location', severity:'red',   source:'manual', resolved:false},
    {id:'flag-nanlux',                text:'Nanlux 2400 on 20A circuit ‚Äî confirm or swap',       dept:'electric', severity:'amber', source:'manual', resolved:false},
    {id:'flag-diopter',               text:'Diopter + Mercury compatibility ‚Äî test before lock', dept:'camera',   severity:'amber', source:'manual', resolved:false},
    {id:'flag-codec',                 text:'Animation codec TBC ‚Äî ProRes 4444 or RAW?',         dept:'camera',   severity:'amber', source:'manual', resolved:false},
    {id:'flag-daniel-email',          text:'Daniel Elder email not yet captured',                dept:'camera',   severity:'amber', source:'auto',   resolved:false},
    {id:'flag-v2tod',                 text:'V2 time of day TBD ‚Äî affects window control + lighting', dept:'schedule', severity:'amber', source:'manual', resolved:false},
    {id:'flag-coi-lightstone',        text:'COI not submitted to Lightstone Rentals',           dept:'vendor',   severity:'red',   source:'auto',   resolved:false},
  ];
  defaults.forEach(f=>{ flagStore[f.id]=f; flagSave(f); });
}

function resolveFlag(id){
  if(!flagStore[id]) return;
  flagStore[id].resolved=true;
  flagSave(flagStore[id]);
  renderFlags();
}

function unresolveFlag(id){
  if(!flagStore[id]) return;
  flagStore[id].resolved=false;
  flagSave(flagStore[id]);
  renderFlags();
}

function addFlag(f){
  if(!f.id) f.id='flag-'+Date.now();
  f.resolved=false;
  flagStore[f.id]=f;
  flagSave(f);
  renderFlags();
}

// Auto-sync crew open roles ‚Üí flags
function syncCrewFlags(){
  const depts=['camera','electric','grip'];
  depts.forEach(dept=>{
    const cfg=DEPT_CONFIG[dept];
    cfg.roles.forEach(role=>{
      const hired=Object.values(crewStore).find(m=>
        m.dept===dept && normalizeRole(m.role)===normalizeRole(role) && m.state==='hired'
      );
      const flagId='flag-crew-'+normalizeRole(role);
      if(!hired){
        // Ensure flag exists and is unresolved
        if(!flagStore[flagId]){
          const deptMap={camera:'camera',electric:'electric',grip:'grip'};
          flagStore[flagId]={id:flagId, text:`${role} ‚Äî no one hired`, dept:deptMap[dept]||dept, severity:'red', source:'auto', resolved:false};
          flagSave(flagStore[flagId]);
        } else if(flagStore[flagId].resolved){
          flagStore[flagId].resolved=false;
          flagSave(flagStore[flagId]);
        }
      } else {
        // Mark resolved
        if(flagStore[flagId]&&!flagStore[flagId].resolved){
          flagStore[flagId].resolved=true;
          flagSave(flagStore[flagId]);
        }
      }
    });
  });
  renderFlags();
}

const DEPT_COLORS={
  camera:  {border:'#4a9eff', label:'Camera'},
  electric:{border:'var(--gold2)', label:'Electric'},
  grip:    {border:'#888', label:'Grip'},
  vendor:  {border:'#b47fcc', label:'Vendor'},
  location:{border:'#4acccc', label:'Location'},
  schedule:{border:'#4acccc', label:'Schedule'},
  general: {border:'var(--border2)', label:'General'},
};

// renderFlags() defined below in navigation module



// ============================================================
// VENDOR SYSTEM ‚Äî CONTACT CARD + QUOTES + COI + INDEXEDDB
// ============================================================

let vendorStore = {};

const VENDOR_DEFAULTS = [
  {id:'vendor-lightstone', name:'Lightstone Rentals', contact:'Ryan Beardsley', phone:'', email:'', notes:'Primary rental house ¬∑ Alexa 35, lenses, grip, electric', coi:'pending', quotes:[]},
];

function vendorDBSave(v){ dbSave('vendors', v); vendorStore[v.id]=v; }
function vendorDBDelete(id){ dbDelete('vendors', id); delete vendorStore[id]; }

async function initVendors(){
  let saved=[];
  try{ saved=await dbGetAll('vendors'); }catch(e){}
  if(saved&&saved.length>0){
    saved.forEach(v=>{ vendorStore[v.id]=v; });
  } else {
    VENDOR_DEFAULTS.forEach(v=>{ vendorStore[v.id]={...v}; vendorDBSave({...v}); });
  }
  renderAllVendors();
}

function renderAllVendors(){
  const container=document.getElementById('vendor-list');
  if(!container) return;
  container.innerHTML='';
  Object.values(vendorStore).forEach(v=>{
    container.appendChild(buildVendorCard(v));
  });
  // Add card
  const addCard=document.createElement('div');
  addCard.className='vendor-add-card';
  addCard.innerHTML='<span style="font-size:20px;color:var(--gold2)">+</span><span style="font-size:10px;color:var(--text3);letter-spacing:.5px">Add Vendor</span>';
  addCard.onclick=()=>openVendorCard(null);
  container.appendChild(addCard);
  renderOverviewVendors();
  renderGearQuotes();
}

function buildVendorCard(v){
  const coiColor=v.coi==='submitted'?'var(--green)':v.coi==='confirmed'?'var(--green)':'var(--red)';
  const coiLabel=v.coi==='submitted'?'COI Submitted ‚úì':v.coi==='confirmed'?'COI Confirmed ‚úì':'COI Needed';
  const quoteSummary=v.quotes&&v.quotes.length
    ?v.quotes.map(q=>`<span style="font-size:9px;background:var(--s2);border:1px solid var(--border2);padding:2px 6px;margin-right:4px;color:var(--text2)">${q.label||'Quote'} ${q.date?'¬∑ '+q.date:''} ${q.amount?'¬∑ $'+q.amount:''}</span>`).join('')
    :'<span style="font-size:9px;color:var(--text3)">No quotes attached</span>';

  const card=document.createElement('div');
  card.className='vendor-card-v2';
  card.id='vc-'+v.id;
  card.innerHTML=`
    <div class="vendor-card-header">
      <div>
        <div class="vendor-name">${v.name}</div>
        ${v.contact?`<div style="font-size:11px;color:var(--text2);margin-top:2px">${v.contact}</div>`:''}
      </div>
      <div style="display:flex;gap:6px;align-items:center">
        ${v.phone?`<a href="tel:${v.phone.replace(/\D/g,'')}" style="font-size:9px;color:var(--text3);text-decoration:none;border:1px solid var(--border2);padding:3px 7px" onclick="event.stopPropagation()">üìû</a>`:''}
        ${v.email?`<a href="mailto:${v.email}" style="font-size:9px;color:var(--text3);text-decoration:none;border:1px solid var(--border2);padding:3px 7px" onclick="event.stopPropagation()">‚úâ</a>`:''}
        <button class="vendor-edit-btn" onclick="openVendorCard('${v.id}')">Edit</button>
      </div>
    </div>
    <div class="vendor-coi-row">
      <div class="vendor-coi-dot" style="background:${coiColor}"></div>
      <span style="font-size:11px;color:${coiColor}">${coiLabel}</span>
      ${v.coi!=='confirmed'?`<button class="btn sm" style="margin-left:8px" onclick="event.stopPropagation();cycleVendorCOI('${v.id}')">Mark Submitted</button>`:`<button class="btn sm" style="margin-left:8px;color:var(--text3)" onclick="event.stopPropagation();cycleVendorCOI('${v.id}')">Unmark</button>`}
    </div>
    <div class="vendor-quotes-row" id="quotes-row-${v.id}">${quoteSummary}</div>
    <div class="vendor-drop-zone" id="drop-${v.id}"
      ondragover="event.preventDefault();this.classList.add('drag-over')"
      ondragleave="this.classList.remove('drag-over')"
      ondrop="handleQuoteDrop(event,'${v.id}')">
      Drop quote PDF here
      <input type="file" accept=".pdf,.jpg,.jpeg,.png" style="display:none" id="qfile-${v.id}" onchange="handleQuoteFile(this,'${v.id}')">
      <button class="vendor-upload-btn" onclick="event.stopPropagation();document.getElementById('qfile-${v.id}').click()">Browse</button>
    </div>
    ${v.notes?`<div style="font-size:10px;color:var(--text3);margin-top:8px;font-style:italic">${v.notes}</div>`:''}`;
  return card;
}

function cycleVendorCOI(vendorId){
  const v=vendorStore[vendorId];
  if(!v) return;
  const cycle={pending:'submitted',submitted:'confirmed',confirmed:'pending'};
  v.coi=cycle[v.coi]||'pending';
  vendorDBSave(v);
  // Sync flag
  if(v.coi==='pending') unresolveFlag('flag-coi-'+vendorId.replace('vendor-',''));
  else resolveFlag('flag-coi-'+vendorId.replace('vendor-',''));
  logDecision('Vendor/COI',`${v.name} COI status: ${v.coi}`);
  renderAllVendors();
}

function syncVendorCOI(vendorId, submitted){
  const v=vendorStore[vendorId];
  if(!v) return;
  v.coi=submitted?'submitted':'pending';
  vendorDBSave(v);
  renderAllVendors();
}

// Quote attachment
function handleQuoteDrop(e, vendorId){
  e.preventDefault();
  e.target.closest('.vendor-drop-zone').classList.remove('drag-over');
  const files=[...e.dataTransfer.files];
  files.forEach(f=>attachQuoteFile(f,vendorId));
}
function handleQuoteFile(input, vendorId){
  [...input.files].forEach(f=>attachQuoteFile(f,vendorId));
}

function attachQuoteFile(file, vendorId){
  const v=vendorStore[vendorId];
  if(!v) return;
  if(!v.quotes) v.quotes=[];
  // Determine version label
  const vNum=v.quotes.length+1;
  const isLikelyFinal=file.name.toLowerCase().includes('final');
  const label=isLikelyFinal?'Final':`v${vNum}`;
  const date=new Date().toLocaleDateString('en-US',{month:'short',day:'numeric'});
  const reader=new FileReader();
  reader.onload=e=>{
    // Store as dataURL for PDF ‚Äî just filename + metadata for display
    const quote={id:'q-'+Date.now(), label, filename:file.name, date, amount:'', dataURL:null, type:file.type};
    // Only store dataURL for images (PDFs too large for IDB if many)
    if(file.type.startsWith('image/')){
      quote.dataURL=e.target.result;
    } else {
      // For PDF: store filename reference + base64 for download
      quote.dataURL=e.target.result; // store it ‚Äî user can download
    }
    v.quotes.push(quote);
    vendorDBSave(v);
    logDecision('Vendor',`Quote attached to ${v.name}: ${file.name} (${label})`);
    renderAllVendors();
    renderGearQuotes();
  };
  reader.readAsDataURL(file);
}

// VENDOR CONTACT CARD OVERLAY
let _vcId=null;

function openVendorCard(id){
  _vcId=id;
  const v=id?vendorStore[id]:null;
  document.getElementById('vc-title').textContent=v?v.name:'New Vendor';
  document.getElementById('vc-company').value=v?.name||'';
  document.getElementById('vc-contact').value=v?.contact||'';
  document.getElementById('vc-phone').value=v?.phone||'';
  document.getElementById('vc-email').value=v?.email||'';
  document.getElementById('vc-notes').value=v?.notes||'';
  document.getElementById('vc-call-btn').style.display=v?.phone?'':'none';
  document.getElementById('vc-email-btn').style.display=v?.email?'':'none';
  document.getElementById('vendor-overlay').classList.add('show');
}

function closeVendorCard(){
  document.getElementById('vendor-overlay').classList.remove('show');
  _vcId=null;
}

function saveVendorCard(){
  const name=document.getElementById('vc-company').value.trim();
  if(!name){closeVendorCard();return;}
  if(_vcId&&vendorStore[_vcId]){
    const v=vendorStore[_vcId];
    v.name=name;
    v.contact=document.getElementById('vc-contact').value.trim();
    v.phone=document.getElementById('vc-phone').value.trim();
    v.email=document.getElementById('vc-email').value.trim();
    v.notes=document.getElementById('vc-notes').value.trim();
    vendorDBSave(v);
    logDecision('Vendor',`Updated ${v.name}`);
  } else {
    const id='vendor-'+Date.now();
    const v={id,name,contact:document.getElementById('vc-contact').value.trim(),
      phone:document.getElementById('vc-phone').value.trim(),email:document.getElementById('vc-email').value.trim(),
      notes:document.getElementById('vc-notes').value.trim(),coi:'pending',quotes:[]};
    vendorStore[id]=v;
    vendorDBSave(v);
    logDecision('Vendor',`Added vendor: ${name}`);
  }
  closeVendorCard();
  renderAllVendors();
}

function removeVendorCard(){
  if(!_vcId) return;
  const v=vendorStore[_vcId];
  showModal('Remove Vendor?',`Remove ${v?.name||'this vendor'} entirely?`,()=>{
    vendorDBDelete(_vcId);closeModal();closeVendorCard();renderAllVendors();
    logDecision('Vendor',`Removed ${v?.name}`);
  });
}

function addVendor(){
  const name=document.getElementById('nv-name')?.value.trim();
  if(!name) return;
  const id='vendor-'+Date.now();
  const v={id,name,contact:document.getElementById('nv-contact')?.value.trim()||'',
    phone:document.getElementById('nv-phone')?.value.trim()||'',
    email:document.getElementById('nv-email')?.value.trim()||'',
    notes:document.getElementById('nv-notes')?.value.trim()||'',coi:'pending',quotes:[]};
  vendorStore[id]=v;vendorDBSave(v);
  ['nv-name','nv-contact','nv-phone','nv-email','nv-notes'].forEach(i=>{const el=document.getElementById(i);if(el)el.value='';});
  logDecision('Vendor',`Added vendor: ${name}`);
  renderAllVendors();
}

function renderOverviewVendors(){
  const container=document.getElementById('ov-vendors');
  if(!container) return;
  container.innerHTML='';
  Object.values(vendorStore).forEach(v=>{
    const card=document.createElement('div');
    card.className='crew-card-v3 is-available';
    card.style.cssText='width:auto;min-width:130px;cursor:pointer';
    const coiDot=v.coi==='confirmed'||v.coi==='submitted'?'<span style="color:var(--green);font-size:9px">COI ‚úì</span>':'<span style="color:var(--red);font-size:9px">COI needed</span>';
    card.innerHTML=`<div class="crew-card-v3-role">Vendor</div><div class="crew-card-v3-name" style="cursor:pointer">${v.name}</div>${v.contact?`<div style="font-size:9px;color:var(--text3)">${v.contact}</div>`:''}${coiDot}`;
    card.onclick=()=>{showPanel('vendors',null);setTimeout(()=>openVendorCard(v.id),150);};
    container.appendChild(card);
  });
}



// ============================================================
// CREW v3 ‚Äî ROLE ROWS + CONTACT CARD OVERLAY
// ============================================================

const DEPT_CONFIG = {
  camera: {
    label: 'üì∑ Camera',
    roles: ['Camera Operator','1st AC / Focus Puller','2nd AC','DIT','Utility']
  },
  electric: {
    label: '‚ö° Electric',
    roles: ['Gaffer','Best Boy Electric','Juicer']
  },
  grip: {
    label: 'üîß Grip',
    roles: ['Key Grip','Best Boy Grip','Grip']
  },
  production: {
    label: 'Production Contacts',
    roles: ['Director','Producer / UPM','Production Designer','Writer','AD']
  }
};

const CREW_DEFAULTS = [
  {id:'crew-daniel', dept:'camera', role:'DIT', name:'Daniel Elder', phone:'952-715-0053', email:'', rate:'400', state:'hired', notes:'Confirmed $400/day'},
  {id:'crew-tate', dept:'camera', role:'1st AC / Focus Puller', name:'Tate Becherer', phone:'502-751-9193', email:'tateb.camera@gmail.com', rate:'200', state:'unavailable', notes:'Unavailable for this project'},
];

let crewStore = {}; // id ‚Üí member

function crewDBSave(m){ dbSave('crew', m); crewStore[m.id]=m; }
function crewDBDelete(id){ dbDelete('crew', id); delete crewStore[id]; }

async function initCrew(){
  let saved=[];
  try{ saved=await dbGetAll('crew'); }catch(e){}
  if(saved&&saved.length>0){
    saved.forEach(m=>{ crewStore[m.id]=m; });
  } else {
    CREW_DEFAULTS.forEach(m=>{ crewStore[m.id]={...m}; crewDBSave({...m}); });
  }
  renderAllCrew();
}

// ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function renderAllCrew(){
  ['camera','electric','grip','production'].forEach(dept=>{
    const container=document.getElementById('crew-dept-'+dept);
    if(!container) return;
    const cfg=DEPT_CONFIG[dept];
    container.innerHTML='';
    // Dept header
    const hdr=document.createElement('div');
    hdr.className='section-title';
    hdr.style.marginTop= dept==='camera'?'0':'';
    hdr.textContent=cfg.label;
    container.appendChild(hdr);
    // Role rows
    cfg.roles.forEach(role=>{
      const row=document.createElement('div');
      row.className='crew-role-row';
      const lbl=document.createElement('div');
      lbl.className='crew-role-label';
      lbl.textContent=role;
      row.appendChild(lbl);
      const strip=document.createElement('div');
      strip.className='crew-role-strip';
      strip.id='strip-'+dept+'-'+role.replace(/[^a-z]/gi,'_');
      // Get members for this role, sorted: hired first, available, unavailable
      const members=Object.values(crewStore)
        .filter(m=>m.dept===dept && normalizeRole(m.role)===normalizeRole(role))
        .sort((a,b)=>{
          const order={hired:0,available:1,unavailable:2,unknown:3};
          return (order[a.state]??3)-(order[b.state]??3);
        });
      const hasHired=members.some(m=>m.state==='hired');
      // Open placeholder ‚Äî show if no one is hired
      if(!hasHired){
        strip.appendChild(buildOpenCard(dept,role));
      }
      members.forEach(m=>strip.appendChild(buildCrewCardV3(m)));
      // Add + card
      strip.appendChild(buildAddPersonCard(dept,role));
      row.appendChild(strip);
      container.appendChild(row);
    });
  });
  renderOverviewCrew();
  // Sync open-role flags after render
  if(typeof syncCrewFlags==='function') syncCrewFlags();
}

function normalizeRole(r){
  return (r||'').toLowerCase().replace(/[^a-z0-9]/g,'');
}

function buildCrewCardV3(m){
  const card=document.createElement('div');
  const stateClass=m.state==='hired'?'is-hired':m.state==='unavailable'?'is-unavailable':m.state==='available'?'is-available':'is-unknown';
  card.className='crew-card-v3 '+stateClass;
  card.id='cv3-'+m.id;

  const stateLabel=m.state==='hired'?'Hired ‚úì':m.state==='unavailable'?'Unavailable':m.state==='available'?'Available':'Unknown';
  const stateBtnClass=m.state==='hired'?'hired':m.state==='unavailable'?'unavailable':m.state==='available'?'available':'unknown';

  card.innerHTML=`
    <div class="crew-card-v3-role">${m.role}</div>
    <div class="crew-card-v3-name" onclick="openContactCard('${m.id}')" title="Click to open contact card">${m.name}</div>
    ${m.rate?`<div style="font-size:9px;color:var(--text3);margin-bottom:4px">$${m.rate}/day</div>`:''}
    <button class="crew-state-btn ${stateBtnClass}" onclick="event.stopPropagation();cycleCrewState('${m.id}')">${stateLabel}</button>`;
  return card;
}

function buildOpenCard(dept,role){
  const card=document.createElement('div');
  card.className='crew-card-v3 is-open';
  card.innerHTML=`<div class="crew-open-card"><span class="crew-open-plus">‚óã</span><span class="crew-open-label">Open<br>${role}</span></div>`;
  card.onclick=()=>focusCommandWithHint(`Add [name] as ${role}`);
  return card;
}

function buildAddPersonCard(dept,role){
  const card=document.createElement('div');
  card.className='crew-card-v3 is-open';
  card.style.opacity='.4';
  card.innerHTML=`<div class="crew-open-card"><span class="crew-open-plus" style="font-size:22px;color:var(--gold2)">+</span><span class="crew-open-label">Add to<br>${role}</span></div>`;
  card.onclick=()=>focusCommandWithHint(`Add [name] as ${role} in ${dept}, phone: [number], email: [email]`);
  return card;
}

// ‚îÄ‚îÄ STATE CYCLING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function cycleCrewState(id){
  const m=crewStore[id];
  if(!m) return;
  // Cycle: available ‚Üí unavailable ‚Üí available (hired stays hired until changed in contact card)
  const cycle={unknown:'available',available:'unavailable',unavailable:'available',hired:'available'};
  const prev=m.state;
  m.state=cycle[m.state]||'available';
  crewDBSave(m);
  logDecision('Crew',`${m.name||m.role} state: ${prev} ‚Üí ${m.state}`);
  renderAllCrew();
}

// ‚îÄ‚îÄ CONTACT CARD OVERLAY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

let _contactCardId = null;
let _contactCardState = 'available';

function openContactCard(id){
  const m=crewStore[id];
  if(!m) return;
  _contactCardId=id;
  _contactCardState=m.state||'available';
  document.getElementById('cc-title').textContent=m.name||m.role||'Contact';
  document.getElementById('cc-role').value=m.role||'';
  document.getElementById('cc-name').value=m.name||'';
  document.getElementById('cc-phone').value=m.phone||'';
  document.getElementById('cc-email').value=m.email||'';
  document.getElementById('cc-rate').value=m.rate||'';
  document.getElementById('cc-notes').value=m.notes||'';
  setContactState(m.state||'available');
  // Show call/email buttons if info exists
  document.getElementById('cc-call-btn').style.display=m.phone?'':'none';
  document.getElementById('cc-email-btn').style.display=m.email?'':'none';
  renderCrewDocsList(id);
  document.getElementById('contact-overlay').classList.add('show');
}

function openNewContactCard(dept,role){
  _contactCardId='new-'+Date.now();
  _contactCardState='available';
  document.getElementById('cc-title').textContent='New '+role;
  document.getElementById('cc-role').value=role;
  document.getElementById('cc-name').value='';
  document.getElementById('cc-phone').value='';
  document.getElementById('cc-email').value='';
  document.getElementById('cc-rate').value='200';
  document.getElementById('cc-notes').value='';
  setContactState('available');
  document.getElementById('cc-call-btn').style.display='none';
  document.getElementById('cc-email-btn').style.display='none';
  // Store dept for saving
  document.getElementById('contact-overlay').dataset.dept=dept;
  renderCrewDocsList('');
  document.getElementById('contact-overlay').classList.add('show');
}

function closeContactCard(){
  document.getElementById('contact-overlay').classList.remove('show');
  _contactCardId=null;
}

function setContactState(state){
  _contactCardState=state;
  ['hired','available','unavailable'].forEach(s=>{
    const btn=document.getElementById('cs-'+s);
    if(btn) btn.className='contact-state-opt '+s+(s===state?' active':'');
  });
}

function saveContactCard(){
  const role=document.getElementById('cc-role').value.trim();
  const name=document.getElementById('cc-name').value.trim();
  const phone=document.getElementById('cc-phone').value.trim();
  const email=document.getElementById('cc-email').value.trim();
  const rate=document.getElementById('cc-rate').value.trim();
  const notes=document.getElementById('cc-notes').value.trim();
  if(!name&&!role){closeContactCard();return;}

  if(_contactCardId&&crewStore[_contactCardId]){
    // Update existing
    const m=crewStore[_contactCardId];
    const prevState=m.state;
    m.role=role||m.role;m.name=name;m.phone=phone;m.email=email;m.rate=rate;m.notes=notes;m.state=_contactCardState;
    crewDBSave(m);
    logDecision('Crew',`Updated ${name||role} ‚Äî ${role}, ${_contactCardState}${rate?' ¬∑ $'+rate+'/day':''}`);
    // Auto-resolve email flag if email is now filled
    if(email && flagStore['flag-daniel-email'] && (m.id==='crew-daniel' || name.toLowerCase().includes('daniel elder'))){
      resolveFlag('flag-daniel-email');
    } else if(!email && m.id==='crew-daniel'){
      unresolveFlag('flag-daniel-email');
    }
    // Toast if newly hired
    if(_contactCardState==='hired'&&prevState!=='hired') showHireToast(m);
  } else {
    // New member
    const dept=document.getElementById('contact-overlay').dataset.dept||guessDept(role);
    const id='crew-'+Date.now();
    const m={id,dept,role,name,phone,email,rate,notes,state:_contactCardState};
    crewStore[id]=m;
    crewDBSave(m);
    logDecision('Crew',`Added ${name} as ${role}${rate?' ¬∑ $'+rate+'/day':''}`);
  }
  closeContactCard();
  renderAllCrew();
}

function removeContactCard(){
  if(!_contactCardId||!crewStore[_contactCardId]) return;
  const m=crewStore[_contactCardId];
  showModal('Remove '+( m.name||m.role)+'?','Remove from crew repository entirely?',()=>{
    crewDBDelete(_contactCardId);
    closeModal();closeContactCard();renderAllCrew();
    logDecision('Crew',`Removed ${m.name||m.role} from repository.`);
  });
}

function callContact(){
  const phone=document.getElementById('cc-phone').value.trim();
  if(phone) window.location='tel:'+phone.replace(/\D/g,'');
}
function emailContact(){
  const email=document.getElementById('cc-email').value.trim();
  if(email) window.location='mailto:'+email;
}

function guessDept(role){
  const r=(role||'').toLowerCase();
  if(r.includes('director')||r.includes('producer')||r.includes('writer')||r.includes(' ad')||r.includes('designer')) return 'production';
  if(r.includes('gaffer')||r.includes('electric')||r.includes('juicer')||r.includes('best boy e')) return 'electric';
  if(r.includes('grip')||r.includes('key grip')) return 'grip';
  return 'camera';
}

// ‚îÄ‚îÄ DATA API (for AI command) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function addCrewMemberData(data){
  const dept=data.dept||guessDept(data.role);
  // Try to fill an existing empty slot first
  const match=Object.values(crewStore).find(m=>
    m.dept===dept && !m.name &&
    normalizeRole(m.role)===normalizeRole(data.role)
  );
  if(match){
    match.name=data.name||'';match.phone=data.phone||'';match.email=data.email||'';
    match.rate=data.rate||match.rate||'200';match.state=data.status==='confirmed'?'hired':data.status||'available';
    if(data.notes) match.notes=data.notes;
    crewDBSave(match);
    logDecision('Crew',`Filled ${match.role} with ${match.name}.`);
  } else {
    const id='crew-'+Date.now();
    const m={id,dept,role:data.role||'Crew',name:data.name||'',phone:data.phone||'',
      email:data.email||'',rate:data.rate||'200',notes:data.notes||'',
      state:data.status==='confirmed'?'hired':data.status||'available'};
    crewStore[id]=m;crewDBSave(m);
    logDecision('Crew',`Added ${m.name||m.role} as ${m.role}${m.rate?' ¬∑ $'+m.rate+'/day':''}.`);
  }
  renderAllCrew();
}

// Old form-based add (still used by form if present)
function addCrewMember(){
  const role=document.getElementById('new-crew-role')?.value.trim();
  const name=document.getElementById('new-crew-name')?.value.trim();
  if(!role&&!name) return;
  addCrewMemberData({
    dept:(document.getElementById('new-crew-dept')?.value||'crew-camera').replace('crew-',''),
    role,name,
    phone:document.getElementById('new-crew-phone')?.value.trim()||'',
    email:document.getElementById('new-crew-email')?.value.trim()||'',
    rate:document.getElementById('new-crew-rate')?.value.trim()||'200',
    status:document.getElementById('new-crew-status')?.value||'available'
  });
  ['new-crew-role','new-crew-name','new-crew-phone','new-crew-email','new-crew-rate'].forEach(i=>{const el=document.getElementById(i);if(el)el.value='';});
}

function focusCommandWithHint(hint){
  const input=document.getElementById('cmd-input');
  if(!input) return;
  setTimeout(()=>{input.value=hint;input.focus();input.select();},100);
}

// ‚îÄ‚îÄ OVERVIEW CREW SUMMARY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function renderOverviewCrew(){
  ['camera','electric','grip'].forEach(dept=>{
    const container=document.getElementById('ov-crew-'+dept);
    if(!container) return;
    const hired=Object.values(crewStore).filter(m=>m.dept===dept&&m.state==='hired');
    if(!hired.length){container.innerHTML='';return;}
    const cfg=DEPT_CONFIG[dept];
    container.innerHTML=`<div style="font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--text3);margin-bottom:6px">${cfg.label}</div>`;
    const strip=document.createElement('div');
    strip.style.cssText='display:flex;gap:8px;flex-wrap:wrap;margin-bottom:4px';
    hired.forEach(m=>{
      const card=document.createElement('div');
      card.className='crew-card-v3 is-hired';
      card.style.cursor='pointer';
      card.innerHTML=`<div class="crew-card-v3-role">${m.role}</div><div class="crew-card-v3-name" style="cursor:pointer">${m.name}</div>${m.rate?`<div style="font-size:9px;color:var(--text3)">$${m.rate}/day</div>`:''}`;
      card.onclick=()=>{showPanel('crew',null);setTimeout(()=>openContactCard(m.id),200);};
      strip.appendChild(card);
    });
    container.appendChild(strip);
  });
  // Update crew locked stat
  const allHired=Object.values(crewStore).filter(m=>m.dept!=='production'&&m.state==='hired').length;
  const allRoles=['camera','electric','grip'].reduce((acc,dept)=>{
    return acc+(DEPT_CONFIG[dept]?.roles?.length||0);
  },0);
  const el=document.getElementById('ov-crew');
  if(el) el.textContent=allHired+' / '+allRoles+' hired';
  const sub=document.getElementById('ov-crew-sub');
  if(sub){
    const open=allRoles-allHired;
    sub.textContent=open===0?'All roles filled':open+' role'+(open!==1?'s':'')+' open';
    sub.style.color=open===0?'var(--green)':open>2?'var(--red)':'var(--amber)';
  }
}





// addVendor() now handled by vendor system

function exportPDF(){window.print()}

function filterLog(filter, btn){
  logFilter = filter;
  document.querySelectorAll('[id^="log-filter-"]').forEach(b=>b.style.cssText='');
  if(btn){btn.style.borderColor='var(--gold2)';btn.style.color='var(--gold)';}
  document.querySelectorAll('#decision-log .decision-entry').forEach(e=>{
    if(filter==='all') e.style.display='';
    else {
      const sec=(e.dataset.section||'').toLowerCase();
      e.style.display = sec.includes(filter) ? '' : 'none';
    }
  });
}

const LOG_STORE_KEY='decision_log_v1';

function saveLogEntry(entry){
  try{
    const saved=JSON.parse(localStorage.getItem(LOG_STORE_KEY)||'[]');
    saved.unshift(entry); // newest first
    if(saved.length>200) saved.length=200; // cap at 200 entries
    localStorage.setItem(LOG_STORE_KEY, JSON.stringify(saved));
  }catch(e){}
}

function loadLogEntries(){
  try{
    const saved=JSON.parse(localStorage.getItem(LOG_STORE_KEY)||'[]');
    const log=document.getElementById('decision-log');
    if(!log||!saved.length) return;
    saved.forEach(entry=>{
      const e=document.createElement('div');
      e.className='decision-entry';
      e.dataset.section=entry.dsec;
      e.innerHTML=`<div class="decision-ts">${entry.ts}</div><div class="decision-section">${entry.section}</div><div class="decision-text">${entry.text}</div>`;
      log.appendChild(e); // append (they're already newest-first in saved array)
    });
    if(logFilter!=='all') filterLog(logFilter, null);
  }catch(e){}
}

function logDecision(section, text){
  const log=document.getElementById('decision-log');
  const now=new Date().toLocaleDateString('en-US',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});
  const e=document.createElement('div');e.className='decision-entry';
  const sectionLower=section.toLowerCase();
  const dsec = sectionLower.includes('crew')?'crew':sectionLower.includes('gear')?'gear':sectionLower.includes('vendor')?'vendor':sectionLower.includes('scene')||sectionLower.includes('v1')||sectionLower.includes('v2')||sectionLower.includes('visual')?'scene':sectionLower.includes('schedule')?'schedule':'general';
  e.dataset.section=dsec;
  const ts=now+' ‚Äî Manual Update';
  e.innerHTML=`<div class="decision-ts">${ts}</div><div class="decision-section">${section}</div><div class="decision-text">${text}</div>`;
  log.prepend(e);
  saveLogEntry({ts, section, text, dsec});
  if(logFilter!=='all') filterLog(logFilter, null);
}

// ============================================================
// API KEY MANAGEMENT
// ============================================================
let GEMINI_KEY = (()=>{ try{ return localStorage.getItem('apiKey_gemini')||'AIzaSyAyruydNaePxlC3FrI7Q3iWudqDVEi5CSY'; }catch(e){ return 'AIzaSyAyruydNaePxlC3FrI7Q3iWudqDVEi5CSY'; } })();

function saveKey(service){
  const isAnthro = service==='anthropic';
  const fieldId  = isAnthro?'setting-anthropic-key':'setting-gemini-key';
  const val = document.getElementById(fieldId)?.value.trim();
  const statusId = isAnthro?'anthropic-key-status':'gemini-key-status';
  const statusEl = document.getElementById(statusId);
  if(!val){
    if(statusEl){ statusEl.textContent='‚ö† Enter a key first'; statusEl.style.color='var(--amber)'; }
    return;
  }
  if(isAnthro){ API_KEY_LIVE=val; }
  else { GEMINI_KEY=val; }
  try{ localStorage.setItem(isAnthro?'apiKey_anthropic':'apiKey_gemini', val); }catch(e){}
  updateKeyStatus(service,'Set ‚úì','var(--green)');
  if(statusEl){ statusEl.textContent='‚úì Saved ‚Äî active for this session and all future sessions'; statusEl.style.color='var(--green)'; }
  setTimeout(()=>{ if(statusEl) statusEl.textContent=''; }, 4000);
}
function updateKeyStatus(service,text,color){
  const el=document.getElementById('val-'+service+'-status');
  if(el){el.textContent=text;el.style.color=color;}
}
async function testKey(service){
  const statusEl=document.getElementById(service+'-key-status');
  if(service==='anthropic'){
    const key=document.getElementById('setting-anthropic-key').value.trim()||API_KEY_LIVE;
    if(!key){statusEl.textContent='No key entered.';return;}
    statusEl.textContent='Testing...';
    try{
      const r=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json','x-api-key':key,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},body:JSON.stringify({model:'claude-haiku-4-5-20251001',max_tokens:10,messages:[{role:'user',content:'hi'}]})});
      const d=await r.json();
      statusEl.textContent=d.error?'‚ùå '+d.error.message:'‚úì Key valid';
      statusEl.style.color=d.error?'var(--red)':'var(--green)';
    }catch(e){statusEl.textContent='Connection error';statusEl.style.color='var(--red)';}
  } else {
    const key=document.getElementById('setting-gemini-key').value.trim()||GEMINI_KEY;
    if(!key){statusEl.textContent='No key entered.';return;}
    statusEl.textContent='Testing...';
    try{
      const r=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${key}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{parts:[{text:'hi'}]}]})});
      const d=await r.json();
      statusEl.textContent=d.error?'‚ùå '+d.error.message:'‚úì Key valid';
      statusEl.style.color=d.error?'var(--red)':'var(--green)';
    }catch(e){statusEl.textContent='Connection error';statusEl.style.color='var(--red)';}
  }
}

// ============================================================
// INDEXEDDB PERSISTENCE
// ============================================================
const DB_NAME='DPHelmHQ';
const DB_VERSION=4; // bump to reseed flags with correct IDs
let db=null;

function openDB(){
  return new Promise((resolve,reject)=>{
    const req=indexedDB.open(DB_NAME,DB_VERSION);
    req.onupgradeneeded=e=>{
      const d=e.target.result;
      if(!d.objectStoreNames.contains('scoutItems')) d.createObjectStore('scoutItems',{keyPath:'id'});
      if(!d.objectStoreNames.contains('overheads')) d.createObjectStore('overheads',{keyPath:'scene'});
      if(!d.objectStoreNames.contains('crew')) d.createObjectStore('crew',{keyPath:'id'});
      if(d.objectStoreNames.contains('flags')) d.deleteObjectStore('flags'); // clear stale flag IDs
      d.createObjectStore('flags',{keyPath:'id'});
      if(!d.objectStoreNames.contains('vendors')) d.createObjectStore('vendors',{keyPath:'id'});
      if(!d.objectStoreNames.contains('pull')) d.createObjectStore('pull',{keyPath:'id'});
    };
    req.onsuccess=e=>{db=e.target.result;resolve(db);};
    req.onerror=e=>reject(e);
  });
}

function dbSave(store,obj){
  if(!db) return;
  try{
    const tx=db.transaction(store,'readwrite');
    tx.objectStore(store).put(obj);
  }catch(e){console.warn('DB save error',e);}
}

function dbDelete(store,key){
  if(!db) return;
  try{
    const tx=db.transaction(store,'readwrite');
    tx.objectStore(store).delete(key);
  }catch(e){}
}

function dbGetAll(store){
  return new Promise(resolve=>{
    if(!db){resolve([]);return;}
    try{
      const tx=db.transaction(store,'readonly');
      const req=tx.objectStore(store).getAll();
      req.onsuccess=e=>resolve(e.target.result||[]);
      req.onerror=()=>resolve([]);
    }catch(e){resolve([]);}
  });
}

async function loadPersistedScout(){
  await openDB();
  const items=await dbGetAll('scoutItems');
  if(!items.length) return;
  // Restore items ‚Äî they already have dataURL and analysis stored
  const grid=document.getElementById('scout-card-grid');
  for(const item of items){
    // Re-hydrate: restore file reference as null (can't persist File objects)
    item.file=null;
    scoutItems.push(item);
    const card=createScoutCard(item);
    grid.appendChild(card);
    updateCardMeta(item);
    if(item.analysis){
      renderAnalysis(item);
    }
    if(item.thumbnailURL && item.type==='video'){
      const thumb=card.querySelector('.video-thumb-placeholder');
      if(thumb){
        thumb.innerHTML=`<img src="${item.thumbnailURL}" style="width:100%;height:100%;object-fit:cover;display:block;opacity:0.7">`;
      }
    }
  }
  updateScoutCounts();
  // Restore overheads
  const overheads=await dbGetAll('overheads');
  overheads.forEach(o=>{
    if(o.scene===lastOverheadScene&&o.svg){
      lastOverheadSVG=o.svg;
      document.getElementById('overhead-output').innerHTML=o.svg;
      document.getElementById('overhead-status').textContent='Restored from previous session ¬∑ '+o.items+' photos';
      document.getElementById('correction-box').style.display='block';
    }
  });
  updateScoutCounts();
}

// ============================================================
// IMAGE UTILITIES
// ============================================================
function resizeImageForAPI(dataURL,maxBytes=4500000){
  return new Promise(resolve=>{
    const img=new Image();
    img.onerror=()=>resolve((dataURL.split(',')[1]||dataURL));
    img.onload=()=>{
      // Always canvas-encode to JPEG ‚Äî handles HEIC, PNG, any format
      const attempt=(scale,quality)=>{
        const c=document.createElement('canvas');
        c.width=Math.max(1,Math.round(img.width*scale));
        c.height=Math.max(1,Math.round(img.height*scale));
        c.getContext('2d').drawImage(img,0,0,c.width,c.height);
        const out=c.toDataURL('image/jpeg',quality);
        const commaIdx=out.indexOf(',');
        const bytes=(out.length-commaIdx-1)*0.75;
        if(bytes<=maxBytes||scale<0.1){
          resolve(out.split(',')[1]);
        } else if(quality>0.45){
          attempt(scale,Math.round((quality-0.1)*10)/10);
        } else {
          attempt(scale*0.7,0.7);
        }
      };
      attempt(1.0,0.88);
    };
    img.src=dataURL;
  });
}

function extractVideoThumbnail(file){
  return new Promise(resolve=>{
    const video=document.createElement('video');
    video.muted=true;
    video.playsInline=true;
    const url=URL.createObjectURL(file);
    video.src=url;
    video.addEventListener('loadeddata',()=>{
      video.currentTime=Math.min(2,video.duration*0.1||0);
    });
    video.addEventListener('seeked',()=>{
      const c=document.createElement('canvas');
      c.width=video.videoWidth||320;c.height=video.videoHeight||180;
      c.getContext('2d').drawImage(video,0,0,c.width,c.height);
      URL.revokeObjectURL(url);
      resolve(c.toDataURL('image/jpeg',0.7));
    });
    video.addEventListener('error',()=>{URL.revokeObjectURL(url);resolve(null);});
    // Timeout fallback
    setTimeout(()=>{URL.revokeObjectURL(url);resolve(null);},8000);
    video.load();
  });
}

function readEXIF(file){
  return new Promise(resolve=>{
    const result={timestamp:null,gps:null,compass:null,device:null,iso:null};
    if(file&&file.lastModified) result.timestamp=new Date(file.lastModified);
    if(!file){resolve(result);return;}
    const reader=new FileReader();
    reader.onload=e=>{
      try{
        const view=new DataView(e.target.result);
        if(view.getUint16(0)!==0xFFD8){resolve(result);return;}
        let offset=2;
        while(offset<view.byteLength-2){
          const marker=view.getUint16(offset);
          if(marker===0xFFE1){
            const exifStr=String.fromCharCode(...new Uint8Array(e.target.result,offset+4,4));
            if(exifStr==='Exif') parseEXIF(view,offset+10,result);
            break;
          }
          if(marker===0xFFDA) break;
          const segLen=view.getUint16(offset+2);
          if(segLen<2) break;
          offset+=2+segLen;
        }
      }catch(ex){}
      resolve(result);
    };
    reader.onerror=()=>resolve(result);
    reader.readAsArrayBuffer(file.slice(0,131072));
  });
}

function parseEXIF(view,start,result){
  try{
    const littleEndian=view.getUint16(start)===0x4949;
    const ifdOffset=view.getUint32(start+4,littleEndian);
    const numEntries=view.getUint16(start+ifdOffset,littleEndian);
    for(let i=0;i<numEntries;i++){
      const entryOffset=start+ifdOffset+2+i*12;
      if(entryOffset+12>view.byteLength) break;
      const tag=view.getUint16(entryOffset,littleEndian);
      const valOffset=entryOffset+8;
      if(tag===0x9003||tag===0x0132){
        try{
          const strStart=start+view.getUint32(valOffset,littleEndian);
          let s='';
          for(let j=0;j<19&&strStart+j<view.byteLength;j++) s+=String.fromCharCode(view.getUint8(strStart+j));
          const parts=s.split(' ');
          if(parts.length===2){
            const dp=parts[0].split(':');
            const tp=parts[1].split(':');
            if(dp.length===3) result.timestamp=new Date(+dp[0],+dp[1]-1,+dp[2],+(tp[0]||0),+(tp[1]||0),+(tp[2]||0));
          }
        }catch(ex){}
      }
      if(tag===0x8827){
        try{result.iso='ISO '+view.getUint16(valOffset,littleEndian);}catch(ex){}
      }
    }
  }catch(ex){}
}

function formatTimestamp(ts){
  if(!ts) return null;
  try{return new Date(ts).toLocaleString('en-US',{month:'short',day:'numeric',year:'numeric',hour:'numeric',minute:'2-digit',hour12:true});}
  catch(e){return null;}
}

// ============================================================
// SCOUT INTELLIGENCE ENGINE
// ============================================================
let scoutItems=[];
let currentOverheadScene='performance';
let lastOverheadSVG='';
let lastOverheadScene='performance';

function scoutFingerprint(file){return `${file.name}-${file.size}`;}

function updateScoutCounts(){
  const total=scoutItems.length;
  const perf=scoutItems.filter(i=>i.scene==='performance').length;
  const gen=scoutItems.filter(i=>i.scene==='genesis').length;
  const unk=scoutItems.filter(i=>i.scene==='unknown').length;
  const dup=scoutItems.filter(i=>i.isDuplicate).length;
  document.getElementById('cnt-all').textContent=total;
  document.getElementById('cnt-performance').textContent=perf;
  document.getElementById('cnt-genesis').textContent=gen;
  document.getElementById('cnt-unknown').textContent=unk;
  document.getElementById('cnt-duplicate').textContent=dup;
  document.getElementById('scout-total-label').textContent=total+' item'+(total!==1?'s':'');
  // Update overview crew stat
  const ovPrep=document.getElementById('ov-prep');
  updateChecklistPct();
}

function filterScout(filter,btn){
  document.querySelectorAll('.scout-filter-btn').forEach(b=>b.classList.remove('active'));
  if(btn) btn.classList.add('active');
  document.querySelectorAll('.scout-card').forEach(card=>{
    if(filter==='all') card.style.display='';
    else if(filter==='duplicate') card.style.display=card.classList.contains('duplicate')?'':'none';
    else card.style.display=card.dataset.scene===filter?'':'none';
  });
}

function setCardScene(itemId,scene){
  const item=scoutItems.find(i=>i.id===itemId);
  if(!item) return;
  item.scene=scene;
  const card=document.getElementById('card-'+itemId);
  if(!card) return;
  // Update card classes
  card.className='scout-card scene-'+scene+(item.isDuplicate?' duplicate':'');
  card.dataset.scene=scene;
  // Update tag label
  const tag=card.querySelector('.scout-scene-tag');
  if(tag){
    tag.className='scout-scene-tag '+scene;
    tag.textContent=scene==='performance'?'EXT. Performance':scene==='genesis'?'INT. Genesis':'Unknown';
  }
  // Sync dropdown to match
  const sel=card.querySelector('.scene-tag-select');
  if(sel) sel.value=scene;
  // Persist update
  if(item.dataURL||item.thumbnailURL) dbSave('scoutItems',serializeItem(item));
  updateScoutCounts();
}

function serializeItem(item){
  // Store everything except the File object (can't persist)
  return {
    id:item.id, type:item.type, scene:item.scene,
    dataURL:item.dataURL||null,
    thumbnailURL:item.thumbnailURL||null,
    metadata:item.metadata||{},
    analysis:item.analysis||null,
    isDuplicate:item.isDuplicate||false,
    filename:item.file?item.file.name:(item.filename||'')
  };
}

function removeScoutItem(itemId){
  scoutItems=scoutItems.filter(i=>i.id!==itemId);
  const card=document.getElementById('card-'+itemId);
  if(card) card.remove();
  dbDelete('scoutItems',itemId);
  updateScoutCounts();
}

function openLightbox(src){
  if(!src) return;
  document.getElementById('lightbox-img').src=src;
  document.getElementById('lightbox').classList.add('show');
}

function renderAnalysis(item){
  const a=item.analysis;
  if(!a) return;
  const el=document.getElementById('analysis-'+item.id);
  const expandEl=document.getElementById('expand-'+item.id);
  if(!el) return;

  if(item.type==='video'){
    // Format video analysis as readable bullets
    const raw=a.dpNotes||'';
    const formatted=raw
      .replace(/\n\n+/g,'<br><br>')
      .replace(/\n(\d+\.|[-‚Ä¢*])\s/g,'<br>‚Ä¢ ')
      .replace(/\n/g,'<br>');
    el.innerHTML=`<div style="line-height:1.7">${formatted}</div>`;
  } else {
    // Structured photo analysis
    const parts=[];
    if(a.timeOfDay) parts.push(`<div><span style="color:var(--text3);font-size:9px;letter-spacing:1px;text-transform:uppercase">Time</span><br>${a.timeOfDay}</div>`);
    if(a.lightQuality) parts.push(`<div><span style="color:var(--text3);font-size:9px;letter-spacing:1px;text-transform:uppercase">Light</span><br>${a.lightQuality}</div>`);
    if(a.compassDirection) parts.push(`<div><span style="color:var(--text3);font-size:9px;letter-spacing:1px;text-transform:uppercase">Facing</span><br>${a.compassDirection}</div>`);
    if(a.notableElements?.length) parts.push(`<div><span style="color:var(--text3);font-size:9px;letter-spacing:1px;text-transform:uppercase">Elements</span><br>${a.notableElements.join(' ¬∑ ')}</div>`);
    if(a.dpNotes) parts.push(`<div style="margin-top:4px;padding-top:4px;border-top:1px solid var(--border)">${a.dpNotes}</div>`);
    el.innerHTML=parts.map(p=>`<div style="margin-bottom:5px">${p}</div>`).join('');
  }

  if(el.scrollHeight>120){
    el.style.maxHeight='100px';
    el.style.overflow='hidden';
    if(expandEl) expandEl.style.display='block';
  }
}

function expandAnalysis(id){
  const el=document.getElementById('analysis-'+id);
  const btn=document.getElementById('expand-'+id);
  if(!el||!btn) return;
  if(el.style.maxHeight==='none'||el.style.overflow==='visible'){
    el.style.maxHeight='100px';el.style.overflow='hidden';btn.textContent='‚ñæ Show more';
  } else {
    el.style.maxHeight='none';el.style.overflow='visible';btn.textContent='‚ñ¥ Show less';
  }
}

function createScoutCard(item){
  const card=document.createElement('div');
  card.className='scout-card scene-'+item.scene+(item.isDuplicate?' duplicate':'');
  card.id='card-'+item.id;
  card.dataset.scene=item.scene;
  const sceneLabel=item.scene==='performance'?'EXT. Performance':item.scene==='genesis'?'INT. Genesis':'Unknown';

  let mediaEl;
  if(item.type==='video'){
    const thumb=item.thumbnailURL
      ?`<img src="${item.thumbnailURL}" style="width:100%;height:100%;object-fit:cover;display:block;opacity:0.8">`
      :`<div style="font-size:28px">üé¨</div>`;
    mediaEl=`<div class="video-thumb-placeholder" style="width:100%;height:140px;background:var(--s3);display:flex;align-items:center;justify-content:center;position:relative;cursor:default">${thumb}<div style="position:absolute;bottom:5px;right:7px;background:rgba(0,0,0,0.7);color:#fff;font-size:9px;padding:2px 5px;letter-spacing:1px">VIDEO</div></div>`;
  } else {
    mediaEl=`<img class="scout-card-img" src="${item.dataURL}" onclick="openLightbox('${item.dataURL}')" title="Click to enlarge">`;
  }

  card.innerHTML=`
    ${mediaEl}
    <div class="scout-card-body">
      <div style="display:flex;align-items:center;gap:6px;margin-bottom:5px">
        <span class="scout-scene-tag ${item.scene}" id="tag-${item.id}">${sceneLabel}</span>
        <select class="scene-tag-select" id="sel-${item.id}" onchange="setCardScene('${item.id}',this.value)">
          <option value="performance"${item.scene==='performance'?' selected':''}>Performance</option>
          <option value="genesis"${item.scene==='genesis'?' selected':''}>Genesis</option>
          <option value="unknown"${item.scene==='unknown'?' selected':''}>Unknown</option>
        </select>
      </div>
      <div class="scout-meta-row" id="meta-${item.id}"><span class="scout-meta-chip">‚è≥ Loading...</span></div>
      ${item.isDuplicate?'<div style="font-size:9px;color:var(--amber);margin-bottom:4px;letter-spacing:1px">‚ö† POSSIBLE DUPLICATE</div>':''}
      <div class="scout-analysis-text" id="analysis-${item.id}" style="max-height:100px;overflow:hidden"><span style="color:var(--text3);font-style:italic">Analyzing...</span></div>
      <div class="scout-expand-btn" id="expand-${item.id}" style="display:none" onclick="expandAnalysis('${item.id}')">‚ñæ Show more</div>
    </div>
    <div class="scout-card-actions">
      <button class="scout-action-btn" onclick="openLightbox('${item.dataURL||item.thumbnailURL||''}')">‚äû Full</button>
      <button class="scout-action-btn danger" onclick="removeScoutItem('${item.id}')">‚úï Remove</button>
    </div>`;
  return card;
}

function updateCardMeta(item){
  const el=document.getElementById('meta-'+item.id);
  if(!el) return;
  const chips=[];
  if(item.metadata){
    const ts=item.metadata.timestamp?formatTimestamp(new Date(item.metadata.timestamp)):null;
    if(ts) chips.push(ts);
    if(item.metadata.gps) chips.push('üìç GPS');
    if(item.metadata.iso) chips.push(item.metadata.iso);
  }
  chips.push(item.type==='video'?'üé¨ Video':'üì∑ Photo');
  if(item.filename||item.file?.name){
    const fname=item.filename||item.file.name;
    chips.push(fname.length>20?fname.substring(0,18)+'‚Ä¶':fname);
  }
  el.innerHTML=chips.map(c=>`<span class="scout-meta-chip">${c}</span>`).join('');
}

async function analyzeScoutImage(item){
  const key=API_KEY_LIVE;
  if(!key){
    item.analysis={scene:'unknown',dpNotes:'No Anthropic API key ‚Äî set in API Keys page.'};
    renderAnalysis(item);return;
  }
  try{
    const b64=await resizeImageForAPI(item.dataURL);
    const prompt=`You are a cinematographer's assistant analyzing location scout photos for a music video. Two possible locations:

LOCATION A ‚Äî "performance": OUTDOOR residential backyard. Signs: open sky, grass/lawn, trees, garden, pool, outdoor furniture, playground, fence, house exterior, daylight. Assign "performance" for ANY outdoor/yard/garden/exterior photo.

LOCATION B ‚Äî "genesis": INDOOR home animator studio. Signs: interior ceiling, desk, drawing table, bookshelves, indoor lighting, animation supplies, pencils, paper, indoor walls, no sky visible.

Rule: if you can see sky, grass, or outdoor space ‚Üí "performance". Only use "unknown" if truly impossible to determine.

Return ONLY valid JSON (no markdown, no preamble):
{"scene":"performance"|"genesis"|"unknown","timeOfDay":"string or null","lightQuality":"string","compassDirection":"string or null","notableElements":["array","of","strings"],"dpNotes":"3-4 sentences of practical DP prep intelligence"}`;
    const r=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json','x-api-key':key,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:700,messages:[{role:'user',content:[{type:'image',source:{type:'base64',media_type:'image/jpeg',data:b64}},{type:'text',text:prompt}]}]})});
    const d=await r.json();
    if(d.error){
      item.analysis={scene:'unknown',dpNotes:'API error: '+d.error.message};
      renderAnalysis(item);return;
    }
    let parsed;
    try{parsed=JSON.parse(d.content[0].text.replace(/```json|```/g,'').trim());}
    catch(ex){
      item.analysis={scene:'unknown',dpNotes:d.content[0].text};
      renderAnalysis(item);return;
    }
    item.analysis=parsed;
    // Auto-assign scene ‚Äî this also syncs the dropdown
    if(parsed.scene&&parsed.scene!=='unknown') setCardScene(item.id,parsed.scene);
    // Add AI time-of-day chip if no EXIF timestamp
    if(parsed.timeOfDay&&!item.metadata?.timestamp){
      const el=document.getElementById('meta-'+item.id);
      if(el){const c=document.createElement('span');c.className='scout-meta-chip';c.textContent='üïê '+parsed.timeOfDay;el.appendChild(c);}
    }
    renderAnalysis(item);
    // Persist
    dbSave('scoutItems',serializeItem(item));
  }catch(ex){
    item.analysis={scene:'unknown',dpNotes:'Analysis error: '+ex.message};
    renderAnalysis(item);
  }
}

async function analyzeScoutVideo(item){
  if(!GEMINI_KEY){
    item.analysis={scene:'unknown',dpNotes:'Gemini API key needed. Set in API Keys page (free at aistudio.google.com).'};
    renderAnalysis(item);return;
  }
  if(!item.file){
    item.analysis={scene:item.scene,dpNotes:'Video file not available for re-analysis (restored from session). Re-upload to analyze.'};
    renderAnalysis(item);return;
  }
  const updateStatus=txt=>{
    item.analysis={scene:item.scene,dpNotes:txt};
    renderAnalysis(item);
  };
  updateStatus('‚¨° Uploading to Gemini Files API...');
  try{
    const mimeType=item.file.type||'video/mp4';
    const metadata=JSON.stringify({file:{display_name:item.file.name}});
    const boundary='----GeminiBoundary'+Date.now();
    const metaPart=`--${boundary}\r\nContent-Type: application/json; charset=UTF-8\r\n\r\n${metadata}\r\n`;
    const fileBytes=await new Promise(r=>{const fr=new FileReader();fr.onload=e=>r(e.target.result);fr.readAsArrayBuffer(item.file);});
    const mediaPart=`--${boundary}\r\nContent-Type: ${mimeType}\r\n\r\n`;
    const endPart=`\r\n--${boundary}--`;
    const enc=new TextEncoder();
    const metaBytes=enc.encode(metaPart),mediaBytes=enc.encode(mediaPart),endBytes=enc.encode(endPart);
    const combined=new Uint8Array(metaBytes.length+mediaBytes.length+fileBytes.byteLength+endBytes.length);
    combined.set(metaBytes,0);combined.set(mediaBytes,metaBytes.length);
    combined.set(new Uint8Array(fileBytes),metaBytes.length+mediaBytes.length);
    combined.set(endBytes,metaBytes.length+mediaBytes.length+fileBytes.byteLength);
    const uploadRes=await fetch(`https://generativelanguage.googleapis.com/upload/v1beta/files?key=${GEMINI_KEY}&uploadType=multipart`,{method:'POST',headers:{'Content-Type':`multipart/related; boundary=${boundary}`},body:combined});
    if(!uploadRes.ok){updateStatus('Upload error ('+uploadRes.status+'): '+await uploadRes.text());return;}
    const uploadData=await uploadRes.json();
    const fileUri=uploadData.file?.uri;
    const fileName=uploadData.file?.name;
    if(!fileUri){updateStatus('No URI from Gemini: '+JSON.stringify(uploadData).substring(0,150));return;}
    updateStatus('‚¨° Processing video (this may take 30‚Äì60s)...');
    // Poll for ACTIVE state
    let state='PROCESSING',attempts=0;
    while(state==='PROCESSING'&&attempts<30){
      await new Promise(r=>setTimeout(r,3000));
      try{
        const s=await (await fetch(`https://generativelanguage.googleapis.com/v1beta/${fileName}?key=${GEMINI_KEY}`)).json();
        state=s.state||'ACTIVE';
      }catch(e){state='ACTIVE';}
      attempts++;
      updateStatus(`‚¨° Processing... ${attempts*3}s`);
    }
    updateStatus('‚¨° Analyzing video content...');
    const prompt=`You are a cinematographer analyzing a location scout video for a music video production. Two possible scenes:

- "performance": OUTDOOR residential backyard (grass, sky, trees, pool, garden, exterior) 
- "genesis": INDOOR animator home studio (desk, drawing table, interior, ceiling, no sky)

Analyze the video and provide a structured DP brief with these sections:

SCENE: [performance/genesis/unknown]
LOCATION: [brief description]
TIME OF DAY: [estimate and reasoning]
LIGHT QUALITY: [quality, direction, color temp, hardness]
COMPASS/ORIENTATION: [which way camera faces if determinable]
NOTABLE ELEMENTS: [bullet list of every element relevant to cinematography ‚Äî windows, doors, furniture, power sources, ceiling height, reflective surfaces, etc.]
SPATIAL LAYOUT: [describe the space for building a floor plan ‚Äî dimensions if estimable, key positions]
DP NOTES: [3-5 sentences of specific prep intelligence ‚Äî what to plan for, challenges, opportunities, flags for lighting or grip]

Be thorough and practical. This is prep material.`;
    const genRes=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_KEY}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{parts:[{file_data:{mime_type:mimeType,file_uri:fileUri}},{text:prompt}]}]})});
    const genData=await genRes.json();
    if(genData.error){updateStatus('Gemini error: '+genData.error.message);return;}
    const text=genData.candidates?.[0]?.content?.parts?.[0]?.text||'No response';
    item.analysis={dpNotes:text,scene:item.scene,type:'video'};
    // Auto-tag from response
    const lower=text.toLowerCase();
    if(lower.includes('scene: performance')||lower.includes('scene:performance')) setCardScene(item.id,'performance');
    else if(lower.includes('scene: genesis')||lower.includes('scene:genesis')) setCardScene(item.id,'genesis');
    else if(lower.includes('outdoor')||lower.includes('backyard')||lower.includes('exterior')) setCardScene(item.id,'performance');
    else if(lower.includes('indoor')||lower.includes('studio')||lower.includes('interior')||lower.includes('animator')) setCardScene(item.id,'genesis');
    renderAnalysis(item);
    dbSave('scoutItems',serializeItem(item));
  }catch(ex){
    item.analysis={scene:item.scene,dpNotes:'Video analysis error: '+ex.message};
    renderAnalysis(item);
  }
}

async function handleScoutUpload(e){
  const grid=document.getElementById('scout-card-grid');
  const existingFPs=new Set(scoutItems.filter(i=>i.file).map(i=>scoutFingerprint(i.file)));
  const files=[...e.target.files];
  for(const file of files){
    const fp=scoutFingerprint(file);
    const isDuplicate=existingFPs.has(fp);
    existingFPs.add(fp);
    const id='si-'+Date.now()+'-'+Math.random().toString(36).slice(2,7);
    const isVideo=file.type.startsWith('video/');
    const item={id,file,filename:file.name,dataURL:null,thumbnailURL:null,type:isVideo?'video':'image',scene:'unknown',metadata:{},analysis:null,isDuplicate};
    // Read EXIF (images only)
    if(!isVideo) item.metadata=await readEXIF(file);
    else item.metadata={timestamp:new Date(file.lastModified)};
    // Get dataURL or thumbnail
    if(!isVideo){
      item.dataURL=await new Promise(r=>{const fr=new FileReader();fr.onload=e=>r(e.target.result);fr.readAsDataURL(file);});
    } else {
      item.thumbnailURL=await extractVideoThumbnail(file);
    }
    scoutItems.push(item);
    const card=createScoutCard(item);
    grid.appendChild(card);
    updateCardMeta(item);
    updateScoutCounts();
    // Analyze
    if(isVideo) analyzeScoutVideo(item);
    else analyzeScoutImage(item);
  }
  e.target.value='';
}

// ============================================================
// OVERHEAD GENERATOR
// ============================================================
async function generateOverhead(scene){
  currentOverheadScene=scene;
  lastOverheadScene=scene;
  const relevant=scoutItems.filter(i=>i.scene===scene&&i.analysis);
  if(!relevant.length){
    document.getElementById('overhead-output').innerHTML=`<div style="text-align:center;color:var(--amber);font-size:11px;padding:30px">No analyzed ${scene} items yet. Upload photos/videos and wait for analysis, then tag them as ${scene}.</div>`;
    return;
  }
  const key=API_KEY_LIVE;
  if(!key){document.getElementById('overhead-output').innerHTML='<div style="text-align:center;color:var(--amber);font-size:11px;padding:30px">Anthropic API key needed.</div>';return;}
  document.getElementById('overhead-output').innerHTML=`<div style="text-align:center;color:var(--blue);font-size:11px;padding:30px;font-style:italic">‚¨° Synthesizing ${relevant.length} analyzed items into overhead sketch...</div>`;
  document.getElementById('overhead-status').textContent='';
  document.getElementById('correction-box').style.display='none';
  const analysisTexts=relevant.map((item,i)=>{
    const a=item.analysis;
    const parts=[`Item ${i+1} (${item.type})`];
    if(a.timeOfDay) parts.push('Time: '+a.timeOfDay);
    if(a.lightQuality) parts.push('Light: '+a.lightQuality);
    if(a.compassDirection) parts.push('Compass: '+a.compassDirection);
    if(a.notableElements?.length) parts.push('Elements: '+a.notableElements.join(', '));
    if(a.dpNotes) parts.push('Notes: '+a.dpNotes.substring(0,300));
    return parts.join(' | ');
  }).join('\n');
  const sceneDesc=scene==='performance'?'EXT. BACKYARD ‚Äî outdoor residential backyard, guitar performance video':'INT. ANIMATOR\'S STUDIO ‚Äî indoor home studio, animation close-ups';
  const prompt=`Create a top-down SVG architectural overhead diagram of: ${sceneDesc}

Based on ${relevant.length} analyzed scout items:
${analysisTexts}

Generate a clean SVG floor plan (viewBox="0 0 700 480") with:
- Dark background rectangle (#0e0e0e fill)
- Space boundary in gold (#c9a84c, stroke-width:2)
- Windows: double parallel lines or dashed wall segment, labeled "WIN"
- Doors: arc showing swing direction, labeled "DR"
- Key furniture/features from the analysis
- North arrow if compass direction identified
- Dimension labels (use references: door‚âà80", ceiling‚âà108", standard chair‚âà18")
- All text: white (#e8e0cc), font-family monospace, font-size MAX 11px for labels, 9px for dimensions
- Clean, legible, architectural style

IMPORTANT: Keep all text small (9-11px max). Use short labels. Don't clutter.

Return ONLY the complete SVG element. No other text. Start with <svg, end with </svg>.`;
  try{
    const r=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json','x-api-key':key,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:2500,messages:[{role:'user',content:prompt}]})});
    const d=await r.json();
    if(d.error){document.getElementById('overhead-output').innerHTML=`<div style="color:var(--amber);font-size:11px;padding:16px">Error: ${d.error.message}</div>`;return;}
    let svg=d.content[0].text.trim();
    if(!svg.startsWith('<svg')){const m=svg.match(/<svg[\s\S]*<\/svg>/i);if(m)svg=m[0];}
    lastOverheadSVG=svg;
    document.getElementById('overhead-output').innerHTML=svg+`
      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="btn sm" onclick="downloadOverheadSVG()">‚Üì Download SVG</button>
        <button class="btn sm" onclick="downloadOverheadPNG()">‚Üì Download PNG</button>
      </div>`;
    document.getElementById('overhead-status').textContent=`Generated from ${relevant.length} analyzed items ¬∑ Approximate ¬∑ Use Corrections to refine`;
    document.getElementById('correction-box').style.display='block';
    // Persist overhead
    dbSave('overheads',{scene,svg,items:relevant.length,ts:Date.now()});
    logDecision('Scout / Overhead',`${scene} overhead sketch generated from ${relevant.length} analyzed items.`);
  }catch(ex){document.getElementById('overhead-output').innerHTML=`<div style="color:var(--red);font-size:11px;padding:16px">Error: ${ex.message}</div>`;}
}

async function redrawOverhead(){
  const corrections=document.getElementById('correction-input').value.trim();
  if(!corrections||!lastOverheadSVG){generateOverhead(currentOverheadScene);return;}
  const key=API_KEY_LIVE;if(!key) return;
  document.getElementById('overhead-output').innerHTML='<div style="text-align:center;color:var(--blue);font-size:11px;padding:30px;font-style:italic">‚¨° Redrawing with corrections...</div>';
  const prompt=`Here is an SVG overhead floor plan. Apply the cinematographer's corrections and redraw it.

Original SVG:
${lastOverheadSVG}

Corrections to apply:
"${corrections}"

Keep the same style (dark background #0e0e0e, gold lines #c9a84c, white text #e8e0cc, monospace font, all labels ‚â§11px). Return ONLY the corrected SVG, no other text.`;
  try{
    const r=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json','x-api-key':key,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:2500,messages:[{role:'user',content:prompt}]})});
    const d=await r.json();
    if(d.error){document.getElementById('overhead-output').innerHTML=`<div style="color:var(--amber);padding:16px">Error: ${d.error.message}</div>`;return;}
    let svg=d.content[0].text.trim();
    if(!svg.startsWith('<svg')){const m=svg.match(/<svg[\s\S]*<\/svg>/i);if(m)svg=m[0];}
    lastOverheadSVG=svg;
    document.getElementById('overhead-output').innerHTML=svg+`
      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="btn sm" onclick="downloadOverheadSVG()">‚Üì Download SVG</button>
        <button class="btn sm" onclick="downloadOverheadPNG()">‚Üì Download PNG</button>
      </div>`;
    document.getElementById('correction-input').value='';
    document.getElementById('overhead-status').textContent='Redrawn with corrections ¬∑ '+new Date().toLocaleTimeString();
    dbSave('overheads',{scene:currentOverheadScene,svg,items:scoutItems.filter(i=>i.scene===currentOverheadScene).length,ts:Date.now()});
    logDecision('Scout / Overhead','Overhead redrawn with corrections: '+corrections.substring(0,80));
  }catch(ex){document.getElementById('overhead-output').innerHTML=`<div style="color:var(--red);padding:16px">Error: ${ex.message}</div>`;}
}

function downloadOverheadSVG(){
  if(!lastOverheadSVG) return;
  const blob=new Blob([lastOverheadSVG],{type:'image/svg+xml'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);
  a.download=`overhead-${currentOverheadScene}-${new Date().toISOString().slice(0,10)}.svg`;
  a.click();
}

function downloadOverheadPNG(){
  if(!lastOverheadSVG) return;
  const img=new Image();
  const blob=new Blob([lastOverheadSVG],{type:'image/svg+xml'});
  img.onload=()=>{
    const c=document.createElement('canvas');c.width=1400;c.height=960;
    const ctx=c.getContext('2d');
    ctx.fillStyle='#0e0e0e';ctx.fillRect(0,0,1400,960);
    ctx.drawImage(img,0,0,1400,960);
    const a=document.createElement('a');a.href=c.toDataURL('image/png');
    a.download=`overhead-${currentOverheadScene}-${new Date().toISOString().slice(0,10)}.png`;
    a.click();
  };
  img.src=URL.createObjectURL(blob);
}

// ============================================================
// INBOX (simplified)
// ============================================================
function handleInboxUpload(e){
  const items=document.getElementById('inbox-items');
  [...e.target.files].forEach(file=>{
    const id=Date.now()+Math.random();
    const icon=file.type.startsWith('image/')?'üñºÔ∏è':file.type.startsWith('video/')?'üé¨':file.type.includes('pdf')?'üìÑ':'üìé';
    const div=document.createElement('div');div.className='inbox-item';
    div.innerHTML=`<div class="inbox-item-icon">${icon}</div><div class="inbox-item-info"><div class="inbox-item-name">${file.name}</div><div class="inbox-item-status done">Logged ¬∑ use Scout Intelligence for deep analysis</div></div>`;
    items.prepend(div);
  });
}




// ============================================================
// VCF PARSER + COMMAND BAR DROP
// ============================================================
function parseVCF(text){
  // Parse vCard 3.0/4.0 format
  const lines = text.split(/\r?\n/);
  const result = {name:'', phone:'', email:'', title:'', org:''};
  for(const line of lines){
    const [key, ...rest] = line.split(':');
    const val = rest.join(':').trim();
    const k = key.split(';')[0].toUpperCase();
    if(k==='FN') result.name = val;
    else if(k==='N' && !result.name){
      // N:Last;First;;;  ‚Üí "First Last"
      const parts = val.split(';');
      result.name = [parts[1],parts[0]].filter(Boolean).join(' ');
    }
    else if(k.startsWith('TEL')) result.phone = result.phone || val.replace(/[^0-9+\-() ]/g,'');
    else if(k.startsWith('EMAIL')) result.email = result.email || val;
    else if(k==='TITLE') result.title = val;
    else if(k==='ORG') result.org = val.split(';')[0];
  }
  return result;
}

function handleCommandBarDrop(e){
  e.preventDefault();
  document.getElementById('command-bar').classList.remove('drag-over');
  const files = [...e.dataTransfer.files];
  const vcfFiles = files.filter(f => f.name.endsWith('.vcf') || f.type==='text/vcard' || f.type==='text/x-vcard');
  if(vcfFiles.length===0){
    // Not a VCF ‚Äî check if it's an image or video, route to scout
    const mediaFiles = files.filter(f => f.type.startsWith('image/') || f.type.startsWith('video/'));
    if(mediaFiles.length > 0){
      showPanel('scout', document.querySelector('.nav-item[onclick*="scout"]'));
      // Simulate upload to scout
      const dt = new DataTransfer();
      mediaFiles.forEach(f => dt.items.add(f));
      const input = document.getElementById('scout-input');
      if(input){
        Object.defineProperty(input, 'files', {value: dt.files, writable: false});
        handleScoutUpload({target:{files: dt.files, value:''}});
        showVCFToast(`üì∑ ${mediaFiles.length} file(s) sent to Scout Intelligence`, 'var(--blue)');
      }
    }
    return;
  }
  // Parse all VCF files
  vcfFiles.forEach(file => {
    const reader = new FileReader();
    reader.onload = e => {
      const parsed = parseVCF(e.target.result);
      if(!parsed.name && !parsed.phone && !parsed.email){
        showVCFToast('‚ö† Could not parse contact info from ' + file.name, 'var(--amber)');
        return;
      }
      // Pre-fill command input with parsed info
      const role = parsed.title || 'Crew';
      const parts = [parsed.name];
      if(role) parts.push(role);
      if(parsed.phone) parts.push(parsed.phone);
      if(parsed.email) parts.push(parsed.email);
      const cmdText = parts.filter(Boolean).join(', ');
      document.getElementById('cmd-input').value = cmdText;
      showVCFToast(`‚úì Parsed: ${parsed.name}${parsed.title ? ' ‚Äî ' + parsed.title : ''}${parsed.phone ? ' ¬∑ ' + parsed.phone : ''}${parsed.email ? ' ¬∑ ' + parsed.email : ''} ¬∑ Press Enter or click Send to add`, 'var(--green)');
      document.getElementById('cmd-input').focus();
    };
    reader.readAsText(file);
  });
}

function showVCFToast(msg, color){
  const toast = document.getElementById('vcf-toast');
  if(!toast) return;
  toast.textContent = msg;
  toast.style.display = 'block';
  toast.style.borderColor = color || 'var(--green)';
  toast.style.color = color || 'var(--green)';
  clearTimeout(toast._timer);
  toast._timer = setTimeout(() => { toast.style.display='none'; }, 8000);
}

// ============================================================
// PULL SHEET ‚Äî INLINE EDITING + SOURCE VENDORS + INDEXEDDB
// ============================================================

const PULL_DEPT_CONFIG = {
  camera:   { label: 'üì∑ Camera',   icon: 'üì∑' },
  electric: { label: '‚ö° Electric', icon: '‚ö°' },
  grip:     { label: 'üîß Grip',     icon: 'üîß' },
};

const PULL_DEFAULTS = [
  // Camera
  {id:'pull-alexa',      dept:'camera',   item:'ARRI Alexa 35',              qty:'1',    source:'Lightstone',  priority:'critical', notes:'+ mags, batteries, cage, accessories', video:'Both'},
  {id:'pull-mercury',    dept:'camera',   item:'Atlas Mercury Set (32/50/75)',qty:'1 set',source:'Lightstone',  priority:'critical', notes:'PL mount ¬∑ verify 32/50/75 availability', video:'Both'},
  {id:'pull-diopter',    dept:'camera',   item:'Diopter Set',                qty:'1 set',source:'Lightstone',  priority:'high',     notes:'Test with Mercury before rental lock', video:'Both'},
  {id:'pull-steadicam-mon',dept:'camera', item:'Steadicam Monitor',          qty:'1',    source:'Lightstone',  priority:'high',     notes:'Confirm if op provides on rig', video:'V1'},
  {id:'pull-703',        dept:'camera',   item:'SmallHD 703',                qty:'1',    source:"Luke's Truck",priority:'critical', notes:'Primary on-set monitor', video:'Both'},
  {id:'pull-ultraarm',   dept:'camera',   item:'UltraLight Arm',             qty:'1',    source:"Luke's Truck",priority:'high',     notes:'With 703', video:'Both'},
  {id:'pull-comms',      dept:'camera',   item:'Hollyland Comms',            qty:'6',    source:"Luke's Truck",priority:'high',     notes:'Full small crew', video:'Both'},
  // Electric
  {id:'pull-nanlux',     dept:'electric', item:'Nanlux 2400 (or 1200/900)',  qty:'1',    source:'None',         priority:'critical', notes:'20A circuit ¬∑ run at 80% if 2400', video:'V1'},
  {id:'pull-litemat',    dept:'electric', item:'LiteMat 4',                  qty:'TBD',  source:'Lightstone',  priority:'high',     notes:'Qty TBD until V2 location locked', video:'V2'},
  {id:'pull-b7c',        dept:'electric', item:'Aperture B7c',               qty:'3',    source:"Luke's Truck",priority:'low',      notes:'App-controlled smart bulbs ¬∑ in-frame practical only', video:'Both'},
  {id:'pull-mcpro',      dept:'electric', item:'Aperture MC Pro',            qty:'1',    source:"Luke's Truck",priority:'low',      notes:'Practical accent / eye light', video:'Both'},
  // Grip
  {id:'pull-steadicam',  dept:'grip',     item:'Steadicam Rig',              qty:'1',    source:'Lightstone',  priority:'critical', notes:'Operator separate hire', video:'V1'},
  {id:'pull-talon',      dept:'grip',     item:'Talon Jr/Zoom Head',         qty:'1',    source:"Luke's Truck",priority:'high',     notes:'Static locked shots both videos', video:'Both'},
  {id:'pull-cstand-own', dept:'grip',     item:'C-Stand',                    qty:'1',    source:"Luke's Truck",priority:'high',     notes:'Owned', video:'Both'},
  {id:'pull-cstand-rent',dept:'grip',     item:'C-Stands',                   qty:'2‚Äì3',  source:'Lightstone',  priority:'high',     notes:'Rental ¬∑ qty depends on final setup', video:'Both'},
  {id:'pull-gels',       dept:'grip',     item:'Gel Set',                    qty:'1 box',source:"Luke's Truck",priority:'high',     notes:'¬º CTO on Nanlux V1 + creative use V2', video:'Both'},
  {id:'pull-diffusion',  dept:'grip',     item:'Diffusion Set',              qty:'1 box',source:"Luke's Truck",priority:'high',     notes:'Soften Nanlux if needed', video:'Both'},
];

let pullStore = {};

function pullDBSave(item){ dbSave('pull', item); pullStore[item.id]=item; }
function pullDBDelete(id){ dbDelete('pull', id); delete pullStore[id]; }

async function initPullSheet(){
  let saved=[];
  try{ saved=await dbGetAll('pull'); }catch(e){}
  if(saved&&saved.length>0){
    saved.forEach(i=>{ pullStore[i.id]=i; });
  } else {
    PULL_DEFAULTS.forEach(i=>{ pullStore[i.id]={...i}; pullDBSave({...i}); });
  }
  renderAllPull();
}

function getSourceOptions(){
  // Build from vendorStore + Luke's Truck + special options
  const sources=["Luke's Truck"];
  Object.values(vendorStore||{}).forEach(v=>{
    if(v.name&&!sources.includes(v.name)) sources.push(v.name);
  });
  sources.push('None','TBD','Other');
  return sources;
}

function renderAllPull(){
  ['camera','electric','grip'].forEach(dept=>{
    const container=document.getElementById('pull-dept-'+dept);
    if(!container) return;
    const cfg=PULL_DEPT_CONFIG[dept];

    // Header
    let html=`<div class="section-title" style="${dept==='camera'?'margin-top:0':''}">${cfg.label}</div>`;

    // Table
    html+=`<div style="overflow-x:auto;margin-bottom:8px">
    <table class="pull-table" id="pull-table-${dept}">
      <thead><tr>
        <th style="width:28%">Item</th>
        <th style="width:8%">Qty</th>
        <th style="width:18%">Source</th>
        <th style="width:12%">Priority</th>
        <th style="width:9%">Video</th>
        <th style="width:21%">Notes</th>
        <th style="width:4%"></th>
      </tr></thead>
      <tbody id="pull-body-${dept}">`;

    const items=Object.values(pullStore).filter(i=>i.dept===dept);
    items.sort((a,b)=>{
      const o={critical:0,high:1,low:2};
      return (o[a.priority]??1)-(o[b.priority]??1);
    });
    items.forEach(item=>{
      html+=buildPullRow(item);
    });

    html+=`</tbody></table></div>`;
    html+=`<button class="pull-add-btn" onclick="addPullItem('${dept}')">+ Add ${cfg.label.replace(/^[^\s]+\s/,'')} Item</button>`;

    container.innerHTML=html;
  });
  // Wire up inline edit events
  document.querySelectorAll('.pull-cell-editable').forEach(cell=>{
    cell.addEventListener('click', startCellEdit);
  });
  document.querySelectorAll('.pull-source-select').forEach(sel=>{
    sel.addEventListener('change', function(){
      const id=this.closest('tr').dataset.id;
      if(pullStore[id]){ pullStore[id].source=this.value; pullDBSave(pullStore[id]); }
      this.style.color=getVendorColor(this.value);
      const rowId=this.closest('tr')?.dataset?.id;
      if(rowId&&pullStore[rowId]) logDecision('Pull Sheet',`${pullStore[rowId].item} ‚Äî source: ${this.value}`);
    });
  });
  document.querySelectorAll('.pull-priority-select').forEach(sel=>{
    sel.addEventListener('change', function(){
      const id=this.closest('tr').dataset.id;
      if(pullStore[id]){ pullStore[id].priority=this.value; pullDBSave(pullStore[id]); updatePullRowStyle(id); }
    });
  });
}

function buildPullRow(item){
  const sources=getSourceOptions();
  const sourceOpts=sources.map(s=>`<option${s===item.source?' selected':''}>${s}</option>`).join('');
  const prioOpts=['critical','high','low'].map(p=>`<option${p===item.priority?' selected':''}>${p}</option>`).join('');
  const prioColor=item.priority==='critical'?'var(--red)':item.priority==='high'?'var(--amber)':'var(--text3)';
  const srcColor=getVendorColor(item.source);

  return `<tr data-id="${item.id}" class="pull-row" id="pull-row-${item.id}">
    <td class="pull-cell-editable" data-field="item" data-id="${item.id}" title="Click to edit">${item.item||''}</td>
    <td class="pull-cell-editable" data-field="qty" data-id="${item.id}" style="text-align:center">${item.qty||'1'}</td>
    <td><select class="pull-source-select" style="color:${srcColor}">${sourceOpts}</select></td>
    <td><select class="pull-priority-select" style="color:${prioColor};font-size:9px">${prioOpts}</select></td>
    <td class="pull-cell-editable" data-field="video" data-id="${item.id}" style="text-align:center;font-size:10px">${item.video||'Both'}</td>
    <td class="pull-cell-editable" data-field="notes" data-id="${item.id}" style="font-size:10px;color:var(--text3)">${item.notes||''}</td>
    <td style="text-align:center"><button class="pull-del-btn" onclick="deletePullItem('${item.id}')" title="Remove">‚úï</button></td>
  </tr>`;
}

function updatePullRowStyle(id){
  const row=document.getElementById('pull-row-'+id);
  const item=pullStore[id];
  if(!row||!item) return;
  const prioCell=row.querySelector('.pull-priority-select');
  if(prioCell) prioCell.style.color=item.priority==='critical'?'var(--red)':item.priority==='high'?'var(--amber)':'var(--text3)';
}

let _editingCell=null;
function startCellEdit(e){
  const cell=e.currentTarget;
  if(cell.querySelector('input')) return; // already editing
  const id=cell.dataset.id;
  const field=cell.dataset.field;
  const current=cell.textContent.trim();
  const input=document.createElement('input');
  input.className='pull-cell-input';
  input.value=current;
  cell.textContent='';
  cell.appendChild(input);
  input.focus();
  input.select();
  _editingCell={cell,id,field,current};

  input.addEventListener('blur', commitCellEdit);
  input.addEventListener('keydown', e=>{
    if(e.key==='Enter'){ e.preventDefault(); input.blur(); }
    if(e.key==='Escape'){ input.value=current; input.blur(); }
    if(e.key==='Tab'){
      e.preventDefault();
      const allCells=[...document.querySelectorAll('.pull-cell-editable')];
      const idx=allCells.indexOf(cell);
      input.blur();
      if(idx>=0&&idx<allCells.length-1) allCells[idx+1].click();
    }
  });
}

function commitCellEdit(){
  if(!_editingCell) return;
  const {cell,id,field} = _editingCell;
  const input=cell.querySelector('input');
  if(!input) return;
  const val=input.value.trim();
  cell.textContent=val;
  if(pullStore[id]){
    pullStore[id][field]=val;
    pullDBSave(pullStore[id]);
    if(field==='item'||field==='qty'||field==='notes')
      logDecision('Pull Sheet',`${pullStore[id].item||'Item'} ‚Äî ${field}: "${val}"`);
  }
  // Re-wire click
  cell.addEventListener('click', startCellEdit);
  _editingCell=null;
}

function addPullItem(dept){
  const id='pull-'+Date.now();
  const item={id, dept, item:'New item', qty:'1', source:"Luke's Truck", priority:'high', notes:'', video:'Both'};
  pullStore[id]=item;
  pullDBSave(item);
  logDecision('Pull Sheet',`Added new ${dept} item`);
  renderAllPull();
  // Focus the new row's item cell
  setTimeout(()=>{
    const cell=document.querySelector(`#pull-row-${id} .pull-cell-editable[data-field="item"]`);
    if(cell) cell.click();
  }, 50);
}

function deletePullItem(id){
  const item=pullStore[id];
  logDecision('Pull Sheet',`Removed: ${item?.item||'item'} (${item?.dept||''})`);
  pullDBDelete(id);
  renderAllPull();
}



// ============================================================
// FLAG ‚Üí PAGE NAVIGATION WITH ANCHOR + PULSE
// ============================================================
// Each flag can have: link: {panel, groupId, itemId, cardId}

const FLAG_LINKS = {
  'flag-crew-1stacfocuspuller': {panel:'crew',      roleKey:'1stacfocuspuller'},
  'flag-crew-gaffer':           {panel:'crew',      roleKey:'gaffer'},
  'flag-steadicam':             {panel:'checklist', groupId:'cg-crew',      flagText:'Steadicam operator'},
  'flag-v2loc':                 {panel:'checklist', groupId:'cg-locations', flagText:"ANIMATOR'S STUDIO"},
  'flag-nanlux':                {panel:'checklist', groupId:'cg-tech',      flagText:'Nanlux'},
  'flag-diopter':               {panel:'checklist', groupId:'cg-tech',      flagText:'Diopter'},
  'flag-codec':                 {panel:'checklist', groupId:'cg-tech',      flagText:'Codec'},
  'flag-daniel-email':          {panel:'crew',      crewId:'crew-daniel'},
  'flag-v2tod':                 {panel:'checklist', groupId:'cg-schedule',  flagText:'V2 time of day'},
  'flag-coi-lightstone':        {panel:'checklist', groupId:'cg-coi',       flagText:'Lightstone'},
};

// Build crew-open flags ‚Üí crew panel links dynamically
function getFlagLink(flagId){
  if(FLAG_LINKS[flagId]) return FLAG_LINKS[flagId];
  if(flagId.startsWith('flag-crew-')){
    return {panel:'crew'};
  }
  return null;
}

function navigateToFlag(flagId){
  const link=getFlagLink(flagId);
  if(!link) return;

  const navItem=document.querySelector(`.nav-item[onclick*="${link.panel}"]`);
  showPanel(link.panel, navItem);

  setTimeout(()=>{
    // Checklist: open group + pulse item
    if(link.groupId){
      const group=document.getElementById(link.groupId);
      if(group&&!group.classList.contains('open')) group.classList.add('open');
      if(link.flagText){
        // Find item containing that text
        const items=group?group.querySelectorAll('.check-item'):[];
        for(const item of items){
          if(item.textContent.includes(link.flagText)){
            pulseElement(item);
            break;
          }
        }
      }
    }
    // Crew: pulse role row or open contact card
    if(link.panel==='crew'){
      if(link.crewId){
        const card=document.getElementById('cv3-'+link.crewId);
        if(card) pulseElement(card);
      } else if(link.roleKey){
        // Find role strip
        document.querySelectorAll('.crew-role-strip').forEach(strip=>{
          if(strip.id.includes(link.roleKey)) pulseElement(strip.closest('.crew-role-row'));
        });
      }
    }
    // Vendors: open vendor card
    if(link.panel==='vendors'&&link.vendorId){
      const card=document.getElementById('vc-'+link.vendorId);
      if(card) pulseElement(card);
    }
    // Gear/pull: pulse row
    if(link.itemId){
      const row=document.getElementById('pull-row-'+link.itemId);
      if(row) pulseElement(row);
    }
  }, 200);
}

function pulseElement(el){
  if(!el) return;
  el.scrollIntoView({behavior:'smooth', block:'nearest'});
  el.classList.add('flag-pulse');
  setTimeout(()=>el.classList.remove('flag-pulse'), 5000);
}

// Override renderFlags to add click navigation
function renderFlags(){
  const container=document.getElementById('ov-flags');
  if(!container) return;

  const active=Object.values(flagStore).filter(f=>!f.resolved);
  if(!active.length){
    container.innerHTML='<div style="color:var(--green);font-size:11px;padding:6px 0">‚úì No active flags ‚Äî all clear</div>';
    return;
  }

  active.sort((a,b)=>{
    if(a.severity===b.severity) return (a.dept||'').localeCompare(b.dept||'');
    return a.severity==='red'?-1:1;
  });

  container.innerHTML='';
  active.forEach(f=>{
    const dept=f.dept||'general';
    const dc=DEPT_COLORS[dept]||DEPT_COLORS.general;
    const dot=f.severity==='red'?'üî¥':'üü°';
    const hasLink=!!getFlagLink(f.id);

    const row=document.createElement('div');
    row.style.cssText='display:flex;align-items:flex-start;gap:0;margin-bottom:6px';
    if(hasLink) row.style.cursor='pointer';
    row.innerHTML=`
      <div style="width:3px;align-self:stretch;background:${dc.border};flex-shrink:0;margin-right:8px;border-radius:1px"></div>
      <div style="flex:1;font-size:11px;line-height:1.6">
        <span style="font-size:9px;letter-spacing:1px;text-transform:uppercase;color:${dc.border};margin-right:5px">${dc.label}</span>
        ${dot} ${f.text}
        ${hasLink?'<span style="font-size:9px;color:var(--text3);margin-left:5px">‚Üí</span>':''}
      </div>`;
    if(hasLink) row.onclick=()=>navigateToFlag(f.id);
    if(hasLink){
      row.addEventListener('mouseenter',()=>row.querySelector('div:last-child').style.opacity='.7');
      row.addEventListener('mouseleave',()=>row.querySelector('div:last-child').style.opacity='1');
    }
    container.appendChild(row);
  });
}

// ============================================================
// CREW HIRE ‚Üí CHECKLIST TOAST
// ============================================================
const CREW_CHECKLIST_MAP = {
  '1stacfocuspuller': {groupId:'cg-crew', flagText:'1st AC confirmed'},
  'cameraoperator':   {groupId:'cg-crew', flagText:'Camera Op'},
  'gaffer':           {groupId:'cg-crew', flagText:'Gaffer confirmed'},
  'keygrip':          {groupId:'cg-crew', flagText:'Key Grip'},
  'steadicamoperator':{groupId:'cg-crew', flagText:'Steadicam operator confirmed'},
  'dit':              {groupId:'cg-crew', flagText:'DIT confirmed'},
};

function showHireToast(member){
  const key=normalizeRole(member.role);
  const map=CREW_CHECKLIST_MAP[key];
  if(!map) return;

  // Find the checklist item
  const group=document.getElementById(map.groupId);
  if(!group) return;
  let targetItem=null;
  group.querySelectorAll('.check-item').forEach(item=>{
    if(item.textContent.includes(map.flagText)&&!item.classList.contains('done')){
      targetItem=item;
    }
  });
  if(!targetItem) return; // already checked

  // Show toast
  const toast=document.createElement('div');
  toast.className='hire-toast';
  toast.innerHTML=`<span style="flex:1">${member.name} hired as ${member.role} ‚Äî mark checklist item done?</span>
    <button class="hire-toast-yes" onclick="confirmHireChecklist(this,'${map.groupId}','${map.flagText}')">‚úì Yes</button>
    <button class="hire-toast-no" onclick="this.closest('.hire-toast').remove()">Later</button>`;
  document.body.appendChild(toast);
  setTimeout(()=>{ if(toast.parentNode) toast.remove(); }, 8000);
}

function confirmHireChecklist(btn, groupId, flagText){
  const group=document.getElementById(groupId);
  if(!group) return;
  group.querySelectorAll('.check-item').forEach(item=>{
    if(item.textContent.includes(flagText)&&!item.classList.contains('done')){
      toggleCheck(item, groupId);
      pulseElement(item);
    }
  });
  btn.closest('.hire-toast').remove();
}




// ============================================================
// GEAR QUOTES VIEW ‚Äî mirror of vendor quotes, grouped by vendor
// ============================================================
function renderGearQuotes(){
  const container=document.getElementById('gear-quotes-section');
  if(!container) return;
  const allQuotes=[];
  Object.values(vendorStore||{}).forEach(v=>{
    (v.quotes||[]).forEach(q=>{ allQuotes.push({...q, vendorName:v.name, vendorId:v.id}); });
  });
  if(!allQuotes.length){
    container.innerHTML='<div style="font-size:10px;color:var(--text3);font-style:italic;padding:8px 0">No quotes attached yet ‚Äî attach PDFs to vendors on the Vendors page.</div>';
    return;
  }
  // Group by vendor
  const byVendor={};
  allQuotes.forEach(q=>{
    if(!byVendor[q.vendorId]) byVendor[q.vendorId]=[];
    byVendor[q.vendorId].push(q);
  });
  let html='';
  Object.keys(byVendor).forEach(vid=>{
    const vqs=byVendor[vid];
    vqs.forEach(q=>{
      const hasPreview=q.dataURL&&q.dataURL.startsWith('data:image');
      const isPDF=q.filename&&q.filename.toLowerCase().endsWith('.pdf');
      html+=`<div class="quote-card" onclick="openQuotePreview('${q.id}','${vid}')">
        <div class="quote-card-thumb">${hasPreview?`<img src="${q.dataURL}" style="width:100%;height:100%;object-fit:cover">`:isPDF?'<div style="font-size:24px;line-height:1;color:var(--text3)">üìÑ</div>':'<div style="font-size:24px;line-height:1;color:var(--text3)">üìé</div>'}</div>
        <div class="quote-card-body">
          <div class="quote-card-vendor">${q.vendorName}</div>
          <div class="quote-card-label">${q.label||'Quote'}</div>
          <div class="quote-card-date">${q.date||''}</div>
          ${q.amount?`<div class="quote-card-amount">$${q.amount}</div>`:''}
          <div style="font-size:9px;color:var(--text3);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:110px">${q.filename||''}</div>
        </div>
      </div>`;
    });
  });
  container.innerHTML=html||'<div style="font-size:10px;color:var(--text3);font-style:italic;padding:8px 0">No quotes yet.</div>';
}

function openQuotePreview(quoteId, vendorId){
  const v=vendorStore[vendorId];
  if(!v) return;
  const q=(v.quotes||[]).find(q=>q.id===quoteId);
  if(!q||!q.dataURL) return;
  // Open in lightbox or new tab
  if(q.dataURL.startsWith('data:image')){
    openLightbox(q.dataURL);
  } else {
    // PDF ‚Äî open in new tab
    const link=document.createElement('a');
    link.href=q.dataURL;
    link.download=q.filename||'quote.pdf';
    link.click();
  }
}


// ============================================================
// VENDOR COLOR PALETTE
// ============================================================
const VENDOR_COLOR_PALETTE = [
  'var(--red)',        // 0 - first added
  'var(--amber)',      // 1
  '#b47fcc',          // 2 - purple
  '#4a9eff',          // 3 - blue
  '#4acccc',          // 4 - teal
  '#e8885a',          // 5 - orange
];

function getVendorColor(sourceName){
  if(!sourceName || sourceName==='None' || sourceName==='TBD' || sourceName==='Other') return 'var(--text3)';
  if(sourceName==="Luke's Truck") return 'var(--green)';
  // Assign color based on order vendors were added to vendorStore
  const vendors=Object.values(vendorStore||{});
  const idx=vendors.findIndex(v=>v.name===sourceName);
  if(idx<0) return 'var(--text2)';
  return VENDOR_COLOR_PALETTE[idx % VENDOR_COLOR_PALETTE.length];
}

// ============================================================
// SCHEDULE ‚Äî DATA STORE + DRAGGABLE TIMELINE + AI COMMIT
// ============================================================

let scheduleStore = {
  days: [
    {date:'Feb 17', label:'Today',  type:'today', items:[
      {id:'s1a', text:'Find 1st AC replacement', urgent:true,  done:false},
      {id:'s1b', text:'Contact Ryan @ Lightstone', urgent:true,  done:false},
      {id:'s1c', text:'Confirm Steadicam op search', urgent:false, done:false},
    ]},
    {date:'Feb 18', label:'Tue',    type:'', items:[
      {id:'s2a', text:'Follow up Lightstone quote', urgent:false, done:false},
      {id:'s2b', text:'Send COI request to broker',  urgent:false, done:false},
    ]},
    {date:'Feb 19', label:'Wed',    type:'', items:[
      {id:'s3a', text:'Lock 1st AC',        urgent:false, done:false},
      {id:'s3b', text:'COI to Lightstone',  urgent:false, done:false},
    ]},
    {date:'Feb 20', label:'Thu',    type:'', items:[
      {id:'s4a', text:'Confirm Steadicam op', urgent:false, done:false},
      {id:'s4b', text:'Diopter/Mercury test', urgent:false, done:false},
    ]},
    {date:'Feb 21', label:'Fri',    type:'', items:[
      {id:'s5a', text:'Codec confirm w/ animator', urgent:false, done:false},
    ]},
    {date:'Feb 22', label:'Sat',    type:'', items:[]},
    {date:'Feb 23', label:'Sun',    type:'', items:[]},
    {date:'Feb 24', label:'Mon',    type:'', items:[
      {id:'s8a', text:'Rental order signed', urgent:false, done:false},
      {id:'s8b', text:'Call sheet draft',    urgent:false, done:false},
    ]},
    {date:'Feb 25', label:'Scout',  type:'scout', items:[
      {id:'s9a', text:'Tech scout ‚Äî V1 backyard',          urgent:false, done:false},
      {id:'s9b', text:'Tech scout ‚Äî V2 studio (if locked)',urgent:false, done:false},
      {id:'s9c', text:'Confirm 20A circuit V1',            urgent:false, done:false},
    ]},
    {date:'Feb 26', label:'Tue',    type:'', items:[
      {id:'s10a', text:'Call sheet distribute', urgent:false, done:false},
      {id:'s10b', text:'Gear check + pack',     urgent:false, done:false},
    ]},
    {date:'Feb 27', label:'SHOOT',  type:'shoot', items:[
      {id:'s11a', text:'V1: EXT. BACKYARD 9‚Äì11AM', urgent:false, done:false},
      {id:'s11b', text:'V2: INT. STUDIO TBD',      urgent:false, done:false},
    ]},
  ]
};

// Drag state
let _dragItem = null;      // {itemId, fromDate}
let _dragOver = null;      // {toDate, toIndex}

function schedSave(){ try{ localStorage.setItem('scheduleStore', JSON.stringify(scheduleStore)); }catch(e){} }
function schedLoad(){
  try{
    const saved = localStorage.getItem('scheduleStore');
    if(saved){ scheduleStore = JSON.parse(saved); }
  }catch(e){}
}

function renderTimeline(){
  const root = document.getElementById('timeline-root');
  if(!root) return;
  root.innerHTML = '';
  scheduleStore.days.forEach((day, di) => {
    const col = document.createElement('div');
    col.className = 'tl-day' + (day.type ? ' '+day.type : '');
    col.dataset.date = day.date;

    // Header
    const hdr = document.createElement('div');
    hdr.className = 'tl-day-header';
    hdr.innerHTML = `<div class="tl-date">${day.date}</div><div class="tl-label">${day.label}</div>`;
    col.appendChild(hdr);

    // Items
    const itemsEl = document.createElement('div');
    itemsEl.className = 'tl-items';
    itemsEl.dataset.date = day.date;

    // Drop zone behavior
    itemsEl.addEventListener('dragover', e => {
      e.preventDefault();
      itemsEl.classList.add('tl-drop-active');
      _dragOver = {toDate: day.date, toIndex: day.items.length};
    });
    itemsEl.addEventListener('dragleave', e => {
      if(!itemsEl.contains(e.relatedTarget)) itemsEl.classList.remove('tl-drop-active');
    });
    itemsEl.addEventListener('drop', e => {
      e.preventDefault();
      itemsEl.classList.remove('tl-drop-active');
      if(_dragItem) dropItem(_dragItem.itemId, _dragItem.fromDate, day.date, day.items.length);
    });

    day.items.forEach((item, ii) => {
      const el = buildItemEl(item, day.date, ii);
      itemsEl.appendChild(el);
    });

    // Add item button
    const addBtn = document.createElement('button');
    addBtn.className = 'tl-add-btn';
    addBtn.textContent = '+ Add item';
    addBtn.onclick = () => addScheduleItem(day.date);
    itemsEl.appendChild(addBtn);

    col.appendChild(itemsEl);
    root.appendChild(col);
  });
}

function buildItemEl(item, date, idx){
  const el = document.createElement('div');
  el.className = 'tl-item action' + (item.done?' done-item':'') + (item.urgent?' urgent':'');
  el.dataset.id = item.id;
  el.dataset.date = date;
  el.draggable = true;

  el.innerHTML = `
    <div class="tl-item-text" onclick="toggleSchedItem('${item.id}','${date}')">${item.text}</div>
    <div class="tl-item-actions">
      <button class="tl-item-edit" onclick="editSchedItem('${item.id}','${date}')" title="Edit">‚úé</button>
      <button class="tl-item-del" onclick="deleteSchedItem('${item.id}','${date}')" title="Remove">‚úï</button>
    </div>`;

  el.addEventListener('dragstart', e => {
    _dragItem = {itemId: item.id, fromDate: date};
    el.classList.add('tl-dragging');
    e.dataTransfer.effectAllowed = 'move';
  });
  el.addEventListener('dragend', () => {
    el.classList.remove('tl-dragging');
    document.querySelectorAll('.tl-drop-active').forEach(x=>x.classList.remove('tl-drop-active'));
    _dragItem = null;
  });
  // Drop target: reorder within day
  el.addEventListener('dragover', e => {
    e.preventDefault();
    e.stopPropagation();
    el.classList.add('tl-drop-before');
    _dragOver = {toDate: date, toIndex: idx};
  });
  el.addEventListener('dragleave', () => el.classList.remove('tl-drop-before'));
  el.addEventListener('drop', e => {
    e.preventDefault();
    e.stopPropagation();
    el.classList.remove('tl-drop-before');
    if(_dragItem) dropItem(_dragItem.itemId, _dragItem.fromDate, date, idx);
  });

  return el;
}

function dropItem(itemId, fromDate, toDate, toIndex){
  const fromDay = scheduleStore.days.find(d => d.date === fromDate);
  const toDay   = scheduleStore.days.find(d => d.date === toDate);
  if(!fromDay || !toDay) return;
  const itemIdx = fromDay.items.findIndex(i => i.id === itemId);
  if(itemIdx < 0) return;
  const [item] = fromDay.items.splice(itemIdx, 1);
  // Clamp toIndex
  const clampedIdx = Math.min(toIndex, toDay.items.length);
  toDay.items.splice(clampedIdx, 0, item);
  schedSave();
  logDecision('Schedule', `Moved "${item.text}" ‚Üí ${toDate}`);
  renderTimeline();
}

function toggleSchedItem(itemId, date){
  const day = scheduleStore.days.find(d => d.date === date);
  if(!day) return;
  const item = day.items.find(i => i.id === itemId);
  if(!item) return;
  item.done = !item.done;
  schedSave();
  logDecision('Schedule', `${item.done?'‚úì Done':'‚óã Undone'}: ${item.text}`);
  renderTimeline();
}

function editSchedItem(itemId, date){
  const day = scheduleStore.days.find(d => d.date === date);
  if(!day) return;
  const item = day.items.find(i => i.id === itemId);
  if(!item) return;
  // Inline edit: replace text with input
  const el = document.querySelector(`[data-id="${itemId}"] .tl-item-text`);
  if(!el || el.querySelector('input')) return;
  const prev = item.text;
  const input = document.createElement('input');
  input.className = 'tl-item-input';
  input.value = prev;
  el.innerHTML = '';
  el.appendChild(input);
  input.focus(); input.select();
  const commit = () => {
    const val = input.value.trim();
    if(val && val !== prev){
      item.text = val;
      schedSave();
      logDecision('Schedule', `Edited: "${prev}" ‚Üí "${val}"`);
    }
    renderTimeline();
  };
  input.addEventListener('blur', commit);
  input.addEventListener('keydown', e => {
    if(e.key==='Enter'){ e.preventDefault(); input.blur(); }
    if(e.key==='Escape'){ input.value=prev; input.blur(); }
  });
}

function deleteSchedItem(itemId, date){
  const day = scheduleStore.days.find(d => d.date === date);
  if(!day) return;
  const idx = day.items.findIndex(i => i.id === itemId);
  if(idx < 0) return;
  const [removed] = day.items.splice(idx, 1);
  schedSave();
  logDecision('Schedule', `Removed: "${removed.text}" from ${date}`);
  renderTimeline();
}

function addScheduleItem(date, text, urgent){
  const day = scheduleStore.days.find(d => d.date === date);
  if(!day) return;
  const item = {
    id: 'si-' + Date.now(),
    text: text || 'New item',
    urgent: urgent || false,
    done: false
  };
  day.items.push(item);
  schedSave();
  renderTimeline();
  // If no text provided, trigger immediate edit
  if(!text){
    setTimeout(() => editSchedItem(item.id, date), 60);
  }
}

function initSchedule(){
  schedLoad();
  renderTimeline();
}



function initApiKeys(){
  try{
    const ak=localStorage.getItem('apiKey_anthropic');
    const gk=localStorage.getItem('apiKey_gemini');
    const aField=document.getElementById('setting-anthropic-key');
    const gField=document.getElementById('setting-gemini-key');
    // Pre-fill from localStorage if saved
    if(ak&&aField){ aField.value=ak; }
    if(gk&&gField){ gField.value=gk; }
    // Show Set ‚úì if either localStorage or hardcoded fallback key is active
    if(API_KEY_LIVE&&API_KEY_LIVE.length>10) updateKeyStatus('anthropic','Set ‚úì','var(--green)');
    if(GEMINI_KEY&&GEMINI_KEY.length>10) updateKeyStatus('gemini','Set ‚úì','var(--green)');
  }catch(e){}
}

// ============================================================
// CREW DOCUMENTS ‚Äî attach files to crew contact cards
// ============================================================
const DOC_TYPE_LABELS = {
  'inventory': 'Inventory List',
  'insurance': 'Insurance / COI',
  'resume':    'Resume / CV',
  'contract':  'Contract',
  'other':     'Document',
};

function handleCrewDocDrop(e){
  e.preventDefault();
  document.getElementById('cc-doc-drop').classList.remove('active');
  const file = e.dataTransfer.files[0];
  if(file) attachCrewDoc(file);
}

function handleCrewDocFile(file){
  if(file) attachCrewDoc(file);
}

function attachCrewDoc(file){
  if(!_contactCardId) return;
  const reader = new FileReader();
  reader.onload = ev => {
    const m = crewStore[_contactCardId];
    if(!m) return;
    if(!m.docs) m.docs = [];
    // Auto-label by filename keywords
    const fn = file.name.toLowerCase();
    const type = fn.includes('inventory')||fn.includes('kit')?'inventory':
                 fn.includes('insurance')||fn.includes('coi')?'insurance':
                 fn.includes('resume')||fn.includes('cv')?'resume':
                 fn.includes('contract')?'contract':'other';
    const doc = {
      id:    'doc-'+Date.now(),
      label: DOC_TYPE_LABELS[type],
      filename: file.name,
      date:  new Date().toLocaleDateString('en-US',{month:'short',day:'numeric'}),
      dataURL: ev.target.result,
      type,
    };
    m.docs.push(doc);
    crewDBSave(m);
    logDecision('Crew', `Document attached to ${m.name||m.role}: ${file.name}`);
    renderCrewDocsList(_contactCardId);
  };
  reader.readAsDataURL(file);
}

function renderCrewDocsList(crewId){
  const container = document.getElementById('cc-docs-list');
  if(!container) return;
  const m = crewStore[crewId];
  const docs = m?.docs || [];
  if(!docs.length){
    container.innerHTML = '<div style="font-size:10px;color:var(--text3);font-style:italic">No documents attached</div>';
    return;
  }
  container.innerHTML = docs.map(doc => `
    <div class="cc-doc-card" title="${doc.filename}">
      <div class="cc-doc-icon">${doc.type==='inventory'?'üìã':doc.type==='insurance'?'üõ°':doc.type==='resume'?'üìÑ':doc.type==='contract'?'‚úç':'üìé'}</div>
      <div class="cc-doc-info">
        <div class="cc-doc-label">${doc.label}</div>
        <div class="cc-doc-filename">${doc.filename}</div>
        <div class="cc-doc-date">${doc.date}</div>
      </div>
      <div class="cc-doc-actions">
        <button onclick="downloadCrewDoc('${crewId}','${doc.id}')" title="Download">‚Üì</button>
        <button onclick="deleteCrewDoc('${crewId}','${doc.id}')" title="Remove" style="color:var(--red)">‚úï</button>
      </div>
    </div>`).join('');
}

function downloadCrewDoc(crewId, docId){
  const m = crewStore[crewId];
  const doc = m?.docs?.find(d=>d.id===docId);
  if(!doc?.dataURL) return;
  const a = document.createElement('a');
  a.href = doc.dataURL;
  a.download = doc.filename;
  a.click();
}

function deleteCrewDoc(crewId, docId){
  const m = crewStore[crewId];
  if(!m?.docs) return;
  const doc = m.docs.find(d=>d.id===docId);
  m.docs = m.docs.filter(d=>d.id!==docId);
  crewDBSave(m);
  logDecision('Crew', `Document removed from ${m.name||m.role}: ${doc?.filename||'file'}`);
  renderCrewDocsList(crewId);
}


function downloadApp(){
  // Grab the current page source and trigger download
  const blob = new Blob([document.documentElement.outerHTML], {type:'text/html'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'dp-helm-hq-v21.html';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  logDecision('System', 'App downloaded as dp-helm-hq-v21.html');
}

// AI COMMAND
async function sendCommand(){
  const input=document.getElementById('cmd-input'),btn=document.getElementById('cmd-btn'),preview=document.getElementById('cmd-preview');
  const text=input.value.trim();if(!text)return;
  btn.disabled=true;btn.textContent='...';
  preview.innerHTML='<div class="thinking">‚¨° Analyzing changes...</div>';
  input.value='';
  try{
    const r=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json','x-api-key':API_KEY_LIVE,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:1000,system:PROJECT_CONTEXT,messages:[{role:'user',content:text}]})});
    const d=await r.json();
    if(d.error){preview.innerHTML=`<div class="preview-empty" style="color:var(--amber)">API error: ${d.error.message}. Add billing at console.anthropic.com.</div>`;btn.disabled=false;btn.textContent='Send ‚Üí';return;}
    const raw=d.content[0].text;
    let changes;
    try{changes=JSON.parse(raw.replace(/```json|```/g,'').trim())}
    catch(e){preview.innerHTML='<div class="preview-empty" style="color:var(--amber)">Could not parse response ‚Äî try rephrasing.</div>';btn.disabled=false;btn.textContent='Send ‚Üí';return;}
    pendingChanges=changes.map((c,i)=>({...c,id:Date.now()+i,status:'pending'}));
    renderPreview();
  }catch(e){preview.innerHTML='<div class="preview-empty" style="color:var(--red)">Connection error.</div>';console.error(e);}
  btn.disabled=false;btn.textContent='Send ‚Üí';
}

function renderPreview(){
  const preview=document.getElementById('cmd-preview');
  if(!pendingChanges.length){preview.innerHTML='<div class="preview-empty">No pending changes.</div>';return;}
  preview.innerHTML=pendingChanges.map(c=>`<div class="change-item ${c.status!=='pending'?c.status:''}" id="ci-${c.id}"><span class="change-type ${c.type}">${c.type}</span><div class="change-desc"><strong style="color:var(--text2);font-size:10px;letter-spacing:1px;text-transform:uppercase">${c.section}</strong><br>${c.description}${c.detail?`<br><span style="color:var(--text3);font-size:10px">${c.detail}</span>`:''}</div><div class="change-actions">${c.status==='pending'?`<button class="change-btn approve" onclick="approveChange(${c.id})">‚úì</button><button class="change-btn edit" onclick="editChange(${c.id})">Edit</button><button class="change-btn cancel" onclick="cancelChange(${c.id})">‚úï</button>`:`<span style="font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:1px">${c.status}</span>`}</div></div>`).join('');
}

function approveChange(id){const c=pendingChanges.find(x=>x.id===id);if(c){c.status='approved';renderPreview();}}
function cancelChange(id){const c=pendingChanges.find(x=>x.id===id);if(c){c.status='cancelled';renderPreview();}}
function editChange(id){const c=pendingChanges.find(x=>x.id===id);if(!c)return;const n=prompt('Edit:',c.description);if(n&&n.trim()){c.description=n.trim();renderPreview();}}

function commitAll(){
  const approved=pendingChanges.filter(c=>c.status==='approved');
  if(!approved.length){alert('Approve at least one change first.');return;}
  approved.forEach(c=>{
    logDecision(c.section, c.description+(c.detail?'\n'+c.detail:''));
    // Execute crew adds/updates
    if((c.type==='add'||c.type==='update') && c.crewData){
      addCrewMemberData(c.crewData);
    }
    // Execute schedule item adds
    if(c.scheduleData){
      const sd=c.scheduleData;
      addScheduleItem(sd.date, sd.text, sd.urgent||false);
    }
    // Execute pull sheet adds
    if(c.pullData){
      const pd=c.pullData;
      const pid='pull-'+Date.now();
      const pitem={id:pid, dept:pd.dept||'camera', item:pd.item||'New item', qty:pd.qty||'1', source:pd.source||'TBD', priority:pd.priority||'high', notes:pd.notes||'', video:'Both'};
      pullStore[pid]=pitem; pullDBSave(pitem); renderAllPull();
    }
  });
  pendingChanges=pendingChanges.filter(c=>c.status==='pending');
  const preview=document.getElementById('cmd-preview');
  const toast=document.createElement('div');toast.className='impact-box';toast.style.marginBottom='6px';
  toast.innerHTML=`<strong>‚úì ${approved.length} change${approved.length>1?'s':''} committed + logged.</strong>`;
  preview.prepend(toast);renderPreview();setTimeout(()=>toast.remove(),3500);
}

function clearPreview(){pendingChanges=[];document.getElementById('cmd-preview').innerHTML='<div class="preview-empty">Proposed changes appear here ‚Äî approve ‚úì, edit, or cancel ‚úï each one individually before committing.</div>';}

function toggleInstructions(el){el.closest('.page-instructions').classList.toggle('open');}

// Init order matters: flags first so checklist can reference them
initFlags().then(()=>{
  initChecklist();
  initCrew();
  initVendors();
  initPullSheet();
  renderGearQuotes();
  initSchedule();
  initApiKeys();
  loadLogEntries();
});
loadPersistedScout();
</script>
</body>
</html>
